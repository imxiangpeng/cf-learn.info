<!DOCTYPE html>
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Chapter 6: CFEngine Tips, Tricks, and Patterns &middot; Diego Zamboni</title>

  
  <link rel="stylesheet" href='/css/poole.css'>
  <link rel="stylesheet" href='/css/hyde.css'>
  <link rel="stylesheet" href='/css/poole-overrides.css'>
  <link rel="stylesheet" href='/css/hyde-overrides.css'>
  <link rel="stylesheet" href='/css/hyde-x.css'>
  <link rel="stylesheet" type="text/css" href='/css/socialicious.css' media="screen" />
  
  <link href='https://fonts.googleapis.com/css?family=Quattrocento|Quattrocento+Sans' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href='/css/tachyons.min.css'/>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Learning CFEngine 3 &middot; Diego Zamboni" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body class="lh-copy">
<div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
      <h1>Learning CFEngine 3</h1>
      
    </div>

    <ul class="sidebar-nav">
      
        <li class="sidebar-nav-item"><a  href="/home/">Home</a></li>
      
        <li class="sidebar-nav-item"><a  href="/the-author/">The Author</a></li>
      
        <li class="sidebar-nav-item"><a  href="/post/">The Blog</a></li>
      
        <li class="sidebar-nav-item"><a  href="/book/">The Book</a></li>
      
        <li class="sidebar-nav-item"><a  href="/the-code/">The Code</a></li>
      
        <li class="sidebar-nav-item"><a  href="/the-raves/">The Raves</a></li>
      
        <li class="sidebar-nav-item"><a  href="/contact/">Contact</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      
      
      <a href="http://twitter.com/LearningCF3"><li class="icon-twitter"></li></a>&nbsp;
      
      
    </ul>

    <div class="sidebar-sticky"><p>&copy; 2018 Diego Zamboni<br/>
        Powered by <a href="https://gohugo.io">Hugo</a></p></div>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>Chapter 6: CFEngine Tips, Tricks, and Patterns</h1>
    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#ch-tips-tricks-patterns">CFEngine Tips, Tricks, and Patterns</a>
<ul class="sectlevel2">
<li><a href="#hierarchical-copying">Hierarchical Copying</a></li>
<li><a href="#passing-name-value-pairs-to-bundles">Passing Name-Value Pairs to Bundles</a></li>
<li><a href="#I_sect15_d1e19394">Setting Default Values for Bundle Parameters</a></li>
<li><a href="#using-a-class-to-prevent-certain-behavior">Using Classes as Configuration Mechanisms</a></li>
<li><a href="#generic-tasks-using-array-indices">Generic Tasks Using Lists and Array Indices</a></li>
<li><a href="#sec-defining-classes-for-groups-of-hosts">Defining Classes for Groups of Hosts</a></li>
<li><a href="#controlling-promise-execution-order">Controlling Promise Execution Order</a></li>
<li><a href="#sec-dynamic-loading-and-execution">Dynamic Loading and Execution</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="ch-tips-tricks-patterns">CFEngine Tips, Tricks, and Patterns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In previous chapters we have seen a number of CFEngine policies to achieve different specific tasks, with the intention of introducing you to a number of basic CFEngine concepts. Now that you know those basic concepts, I would like to introduce you to several generic techniques and patterns that are generally useful when writing CFEngine policies. Mastering these techniques will help you write more concise and efficient CFEngine code.</p>
</div>
<div class="sect2">
<h3 id="hierarchical-copying">Hierarchical Copying</h3>
<div class="paragraph">
<p>One of the common uses of CFEngine is to copy files (configuration files, binaries, libraries, documentation, etc.) into systems. If you maintain a heterogeneous network consisting of different system types, operating systems, architectures, and applications, you will at some point need to copy different sets of files onto different systems. The most straightforward way of achieving this would be to have different promises in your <a href="http://cf-learn.info/ref/files">files:</a> section for different hard classes that reflect the different system categories you want to differentiate. For example, you may want to copy different <em>/etc/hosts</em> files depending on the operating system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">files</span><span class="tok-p">:</span>
  <span class="tok-nc">ubuntu_10</span><span class="tok-p">::</span>
    <span class="tok-s">&quot;/etc/hosts&quot;</span>
      <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">mycopy</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc.hosts.ubuntu_10&quot;</span><span class="tok-p">);</span>
  <span class="tok-nc">suse_9</span><span class="tok-p">::</span>
    <span class="tok-s">&quot;/etc/hosts&quot;</span>
      <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">mycopy</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc.hosts.suse_9&quot;</span><span class="tok-p">);</span>
  <span class="tok-nc">redhat_5</span><span class="tok-p">::</span>
    <span class="tok-s">&quot;/etc/hosts&quot;</span>
      <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">mycopy</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc.hosts.redhat_5&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example can be easily simplified if you know that the built-in CFEngine variable $(sys.flavor) contains the type and version of the operating system, so we could rewrite this example as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-s">&quot;/etc/hosts&quot;</span>
    <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">mycopy</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc.</span><span class="tok-si">$(sys.flavor)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could use any variable, whether defined by you or pre-defined by CFEngine, for a rule like this. All the built-in variables are documented in the <a href="https://cfengine.com/manuals/cf3-reference#Special-Variables">CFEngine Reference Guide</a>.</p>
</div>
<div class="paragraph">
<p>However, this method suffers from several drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You need to have a separate file for every possible value of the variable you are using ($(sys.flavor) in this case). For example, if you have hosts that are running SuSE 10, SuSE 11 and Ubuntu 10, you will need to have the files <em>hosts.suse_10</em>, <em>hosts.suse_11</em> and <em>hosts.ubuntu_10</em> in the repository, even if they are all the same. There is no easy way to implement a “catch all” clause for copying a generic file.</p>
</li>
<li>
<p>You are restricted to using a single variable to differentiate among systems. If you want some files to be different according to architecture, or domain name, or any other information, you need to write separate promises.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What we would like to do is to implement the copy operation according to arbitrary criteria, as contained in CFEngine classes and variables. For example, consider the network shown in <a href="#fig-sample-network">Sample network with multiple domains and operating systems</a>. We would like to copy different versions of the <em>/etc/hosts</em> file to different hosts, according to criteria such as their hostname, their domain name, their type of operating system (Windows, Linux, etc.) and their specific OS “flavor” (e.g. SuSE 9, RedHat 5, etc.). It’s worth noting that all of these attributes are discovered automatically by CFEngine and stored both in variables and in hard classes. For example, in a SuSE 9 system the classes linux, suse, and suse_9 will be defined, and the variables $(sys.class) and $(sys.flavor) will contain "linux" and "suse_9", respectively.</p>
</div>
<div class="paragraph">
<p>For the sake of this example, let’s assume that <em>$(repository)/etc/</em> contains the following files (listed in alphabetical order):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hosts
hosts.justiceleague.com
hosts.lex
hosts.ssosv.com
hosts.suse_9
hosts.windows
hosts.wonderwoman.justiceleague.com</pre>
</div>
</div>
<div id="fig-sample-network" class="imageblock">
<div class="content">
<img src="../figs/web/lcfe_0501.png" alt="lcfe 0501">
</div>
<div class="title">Figure 1. Sample network with multiple domains and operating systems</div>
</div>
<div class="paragraph">
<p>Using this information, we can hardcode these rules in promises like these:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">agent</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
      <span class="tok-c"># Single copy for all files</span>
        <span class="tok-kr">files_single_copy</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.*&quot;</span> <span class="tok-p">};</span> <b class="conum">(1)</b>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span> <b class="conum">(2)</b>
    <span class="tok-nc">wonderwoman_justiceleague_com</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span>
          <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts.wonderwoman.justiceleague.com&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">lex</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts.lex&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">justiceleague_com</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts.justiceleague.com&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">ssosv_com</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts.ssosv.com&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">suse_9</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts.suse_9&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">windows</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts.windows&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">any</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming the $(repository) variable has been set elsewhere, this works as follows:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First, we have to enable “single copy” on all the files we want to
process. This is a configuration parameter that tells CFEngine to copy
each file at most once, ignoring successive copy operations for the
same destination file. The files_single_copy parameter in the
<a href="http://cf-learn.info/ref/agent"><code>agent</code></a> control body specifies a list
of regular expressions to match filenames to which single-copy should
apply. By setting it to <code>".*"</code> we match all filenames. You could
customize this to apply it only to certain files, although in my
opinion this would tend to complicate understanding of the promises by
having different copy behavior for different files.</p>
</li>
<li>
<p>In the
<a href="http://cf-learn.info/ref/files"><code>files:</code></a> promise section, we list
multiple file-copy promises conditioned by each one of the classes
with which we want to differentiate the hosts. Again, remember that
all of these classes (wonderwoman_justiceleague_com, lex,
justiceleague_com, suse_9, etc.) are hard classes that will be
automatically set by CFEngine on systems with the corresponding
characteristics. We have listed the classes from most specific to more
general (with the any class expression at the end, which will catch
anything that is not matched by the previous sections). CFEngine will
process these promises in the order they appear. The first one to
match (this is, for which the corresponding class is defined in the
current host) will execute, resulting in the copy operation from the
appropriate file in the repository. More general classes may match,
but because of the files_single_copy parameter, they will be ignored
after the file is copied for the first time.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This works, but suffers from many of the same problems we saw before: it is verbose and the class names and filenames are hard-coded in the policy.</p>
</div>
<div class="paragraph">
<p>A more flexible way to achieve this task is known in CFEngine terminology as “hierarchical copy.” In this pattern, you specify an arbitrary list of variables by which you want files to be differentiated, and the order in which they should be considered, from most specific to most general. When the copy promise is executed, the most specific file found will be copied.</p>
</div>
<div class="paragraph">
<p>This pattern is very simple to implement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">agent</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">files_single_copy</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.*&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">suffixes</span><span class="tok-p">&quot;</span>   <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.fqhost)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.uqhost)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                              <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.domain)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.flavor)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                              <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.ostype)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/etc/hosts&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repository)</span><span class="tok-s">/etc/hosts</span><span class="tok-si">$(suffixes)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we are defining a list variable called @(suffixes) that contains the criteria by which we want to differentiate the files. All the variables contained in the list are automatically defined by CFEngine, and correspond to the classes we used in the previous example. Then we simply include that variable, as a scalar, in our <a href="http://cf-learn.info/ref/copy_from">copy_from</a> parameter. Because CFEngine does automatic list expansion, it will try each variable in turn, executing the copy promise multiple times (one for each value in the list) and copy the first file that exists. For example, in our Linux SuSE 11 machine called superman.justiceleague.com, the @(suffixes) variable will contain the following values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-p">{</span> <span class="tok-s">&quot;.superman.justiceleague.com&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.superman&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.justiceleague.com&quot;</span><span class="tok-p">,</span>
  <span class="tok-s">&quot;.suse_11&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.linux&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the file-copy promise is executed, implicit looping will cause these strings to be appended in sequence to "$(repository)/etc/hosts", so the following filenames will be attempted in sequence: <em>hosts.superman.justiceleague.com</em>, <em>hosts.justiceleague.com</em>, <em>hosts.suse_11</em>, <em>hosts.linux</em> and <em>hosts</em>. The first one to exist (in this case, <em>hosts.justiceleague.com</em>) will be copied over <em>/etc/hosts</em> in the client, and the rest will be skipped. Of course, for this to work, we also need to set the <a href="http://cf-learn.info/ref/files_single_copy">files_single_copy</a> parameter as described before.</p>
</div>
<div class="paragraph">
<p>Now, for our host darkseid.ssosv.com, which is a Windows machine, the list will contain the following values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-p">{</span> <span class="tok-s">&quot;.darkseid.ssosv.com&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.darkseid&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.ssosv.com&quot;</span><span class="tok-p">,</span>
  <span class="tok-s">&quot;.windows_7&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.windows&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All the values will be attempted until <em>hosts.windows</em> is found and copied over.</p>
</div>
<div class="paragraph">
<p>Wonder Woman needs a specific hosts file for her machine (perhaps so that she can reach certain hosts in Paradise Island), and so she gets <em>hosts.wonderwoman.justiceleague.com</em>, the first try on the list. Similarly, the lists for Lex Luthor’s machines look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-nf">For</span> <span class="tok-nf">lex</span><span class="tok-err">.</span><span class="tok-nf">ssosv</span><span class="tok-err">.</span><span class="tok-kd">com</span><span class="tok-p">:</span>
   <span class="tok-p">{</span> <span class="tok-s">&quot;.lex.ssosv.com&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.lex&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.ssosv.com&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.suse_9&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.linux&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">}</span>
<span class="tok-nf">For</span> <span class="tok-nf">lex</span><span class="tok-err">.</span><span class="tok-nf">lexcorp</span><span class="tok-err">.</span><span class="tok-kd">com</span><span class="tok-p">:</span>
   <span class="tok-p">{</span> <span class="tok-s">&quot;.lex.lexcorp.com&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.lex&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.lexcorp.com&quot;</span><span class="tok-p">,</span>
     <span class="tok-s">&quot;.windows_7&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.windows&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore, both machines get the same file (<em>hosts.lex</em>) because that is the first one that exists when going through the lists.</p>
</div>
<div class="paragraph">
<p>For hosts that don’t match any of the existing files, the last item on the list (an empty string) will cause the generic <em>hosts</em> file to be copied. Note that the dot for each of the filenames is included in $(suffixes), except for the last element.</p>
</div>
<div class="paragraph">
<p>As you can see, this allows us to have different files copied according to arbitrary criteria. Using this technique, you can drastically reduce the number of file-copying promises in your policy, while still having a lot of flexibility in which files are copied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This technique, by its very nature, frequently tries to copy non-existent files (until it finds one that exists, and stops there). This results in messages from cf-agent about the files it cannot find. You may see messages like these as the different possibilities are attempted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Can't stat /var/cfengine/masterfiles/files/etc/hosts.darkseid.ssosv.com
  in files.copyfrom promise
Can't stat /var/cfengine/masterfiles/files/etc/hosts.darkseid
  in files.copyfrom promise
Can't stat /var/cfengine/masterfiles/files/etc/hosts.ssosv.com
  in files.copyfrom promise
Can't stat /var/cfengine/masterfiles/files/etc/hosts.windows_7
  in files.copyfrom promise
 -&gt; Copying from 10.6.5.4:/var/cfengine/masterfiles/files/etc/hosts.windows</pre>
</div>
</div>
<div class="paragraph">
<p>This can result in noisy logs, but these messages can, of course, be safely ignored.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let’s put this pattern in a more complex example. We will put the files and directories to copy in lists, so that we can apply implicit looping on them as well, and add a few more bells and whistles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">agent</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">files_single_copy</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.*&quot;</span> <span class="tok-p">};</span> <b class="conum">(1)</b>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">copyfiles</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># Suffixes to try, in most-specific to most-general order. This must</span>
      <span class="tok-c"># include the empty suffix at the end, for the most general file.</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">suffixes</span><span class="tok-p">&quot;</span>
        <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.fqhost)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.uqhost)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.domain)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <b class="conum">(2)</b>
                   <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.flavor)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.</span><span class="tok-si">$(sys.ostype)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">};</span>
      <span class="tok-c"># List of files to copy</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">filestocopy</span><span class="tok-p">&quot;</span>     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/etc/hosts&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/etc/motd&quot;</span> <span class="tok-p">};</span>   <b class="conum">(3)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">dirstocopy</span><span class="tok-p">&quot;</span>      <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(sys.workdir)</span><span class="tok-s">/bin&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/usr/local/bin&quot;</span> <span class="tok-p">};</span>
      <span class="tok-c"># Source of the files</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">repo</span><span class="tok-p">&quot;</span>            <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/mnt/fileserver/cfengine/files&quot;</span><span class="tok-p">;</span>   <b class="conum">(4)</b>
      <span class="tok-c"># Destination for the files</span>
      <span class="tok-c"># Set this to an empty string for a production environment</span>
      <span class="tok-c"># &quot;dest&quot; string =&gt; &quot;&quot;;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">dest</span><span class="tok-p">&quot;</span>            <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/tmp/testdest&quot;</span><span class="tok-p">;</span>   <b class="conum">(5)</b>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(dest)$(filestocopy)</span><span class="tok-s">&quot;</span>   <b class="conum">(6)</b>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_dcp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repo)$(filestocopy)$(suffixes)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

      <span class="tok-s">&quot;</span><span class="tok-si">$(dest)$(dirstocopy)</span><span class="tok-s">&quot;</span>    <b class="conum">(7)</b>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_dcp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(repo)$(dirstocopy)$(suffixes)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">depth_search</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">recurse</span><span class="tok-p">(</span><span class="tok-s">&quot;inf&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how it works:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>As before, we set the files_single_copy parameter to ensure each file
is copied at most once.</p>
</li>
<li>
<p>We store in @(suffixes) the list of file suffixes to try. Just as
before, we will be selecting the most-specific file according to
fully-qualified host name ($(sys.fqhost)), plain host name
($(sys.uqhost)), domain name ($(sys.domain)), operating system name
and version ($(sys.flavor)) and top-level operating system type
($(sys.ostype)). Finally, the empty element will select the generic
file (without any suffix) to be copied.</p>
</li>
<li>
<p>We store in @(filestocopy) the list of individual files to copy from
the repository, and in @(dirstocopy) the list of directories to copy.
From the point of view of CFEngine syntax, files and directories could
be in the same list, but there is an important semantic difference:
When a full directory is copied, the suffix is expected to appear in
the directory name (for example, <em>/usr/local/bin.suse_9</em> or
<em>/usr/local/bin.windows</em>), and the selected directory will be copied
in its entirety, without any further filtering on the files it
contains. This is useful for directories among which there exist no
common files (as may be the case for directories containing executable
files).</p>
</li>
<li>
<p>We store in $(repo) the top-level source location for the files. In
this example, all files are being copied locally. Depending on your
implementation details, you may need to define a source host as well,
and modify the copy_from attributes to use CFEngine’s remote-file-copy
capabilities.</p>
</li>
<li>
<p>We store in $(dest) the top-level destination for the files. In this
case, for testing purposes, all the files wil be copied under
<em>/tmp/testdest</em>. In production, most likely this variable would be
empty, so that files are copied to their real locations.</p>
</li>
<li>
<p>We finally get to the file-copy promises. The first one takes care of
copying individual files. We are using the standard library’s
local_dcp() definition, which does a local copy using a cryptographic
hash as the comparison, and receives the source file name as its only
argument:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-p">{</span>
        <span class="tok-kr">source</span>      <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(from)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">compare</span>     <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;digest&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this promise, the destination file is specified as
<code>"$(dest)$(filestocopy)"</code>, which means that implicit looping will
happen over the contents of the @(filestocopy) list, and each one will
be prepended with the destination directory. For example, when
$(filestocopy) has the value <code>"/etc/hosts"</code>, the destination file will
be <code>"/tmp/testdest/etc/hosts"</code>. When the policy goes in production and
we modify $(dest) to be an empty string, the destination file will be
simply <code>"/etc/hosts"</code>.</p>
</div>
<div class="paragraph">
<p>The source file (the argument to local_dcp()) is a bit more
complicated. In this case we are doing implicit looping over two
lists: @(filestocopy) and @(suffixes), and the file-copy promise will
be evaluated repeatedly for each combination. For example, if
@(suffixes) contains the following values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-p">{</span> <span class="tok-s">&quot;.lex.lexcorp.com&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.lex&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.lexcorp.com&quot;</span><span class="tok-p">,</span>
  <span class="tok-s">&quot;.windows_7&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;.windows&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then when $(filestocopy) has the value <code>"/etc/hosts"</code>, the argument to
local_dcp() will take the following values in sequence:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>"/mnt/fileserver/cfengine/files/etc/hosts.lex.lexcorp.com"</code></p>
</li>
<li>
<p><code>"/mnt/fileserver/cfengine/files/etc/hosts.lex"</code></p>
</li>
<li>
<p><code>"/mnt/fileserver/cfengine/files/etc/hosts.lexcorp.com"</code></p>
</li>
<li>
<p><code>"/mnt/fileserver/cfengine/files/etc/hosts.windows_7"</code></p>
</li>
<li>
<p><code>"/mnt/fileserver/cfengine/files/etc/hosts.windows"</code></p>
</li>
<li>
<p><code>"/mnt/fileserver/cfengine/files/etc/hosts"</code></p>
<div class="paragraph">
<p>Only the first file found will be copied to <em>/etc/hosts</em>, and the
rest will be skipped.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The promise to copy whole directories works the same way, with the difference that it loops over the contents of @(dirstocopy), and the file-copy promise is given the additional attribute depth_search, with an argument that indicates a recursive copy should be done (recurse() is also defined in the standard library). As I mentioned before, we could even merge these two promises, since depth_search is simply ignored for plain files, but I like having the conceptual distinction between them.</p>
<div class="paragraph">
<p>CFEngine keeps track of already-copied files only at the individual file level and not at the directory level. If one of the less-specific directories contains files that do not exist in a more-specific directory, they will be copied as well, even if the more-specific directory gets copied too. For example, if <em>$(repo)/usr/local/bin/</em> contains a file called <em>latex</em> and this file does not exist in <em>$(repo)/usr/local/bin.lex.lexcorp.com/</em>, it will be copied to the destination <em>/usr/local/bin/</em>, because that specific file is not flagged as “already copied” by CFEngine. This can lead to unexpected consequences, although it can also be used to reduce repetition among directories. For example, you could put all the binaries in <em>$(repo)/usr/local/bin.lex.lexcorp.com/</em>, and leave all the platform-independent shell scripts in <em>$(repo)/usr/local/bin/</em>. The resulting <em>/usr/local/bin/</em> in the clients will contain the merger of both directories.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Hierarchical copy is a powerful technique that can greatly simplify the structure of your CFEngine policies. File manipulation is one of the most powerful and complex topics in CFEngine. I strongly advise you to carefully read the relevant sections of the Reference Guide, to get an idea of the multiple capabilities that CFEngine offers in this respect.</p>
</div>
</div>
<div class="sect2">
<h3 id="passing-name-value-pairs-to-bundles">Passing Name-Value Pairs to Bundles</h3>
<div class="paragraph">
<p>Many system configuration tasks require groups of name-value pairs to be associated with a single entity. Some of these tasks include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Editing configuration files in which parameters and their values need to be stored. The pairs may be further associated with a single portion of the file identified by a name (for example, Windows-style INI files contain parameters grouped in named sections).</p>
</li>
<li>
<p>Setting user parameters. In this case, sets of pairs are associated with a single user, identified by name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a technique that you have seen used many times in this book. The name-value pairs are stored in a CFEngine array, with the parameter names used as indices, and with the values stored in each element of the array. For example, for configuring <em>/etc/ssh/sshd_config</em> and <em>/etc/sysctl.conf</em> in <a href="#system-configuration">[system-configuration]</a>, we defined two arrays (named sshd and sysctl) in the configfiles() bundle. We also used an array to store the filenames of the files we were going to edit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># Files to edit</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sysctl]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/sysctl.conf&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sshd]</span><span class="tok-p">&quot;</span>   <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span><span class="tok-p">;</span>

      <span class="tok-c"># Sysctl variables to set</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.tcp_syncookies]</span><span class="tok-p">&quot;</span>               <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_source_route]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_redirects]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.rp_filter]</span><span class="tok-p">&quot;</span>           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.log_martians]</span><span class="tok-p">&quot;</span>        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>

      <span class="tok-c"># SSHD configuration to set</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[Protocol]</span><span class="tok-p">&quot;</span>                                <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[X11Forwarding]</span><span class="tok-p">&quot;</span>                           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;yes&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[UseDNS]</span><span class="tok-p">&quot;</span>                                  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;no&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;sysctl&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sysctl</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;sshd&quot;</span>    <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sshd</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having sets of related values in a single array has a number of advantages, since they can be manipulated by a single set of promises just by varying the indices used to access them. To make use of this array, you have to pass it as an argument to a bundle. One of the most useful functions in this technique is <a href="http://cf-learn.info/ref/getindices">getindices()</a>, which returns a list containing the indices of the given array, and can be used to produce an enumeration of the elements over which to iterate (the complementary function to get just the values is <a href="http://cf-learn.info/ref/getvalues">getvalues()</a>). For example, remember from the edit_sshd() bundle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(configfiles.files[sshd])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;edit_sshd&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Set desired sshd_config parameters&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_config_values</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.sshd&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;restart_sshd&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To pass arrays as arguments we must pass a string with the name of the array, and then dereference it inside the function (in this case, the dereferencing is happening in the set_config_values() bundle). The argument we are passing to set_config_values() is "configfiles.sshd", which refers to the sshd array defined in the configfiles() bundle.</p>
</div>
<div class="paragraph">
<p>To group name/value sets into named groups, we can use two-dimensional arrays, as we saw in the create_users() bundle in <a href="#user-management">[user-management]</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">manage_users</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][fullname]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;System administrator&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][uid]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][gid]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][home]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/root&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][shell]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/bin/bash&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][flags]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;-o -m&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[root][password]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;FkDMzhB1WnOp2&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][fullname]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Diego Zamboni&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][uid]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;501&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][gid]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;users&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][home]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/home/zamboni&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][shell]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/bin/bash&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][flags]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;-m&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][password]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;dk52ia209rfuh&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;users&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">create_users</span><span class="tok-p">(</span><span class="tok-s">&quot;manage_users.users&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the dereferencing can get a little complicated. For example, let us look at some of the code inside the create_users() bundle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">create_users</span><span class="tok-p">(</span><span class="tok-nv">info</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">user</span><span class="tok-p">&quot;</span>        <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(info)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;add_</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span> <span class="tok-kr">not</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">userexists</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">linux</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/usr/sbin/useradd </span><span class="tok-si">$($(info)[$(user)][flags])</span><span class="tok-s"> -u </span><span class="tok-si">$($(info)[$(user)][uid])</span><span class="tok-s"></span>
<span class="tok-s">       -g </span><span class="tok-si">$($(info)[$(user)][gid])</span><span class="tok-s"> -d </span><span class="tok-si">$($(info)[$(user)][home])</span><span class="tok-s"></span>
<span class="tok-s">       -s </span><span class="tok-si">$($(info)[$(user)][shell])</span><span class="tok-s"> -c &#39;</span><span class="tok-si">$($(info)[$(user)][fullname])</span><span class="tok-s">&#39; </span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;add_</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-err">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle is being called from the <a href="http://cf-learn.info/ref/methods">methods:</a> section of the manage_users() bundle, with the string "manage_users.users" as the value of $(info). We use <a href="http://cf-learn.info/ref/getindices">getindices()</a> directly on this value to get a list of the first-level indices of the array (the user names), which we store in @(user). Then we use implicit looping over @(user) to cycle through all those values, and we use the following construction to access individual elements of each user’s data: $($(info)[$(user)][__field__]). This expands to $(manage_users.users[$(user)][__field__]), on which implicit looping is applied through the $(user) variable. Remember that parenthesis (or curly braces, they mean the same) are required around the whole expression, so that CFEngine recognizes it properly as a variable reference.</p>
</div>
<div class="paragraph">
<p>While the syntax can be complicated, this data structure allows great flexibility in passing around and using data structures to be used in configuration operations.</p>
</div>
<div class="paragraph">
<p>You can see this pattern used in many places, not only in the examples we have described in this book, but also in the standard library, for example in the set_config_values(), set_variable_values(), and append_users_starting() bundles.</p>
</div>
</div>
<div class="sect2">
<h3 id="I_sect15_d1e19394">Setting Default Values for Bundle Parameters</h3>
<div class="paragraph">
<p>One potential issue, particularly with complex bundles that may have many different options, is the need to provide default parameter values. These may be overriden by the user, but let you avoid having to specify all those values in every single call. Happily, this is also possible with CFEngine when you pass parameters in an array, as described in the previous section.</p>
</div>
<div class="paragraph">
<p>The trick is to set the default values in an array internal to the bundle, and then copy the parameters passed in as arguments on top of that array. When no value is passed for a particular parameter, its old value (the default) will be retained. We saw an example of this technique in the wp_vars() bundle in <a href="#manual-software-management">[manual-software-management]</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_vars</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>   <b class="conum">(1)</b>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">wp_dir</span><span class="tok-p">&quot;</span>             <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_wp_dir])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-c"># Default configuration values. Internal parameters start with _</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_tarfile]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/root/wordpress-latest.tar.gz&quot;</span><span class="tok-p">,</span>   <b class="conum">(2)</b>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>   <b class="conum">(3)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_downloadurl]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;http://wordpress.org/latest.tar.gz&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_wp_config]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(wp_dir)</span><span class="tok-s">/wp-config.php&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_wp_cfgsample]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(wp_dir)</span><span class="tok-s">/wp-config-sample.php&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">debian</span><span class="tok-p">::</span>   <b class="conum">(4)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_sys_servicecmd]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/sbin/service&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_sys_apachesrv]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;apache2&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">redhat</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_sys_servicecmd]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/sbin/service&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[_sys_apachesrv]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;httpd&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">any</span><span class="tok-p">::</span>   <b class="conum">(5)</b>
      <span class="tok-c"># Copy configuration parameters passed, into a local array</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">param_keys</span><span class="tok-p">&quot;</span>          <span class="tok-kt">slist</span>  <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(params)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>   <b class="conum">(6)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">conf[$(param_keys)]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[$(param_keys)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;overridable&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The bundle receives the name of an array as its $(params) argument.</p>
</li>
<li>
<p>Default values for all parameters are stored in an internal array called conf. Here we are storing the default values for parameters _tarfile, _downloadurl, _wp_config and _wp_cfgsample.  <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</li>
<li>
<p>Note that all the array elements are assigned with their policy
attribute set to <code>"overridable"</code>, which means that they can be
assigned a new value later on. By default, all variables in CFEngine
are immutable, and you will get an error if you try to reassign a
value to them. This policy setting changes this behavior, allowing
them to be freely redefined.</p>
</li>
<li>
<p>We set some of the parameters in sections conditioned to certain
classes. In this case, we have certain parameters that have different
values on Debian-based systems and on RedHat-based systems. Note that
these are also stored with policy set to <code>"overridable"</code>, so that they
can be redefined by the user.</p>
</li>
<li>
<p>We condition the final section to the any class, so that the following
statements are again executed for all systems. Note that this <code>any::</code>
block must come last, since promises within a single section (<code>vars:</code>
in this case) are executed in the order they appear in the file.</p>
</li>
<li>
<p>And finally, we come to copying the user-provided parameters on top of
the conf array. For this, we first store all the indices from
$(params) into a list, and then, using implicit looping, copy all
those elements from the $(params) array onto conf. Again, we set
policy to <code>"overridable"</code> so that the copy can be done without any
warnings. Any parameters passed in the $(params) array will overwrite
the previous values in the conf array. After this, the $(params) array
becomes unnecessary, and the rest of the bundle should access any
values it needs from the conf array.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This technique is generally applicable, and adds the convenience of only having to specify those parameters that deviate from the standard, when using a bundle.</p>
</div>
<div class="paragraph">
<p>Implicit looping, combined with arrays, and with the ability to specify default parameter values, provide a powerful mechanism that allows us to pass around data and perform elaborate tasks without any flow-control code at all.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-a-class-to-prevent-certain-behavior">Using Classes as Configuration Mechanisms</h3>
<div class="paragraph">
<p>Classes are the universal decision-taking mechanism in CFEngine, and we have seen already throughout the book many examples of using classes, either automatically discovered or set programatically, to control the behavior of CFEngine policies. I would like to draw your attention now to the use of classes as a manual configuration and control mechanism. Due to their Boolean nature, certain classes can be used throughout the entire policy to enforce certain desired behaviors.</p>
</div>
<div class="paragraph">
<p>We saw a simple example of this in <a href="#editing-sysctl.conf">[editing-sysctl.conf]</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">sysctl_modified.!no_restarts</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/sbin/sysctl -p&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;reload_sysctl&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Make sure new sysctl settings are loaded&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the no_restarts class is being used as a flag to control whether the command to reload the sysctl settings should be executed. Normally this is desirable so that the changes take effect immediately, but under certain circumstances (for example when testing, or when making a large number of changes) we may want to disable this behavior. By defining the no_restarts class, the whole class expression becomes false, and the command will not be executed. By using a construct like this consistently throughout a policy, we can control this behavior with a single class definition.</p>
</div>
<div class="paragraph">
<p>There are several ways in which a class like this can be defined. It could be defined in a <a href="http://cf-learn.info/ref/common">common</a> bundle, so that it becomes a global class, evaluated very early in the processing of the policy and so assured to have the desired effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">g</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;no_restarts&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;!any&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code makes the class undefined (false) by default ("any" is the CFEngine equivalent of an always-true expression, so negating it results in an always-false expression; completely omitting the class definition would have the same effect). To change this, we would need to simply remove the exclamation mark from the class expression. To modify the class during a single run of <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a>, we could specify it in the command line using the -D option. Any classes defined through this mechanism override definitions found in the policy, so without modifying the policy file, we could run it with -Dno_restarts and have it defined for that run only.</p>
</div>
<div class="paragraph">
<p>If we want to avoid having to modify the policy files and also having to specify options in the command line, we could specify the class in a text file that is distributed to each machine, and from where class definitions are read. We would replace our common bundle with something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">g</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">class_file</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/cfengine/site/classes.txt&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">class_strs</span><span class="tok-p">&quot;</span>
        <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">readstringlist</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(class_file)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                                <span class="tok-s">&quot;#.*$&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\s</span><span class="tok-s">+&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;inf&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;inf&quot;</span><span class="tok-p">);</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(class_strs)</span><span class="tok-s">&quot;</span>  <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;any&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we are defining a file from which class definitions will be read, and then reading that file into a list of strings called @(class_strs) using the <a href="http://cf-learn.info/ref/readstringlist">readstringlist()</a> function. Its arguments specify the file to read, the regular expression pattern to use as comments (in this case, a hash sign followed by an arbitrary string until the end of the line), the list element separator (we are using "\s+", so that multiple space-separated elements can be included in the same line), and the maximum number of lines and bytes to read (both set to "inf" to read as many as we can). In the <a href="http://cf-learn.info/ref/classes">classes:</a> section, we are looping over that list, defining classes named after each one of those elements. Thus, if we want to define the no_restarts classes, all we need to do is add to the <em>/var/cfengine/site/classes.txt</em> file a line that contains the string "no_restarts".</p>
</div>
<div class="paragraph">
<p>This mechanism offers great flexibility because the <em>classes.txt</em> file can be set by hand, created at system install time according to its characteristics, or modified by CFEngine itself—for example, using templates or hierarchical copying—to contain different values according to any criteria we want to define.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The abortclasses attribute of body agent control can be used to define classes that should cause CFEngine to stop execution immediately. For example, you could define a class that, if defined, will disable CFEngine in the current host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">agent</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">abortclasses</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;disable_cfengine&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have this attribute defined, the <em>classes.txt</em> file is an ideal place for specifying the disable_cfengine class if it becomes necessary to disable CFEngine for any reason. If you are distributing <em>classes.txt</em> using hierarchical copying as described in <a href="#hierarchical-copying">Hierarchical Copying</a>, you can make this change as specific or broad as you wish.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In fact, we can combine these mechanisms in the same policy. For example, while writing this code I used a policy like this to make testing easier by passing the -Dtestrun flag to control the value of $(class_file):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">g</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
  <span class="tok-nc">testrun</span><span class="tok-p">::</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">class_file</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/tmp/classes.txt&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">!testrun</span><span class="tok-p">::</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">class_file</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/cfengine/site/classes.txt&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">any</span><span class="tok-p">::</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">class_strs</span><span class="tok-p">&quot;</span>
     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">readstringlist</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(class_file)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                             <span class="tok-s">&quot;#.*?</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\s</span><span class="tok-s">+&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;inf&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;inf&quot;</span><span class="tok-p">);</span>
 <span class="tok-kd">classes</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;</span><span class="tok-si">$(class_strs)</span><span class="tok-s">&quot;</span>  <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;any&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generic-tasks-using-array-indices">Generic Tasks Using Lists and Array Indices</h3>
<div class="paragraph">
<p>Implicit looping over lists and array indices can be used as a building block for concise and reusable policies (sometimes at the expense of readibility of the lower-level blocks, which need to do a lot of variable dereferencing).</p>
</div>
<div class="paragraph">
<p>The general pattern of this technique when using arrays is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">vars</span><span class="tok-p">:</span>
  <span class="tok-p">&quot;</span><span class="tok-nv">array[id1]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;value1&quot;</span><span class="tok-p">;</span>
  <span class="tok-p">&quot;</span><span class="tok-nv">array[id2]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;value2&quot;</span><span class="tok-p">;</span>
<span class="tok-err">...</span>
<span class="tok-c"># (possibly in a different bundle)</span>
  <span class="tok-p">&quot;</span><span class="tok-nv">index</span><span class="tok-p">&quot;</span>         <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;array&quot;</span><span class="tok-p">);</span>
<span class="tok-err">...</span>
<span class="tok-c"># Use $(index) in promises to make them loop over all the IDs</span>
<span class="tok-c"># and do something with their values</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One example of this technique is to use the @(files) array we defined with the names of the files to edit, as a mechanism to automatically back up files before making any changes in the configfiles() bundle we defined throughout <a href="#ch-using-cfengine">[ch-using-cfengine]</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># Files to edit</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sysctlconf]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/sysctl.conf&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sshdconfig]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[inittab]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/inittab&quot;</span><span class="tok-p">;</span>
      <span class="tok-err">...</span>

  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-c"># Pass the name of the array, not the array itself.</span>
      <span class="tok-s">&quot;backup&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_files</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.files&quot;</span><span class="tok-p">);</span>
      <span class="tok-s">&quot;sysctl&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sysctl</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;sshd&quot;</span>    <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sshd</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;inittab&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_inittab</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;users&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">manage_users</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.users&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">backup_files</span><span class="tok-p">(</span><span class="tok-nv">id</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">allfiles</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(id)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$($(id)[$(allfiles)])</span><span class="tok-s">.original&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Backup old versions of </span><span class="tok-si">$($(id)[$(allfiles)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(id)[$(allfiles)])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have inserted a call to backup_files() before all the other bundle calls, with the name of the @(configfiles.files) array as an argument. This bundle uses implicit looping over all the elements of the array, copying each file onto a backup file with ".original" as a suffix.</p>
</div>
<div class="paragraph">
<p>You might ask at this point: why not just use CFEngine’s built-in backup behavior, which can be defined in an <a href="http://cf-learn.info/ref/edit_defaults">edit_defaults</a> body part, as we saw in <a href="#editing-etcinittab">[editing-etcinittab]</a>? The technique shown in this section does not preclude the use of <a href="http://cf-learn.info/ref/edit_defaults">edit_defaults</a> specification, but there are several advantages to doing this as well:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The backup step becomes explicit and centralized (all the backups are done by a single bundle), which helps to make the intention of the policy clearer.</p>
</li>
<li>
<p>The backup will protect against any changes made to the files, not only those made by file-editing promises (for example, changes made by copying files from a remote location, or by external commands invoked by CFEngine).</p>
</li>
<li>
<p>We have more flexibility as to where and how the backup is done. For example, we could decide to have timestamped directories for all the files, kept on a remote file server. To do this, we could replace backup_files() with something like this:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">backup_files</span><span class="tok-p">(</span><span class="tok-nv">id</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">allfiles</span><span class="tok-p">&quot;</span>  <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(id)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">backupdst</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/mnt/fileserver/cfenginebackups-</span><span class="tok-si">$(sys.cdate)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(backupst)</span><span class="tok-s">/.&quot;</span>
        <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>

      <span class="tok-s">&quot;</span><span class="tok-si">$(backupdst)</span><span class="tok-s">/</span><span class="tok-si">$($(id)[$(allfiles)])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Backup old versions of </span><span class="tok-si">$($(id)[$(allfiles)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(id)[$(allfiles)])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are specifying in $(backupdst) the destination directory where the backup files will be placed, named with a current timestamp. In the <a href="http://cf-learn.info/ref/files">files:</a> section, the first promise makes sure the destination directory exists, and the second one copies the files into it by looping over the $(allfiles) list.</p>
</div>
<div class="paragraph">
<p>We could go even further and use the indices of an array to determine the sequence of bundles to call in a complex policy. For example, our configfiles() bundle from before could be rewritten like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># Files to edit</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sysctl]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/sysctl.conf&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sshd]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[inittab]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/inittab&quot;</span><span class="tok-p">;</span>
      <span class="tok-err">...</span>

      <span class="tok-p">&quot;</span><span class="tok-nv">file_id</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;files&quot;</span><span class="tok-p">);</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">bundle_names</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">maplist</span><span class="tok-p">(</span><span class="tok-s">&quot;edit_</span><span class="tok-si">$(this)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;file_id&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;backup&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_files</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.files&quot;</span><span class="tok-p">);</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(bundle_names)</span><span class="tok-s">&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-err">$</span><span class="tok-p">(</span><span class="tok-nf">bundle_names</span><span class="tok-p">)(</span><span class="tok-s">&quot;configfiles.files&quot;</span><span class="tok-p">);</span>
      <span class="tok-s">&quot;users&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">manage_users</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.users&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are defining a list called @(file_id) that contains all the indices from the files array (sysctl, sshd, etc.). Based on it, we define another list called @(method_names) that contains the names of the bundles that we want to call.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>The maplist() function that we use to convert one list into another was introduced in CFEngine Community 3.3.0.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the <a href="http://cf-learn.info/ref/methods">methods:</a> section, we substitute all the calls to the file-editing bundles by a generic promise, which loops over the values of @(bundle_names) and calls the appropriate bundle by interpolating the $(bundle_names) variable into the bundle name. Note how we can also pass arguments to the bundle.</p>
</div>
<div class="paragraph">
<p>In this particular example, we are reducing the number of methods: promises from three to one, so it’s not a big savings. But imagine that as your policy grows, this technique could save many lines, and more importantly, allow you to add new bundle calls simply by adding new elements to the files array, thus reducing the possibility of errors.</p>
</div>
<div class="paragraph">
<p>This type of technique can be used with any list to implement generic tasks. For example, consider this example (included in the <em>examples/</em> directory of the CFEngine source distribution):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;Patch Group&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Apply OS specific patches and modifications&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(sys.class)</span><span class="tok-s">_fix&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we are using the built-in variable <a href="http://cf-learn.info/ref/sysclass">$(sys.class)</a> (which contains the “class” of operating system, e.g. linux, darwin, solaris, etc.) to call a different bundle depending on the operating system of the current host. In this case, we would of course need to define bundles called linux_fix(), darwin_fix(), solaris_fix(), etc., to handle the actual calls, but the top-level intention remains clear and concise.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-defining-classes-for-groups-of-hosts">Defining Classes for Groups of Hosts</h3>
<div class="paragraph">
<p>One of the very common patterns in CFEngine is to define classes for different groups of hosts, and then use those classes to apply different configurations. Remember that CFEngine automatically defines hard classes based on the hostname and the IP address of the current host, and these classes can be tested for in class expressions.</p>
</div>
<div class="paragraph">
<p>In its simplest form, you could list individual hosts that need to be part of the class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">config</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;websrv&quot;</span>    <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;websrv1_domain_com&quot;</span><span class="tok-p">,</span>
                          <span class="tok-s">&quot;websrv2_domain_com&quot;</span><span class="tok-p">,</span>
                          <span class="tok-s">&quot;websrv3_domain_com&quot;</span>
                        <span class="tok-p">};</span>
      <span class="tok-s">&quot;dnssrv&quot;</span>    <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;dnssrv1_domain_com&quot;</span><span class="tok-p">,</span>
                          <span class="tok-s">&quot;dnssrv2_domain_com&quot;</span>
                        <span class="tok-p">};</span>
      <span class="tok-err">...</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>
    <span class="tok-nc">websrv</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;config_websrv&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">config_websrv</span><span class="tok-p">;</span>
    <span class="tok-nc">dnssrv</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;config_dnssrv&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">conig_dnssrv</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the classes websrv and dnssrv are being defined based on a boolean expression of other classes, specified by the or keyword. What this means for the dnssrv class, for example, is <em>“if the dnssrv1_domain_com class is defined OR the dnssrv2_comain_com class is defined, then define the dnssrv class”</em>. As you may remember, CFEngine automatically defines hard classes based on, among other things, the current hostname. If the current hostname is <em>dnssrv1.domain.com</em>, the dnssrv1_domain_com class will be defined (dots are not valid in class names). The end result is that the dnssrv class will be set whenever the policy is evaluated in the dnssrv1.domain.com or in the dnssrv2.domain.com hosts, and analogously for the websrv class.</p>
</div>
<div class="paragraph">
<p>However, if you have a consistent host naming scheme, you could greatly simplify this pattern by using the <a href="http://cf-learn.info/ref/classmatch">classmatch()</a> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">config</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;websrv&quot;</span>    <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">classmatch</span><span class="tok-p">(</span><span class="tok-s">&quot;websrv.*&quot;</span><span class="tok-p">);</span>
      <span class="tok-s">&quot;dnssrv&quot;</span>    <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">classmatch</span><span class="tok-p">(</span><span class="tok-s">&quot;dnssrv.*&quot;</span><span class="tok-p">);</span>
      <span class="tok-err">...</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>
    <span class="tok-nc">websrv</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;config_websrv&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">config_websrv</span><span class="tok-p">;</span>
    <span class="tok-nc">dnssrv</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;config_dnssrv&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">conig_dnssrv</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can apply this technique using any classes, and you can combine any CFEngine functions with individual classes to handle special cases. Other useful functions are <a href="http://cf-learn.info/ref/hostrange">hostrange()</a> and <a href="http://cf-learn.info/ref/iprange">iprange()</a>, which are specially designed to match ranges of hostnames and IP addresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">config</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-c"># Functional classes</span>
      <span class="tok-s">&quot;websrv&quot;</span>       <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nf">classmatch</span><span class="tok-p">(</span><span class="tok-s">&quot;websrv.*&quot;</span><span class="tok-p">),</span>
                             <span class="tok-s">&quot;testsrv_domain_com&quot;</span> <span class="tok-p">};</span>
      <span class="tok-s">&quot;linux_dnssrv&quot;</span> <span class="tok-kr">and</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nf">classmatch</span><span class="tok-p">(</span><span class="tok-s">&quot;dnssrv.*&quot;</span><span class="tok-p">),</span>
                              <span class="tok-s">&quot;linux&quot;</span> <span class="tok-p">};</span>
      <span class="tok-c"># Geographical classes, using IP ranges</span>
      <span class="tok-s">&quot;location1&quot;</span>    <span class="tok-c"># 10.1.0.0/16, 10.2.0.0/16, also websrv01-10</span>
        <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nf">iprange</span><span class="tok-p">(</span><span class="tok-s">&quot;10.1.0.0/16&quot;</span><span class="tok-p">),</span> <span class="tok-nf">iprange</span><span class="tok-p">(</span><span class="tok-s">&quot;10.2.0.0/16&quot;</span><span class="tok-p">),</span>
                <span class="tok-nf">hostrange</span><span class="tok-p">(</span><span class="tok-s">&quot;websrv&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;01-10&quot;</span><span class="tok-p">)</span> <span class="tok-p">};</span>
      <span class="tok-s">&quot;location2&quot;</span>    <span class="tok-c"># 10.10.0.0/16, also websrv11-20</span>
        <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nf">iprange</span><span class="tok-p">(</span><span class="tok-s">&quot;10.10.0.0/16&quot;</span><span class="tok-p">),</span>
                <span class="tok-nf">hostrange</span><span class="tok-p">(</span><span class="tok-s">&quot;websrv&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;11-20&quot;</span><span class="tok-p">)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can combine both hard and soft classes, CFEngine functions and special variables, and any type of class expressions, to express the exact conditions on which you want to act.</p>
</div>
</div>
<div class="sect2">
<h3 id="controlling-promise-execution-order">Controlling Promise Execution Order</h3>
<div class="paragraph">
<p>Normally, CFEngine takes care of properly evaluating variables and classes, by combining normal ordering and multiple evaluation passes (up to three), as described in <a href="#normal-ordering">[normal-ordering]</a>. In general terms, when a variable or class changes during a pass, anything that depends on it will be reevaluated on the next pass to account for the change.</p>
</div>
<div class="paragraph">
<p>There are, however, some special cases in which we may need to force CFEngine’s hand a little, and make it evaluate things in a different, specific order. For cases like this, you can tell CFEngine to evaluate certain statements only when some class is defined, and only define that class when the appropriate conditions arise.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Since CFEngine 3.4.0, you can also use the <a href="http://cf-learn.info/ref/depends_on">depends_on</a> attribute to actively control promise execution order. See below for an example.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A clear example of this technique can be seen in the set_config_values() bundle from the standard library, which we saw described in detail in <a href="#editing-etcsshd_config">[editing-etcsshd_config]</a>. I invite you to review the description to see the details of how that particular example works.</p>
</div>
<div class="paragraph">
<p>In general, when we want to force promise A to evaluate after promise B, when their normal order would be reversed, we should define a class after promise B runs, and condition promise A on that class. A useful function for this type of conditioning is <a href="http://cf-learn.info/ref/isvariable">isvariable()</a>, which allows us to check whether a variable has been defined. This contrived example shows the technique in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">var1</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;value 1&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">foo</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">var2</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;value 2&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;foo&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">isvariable</span><span class="tok-p">(</span><span class="tok-s">&quot;var1&quot;</span><span class="tok-p">);</span>
      <span class="tok-s">&quot;bar&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">isvariable</span><span class="tok-p">(</span><span class="tok-s">&quot;var2&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;var1=</span><span class="tok-si">$(var1)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;bar&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;var2=</span><span class="tok-si">$(var2)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is what is happening:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the first pass, $(var1) is defined, but $(var2) isn’t because the foo class does not exist. Then, the class foo is defined as true, but bar is false because $(var2) does not exist. In the <a href="http://cf-learn.info/ref/reports">reports:</a> section, the first message is not printed because bar class is false, so only the "var2" message is printed.</p>
</li>
<li>
<p>In the second pass, $(var2) is defined, because the foo class is now true. Then, in the <a href="http://cf-learn.info/ref/classes">classes:</a> section, the bar class is defined as true because variable $(var2) now exists. And finally, in the <a href="http://cf-learn.info/ref/reports">reports:</a> section, the first message is shown because the bar class is now true. The other message is not printed again because it had been printed already in the previous pass (CFEngine keeps track of which promises it has already fulfilled).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The net result is that the messages from the reports: section are printed in reverse order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent -KI -f ./order-control.cf
<span class="tok-go">2013-10-14T05:56:38+0000   notice: R: var2=value 2</span>
<span class="tok-go">2013-10-14T05:56:38+0000   notice: R: var1=value 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In CFEngine 3.4.0, the <a href="http://cf-learn.info/ref/depends_on">depends_on</a> attribute, which was previously used for documentation purposes only, became active in determining the order of promise execution by allowing you to specify that a certain promise should only be evaluated once others have been successful. This means that our previous example can now be written like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">var1</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;value 1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">var2</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;value 2&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;var1=</span><span class="tok-si">$(var1)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">depends_on</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;second_message&quot;</span> <span class="tok-p">};</span>
      <span class="tok-s">&quot;var2=</span><span class="tok-si">$(var2)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;second_message&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output is exactly the same as before. As you can see, in this case we are assigning a handle to the second <a href="http://cf-learn.info/ref/reports">reports:</a> promise, and declaring the first <a href="http://cf-learn.info/ref/reports">reports:</a> promise as dependent on the second one. This means that the first message will only be printed after the second one.</p>
</div>
<div class="paragraph">
<p>I would advise you to exercise extreme caution, and to think carefully, before messing with CFEngine’s normal ordering. The ordering is there because years of experience have shown that is the order that makes most sense, and CFEngine’s variable-and-class convergence mechanisms ensure that, in most cases, the behavior is correct even when things need to be evaluated over multiple passes. If you feel the need to modify the order of execution, it pays to first step back and look at the problem from a different perspective and see if it can be made to function within CFEngine’s constraints and rules. Only after this option is completely ruled out should you implement mechanisms like shown above. Document them carefully, because as we saw above, the code can quickly get long and complicated.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-dynamic-loading-and-execution">Dynamic Loading and Execution</h3>
<div class="paragraph">
<p>We have seen that CFEngine allows you to specify the policy files to load using the <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute in body common control, and the order in which bundles should be executed using the <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> attribute. Additionally, you can use <a href="http://cf-learn.info/ref/methods">methods:</a> promises to call other bundles in any order you want. However, at times you may want to have more dynamic control over the files that are loaded or the bundles that are executed. As your infrastructure grows or becomes more dynamic, your policy needs to adapt as well. This section shows some techniques that you can use to control what gets loaded and executed into your policy.</p>
</div>
<div class="sect3">
<h4 id="_per_file_inputs">Per-File Inputs</h4>
<div class="paragraph">
<p>As your policy grows, it is natural to split it into multiple files to make it easier to manage them. For example, you may split your basic system configuration policies into one file (or even several, for different subsystems), your web server configuration policies into another file, and so on. You may want to federate control over different parts of the system, or simply partition your policies according to host roles, groups within your organization, or networks. However, you still have to list all your input files in the top-level inputs attribute.</p>
</div>
<div class="paragraph">
<p>Sometimes, however, it would be nice if your top-level policy file could list only a few main files, and those in turn could load other files. Even the Design Center runfile, described in <a href="#ch-design-center">[ch-design-center]</a>, needs to load a different set of files depending on the sketches that have been activated. For cases like these, I will show you how you can dynamically load policy files.</p>
</div>
<div class="paragraph">
<p>The core of this technique is to store your list of files in a list variable defined in a common bundle, and then use that variable in your <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute. For example, in your main policy file you can have something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
      <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;defs&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
      <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;defs.cf&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@(defs.inputs)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> includes a bundle called test() that is not shown in this file. The <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute refers to <em>defs.cf</em>, which can be defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">defs</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">inputs</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;input1.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we define a variable called inputs that contains "input1.cf". Look back up at our main file, and you will see that the <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute also specifies @(defs.inputs). Through this variable, the <em>input1.cf</em> file will be loaded, which finally contains the definition of the test() bundle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">reports</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;Hello from </span><span class="tok-si">$(this.promise_filename)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is admittedly a very simple example, but in fact, this is the exact technique that is used by the Design Center runfile to load the files for all the activated sketches. Look at the cfsketch_g() bundle in the runfile we generated in <a href="#ch-design-center">[ch-design-center]</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">cfsketch_g</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">inputs</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;sketches/libraries/dclib/library.cf&quot;</span><span class="tok-p">,</span>
                          <span class="tok-s">&quot;sketches/libraries/copbl/cfengine_stdlib.cf&quot;</span><span class="tok-p">,</span>
                          <span class="tok-s">&quot;sketches/networking/ssh/ssh.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This variable gets included from body common control, either in the standalone runfile or from the main <em>promises.cf</em> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>      <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nv">@(cfsketch_g.inputs)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this technique, the Design Center tools can generate the runfile with the appropriate definition for cfsketch_g.inputs according to the sketches that are currently activated, and load those files without having to modify the definition of the main <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute every time something changes.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>CFEngine 3.6 (in fact, this code is already in the master branch of the core CFEngine repository on GitHub) will introduce the inputs attribute for the body file control construct. This will allow you to specify per-file inputs directly, without resorting to the technique described here, by including the following in <em>defs.cf</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">file</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
      <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;input1.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you don’t need to call any extra bundles or reference any variables from your main policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
      <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
      <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;defs.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_bundle_execution_control">Dynamic bundle execution control</h4>
<div class="paragraph">
<p>CFEngine, as you know by now, makes it very easy to execute different parts of the policy depending on arbitrary conditions, expressed as class expressions. However, at the top level, you still have a static <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> declaration that tells CFEngine which bundles to execute when evaluating the policy. There are several ways to dynamically control the sequence of bundles to be executed in the policy.</p>
</div>
<div class="paragraph">
<p>For our example, let’s assume we have some common bundles to be called on all systems, some that are only to be executed in Linux systems, and some that are only to be executed on web or database servers. In addition, there are some special kernel settings that need to be configured on Database servers running Linux.</p>
</div>
<div class="paragraph">
<p>My favorite technique, which we have already seen before, is to use a sequence of <a href="http://cf-learn.info/ref/methods">methods:</a> promises with class expressions controlling which ones are executed in which sequence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span> <span class="tok-p">{</span>
      <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;main&quot;</span> <span class="tok-p">};</span>   <b class="conum">(1)</b>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">main</span>
<span class="tok-p">{</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>   <b class="conum">(2)</b>
    <span class="tok-nc">any</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;dns&quot;</span>     <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">dns_config</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;ntp&quot;</span>     <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">ntp_config</span><span class="tok-p">;</span>
    <span class="tok-nc">webserver</span><span class="tok-p">::</span>   <b class="conum">(3)</b>
      <span class="tok-s">&quot;apache&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">apache_config</span><span class="tok-p">;</span>
    <span class="tok-nc">dbserver</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;mysql&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">mysql_config</span><span class="tok-p">;</span>
    <span class="tok-nc">linux.!dbserver</span><span class="tok-p">::</span>   <b class="conum">(4)</b>
      <span class="tok-s">&quot;sysctl_std&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">sysctl_std_config</span><span class="tok-p">;</span>
    <span class="tok-nc">linux.dbserver</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;sysctl_tuned&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">sysctl_tuned_config</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In this technique, the top-level
<a href="http://cf-learn.info/ref/bundlesequence"><code>bundlesequence</code></a> declaration
remains fixed. All the control happens inside one or more of the
bundles called from it. In this example we are calling the main()
bundle.</p>
</li>
<li>
<p>Inside the main() bundle, we have a sequence of
<a href="http://cf-learn.info/ref/methods"><code>methods:</code></a> promises that allow us to
call multiple other bundles according to the conditions we want to
define. First we have two calls conditioned to the class <code>any</code>, to
configure DNS and NTP on the server. Strictly speaking, we could leave
out the <code>any::</code> condition, but I consider it good practice to be
explicit when we have complex sequences of conditions as in this
example.</p>
</li>
<li>
<p>We next have two bundle calls conditioned to the classes <code>webserver</code>
and <code>dbserver</code>, respectively, to configure Apache and MySQL. For this
example we are assuming these classes have been set elsewhere, for
example using the techniques described in
#sec-defining-classes-for-groups-of-hosts.</p>
</li>
<li>
<p>We finally have two bundle calls for Linux systems, to set <code>sysctl</code>
parameters. One of them is for Linux hosts that are not database
servers (<code>linux.!dbserver</code>), and the other for Linux hosts that are
database servers (<code>linux.dbserver</code>), arguably to provide some
fine-tuned parameters for this particular application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you can see, this technique allows you to very clearly express the flow of the policy, each section being clearly labeled with the conditions in which it should be applied. Also observe how we can use both hard and soft classes in the conditions.</p>
</div>
<div class="paragraph">
<p>Another way of achieving this result is to store the sequence of bundles to call in a list variable, and then use that list in the top-level <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> declaration. In this technique, the <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> gets updated dynamically according to the assignments in the list variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span> <span class="tok-p">{</span>
      <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;config&quot;</span><span class="tok-p">,</span>   <b class="conum">(1)</b>
                          <span class="tok-nv">@(config.sequence)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">config</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_common</span><span class="tok-p">&quot;</span>    <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;dns_config&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;ntp_config&quot;</span> <span class="tok-p">};</span>   <b class="conum">(2)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_webserver</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_dbserver</span><span class="tok-p">&quot;</span>  <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_linux</span><span class="tok-p">&quot;</span>     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">webserver</span><span class="tok-p">::</span>   <b class="conum">(3)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_webserver</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;apache_config&quot;</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">dbserver</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_dbserver</span><span class="tok-p">&quot;</span>  <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;mysql_config&quot;</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">linux.!dbserver</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_linux</span><span class="tok-p">&quot;</span>     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;sysctl_std_config&quot;</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">linux.dbserver</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">seq_linux</span><span class="tok-p">&quot;</span>     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;sysctl_tuned_config&quot;</span> <span class="tok-p">},</span> <span class="tok-kr">policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;free&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">any</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sequence</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nv">@(seq_common)</span><span class="tok-p">,</span>   <b class="conum">(4)</b>
                            <span class="tok-nv">@(seq_webserver)</span><span class="tok-p">,</span>
                            <span class="tok-nv">@(seq_dbserver)</span><span class="tok-p">,</span>
                            <span class="tok-nv">@(seq_linux)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In this example, the top-level
<a href="http://cf-learn.info/ref/bundlesequence"><code>bundlesequence</code></a> is no longer
static. Instead we call a bundle called config(), which defines a list
variable called sequence. After the config() bundle is called, we use
<code>@(config.sequence)</code> in the top-level
<a href="http://cf-learn.info/ref/bundlesequence"><code>bundlesequence</code></a> definition,
so the actual sequence of bundles executed will depend on the contents
of that variable.</p>
</li>
<li>
<p>Inside the config() bundle, we start by initializing a few list
variables, which will be concatenated at the end to produce the final
bundle sequence (we do this because CFEngine does not allow us to
extend a list variable, since it leads to non-convergent behavior).
The variable seq_common contains the common sequence of bundles, and
is initialized with our two fixed bundles that will be called on all
hosts. The seq_webserver, seq_dbserver, and seq_linux variables
contain the bundles that will be executed for the corresponding cases,
and we initialize them to empty lists. Note that these variables are
declared with <code>policy &#8658; "free"</code> so that CFEngine allows us
to reassign their values later on without complaints.</p>
</li>
<li>
<p>We next reassign the values of seq_webserver, seq_dbserver, and
seq_linux according to the same conditions that we had before. In this
case, instead of conditioning
<a href="http://cf-learn.info/ref/methods"><code>methods:</code></a> promises, we are
conditioning the assignments to the corresponding list variables.</p>
</li>
<li>
<p>Finally, we concatenate all four list variables into a final variable
called <code>sequence</code>, and which is the one being referenced from the
top-level <a href="http://cf-learn.info/ref/bundlesequence"><code>bundlesequence</code></a>
attribute as <code>@(config.sequence)</code>. Note that, according to the
conditions that are satisfied, some of the variables may be empty,
which will result in the final list containing only the bundles that
need to be executed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You may observe that this technique is slightly more complicated than the previous one, requiring multiple variables, an initialization section, etc. It also seems to less clearly express the intent of the policy. Why, then, would we want to use it? Its power lies in placing the bundle sequence in a variable. In our example we are assigning those lists by hand, but in a real system, their values could come from files, from a database, or from arbitrarily complex operations. As long as, in the end, the config.sequence variable contains a list of bundles to execute, its contents can come from anywhere we need. For example, if you have several customers, each with their own hosts, the lists of bundles could be determined according to privileges, roles, or services available to each customer.</p>
</div>
<div class="paragraph">
<p>The final technique is a combination of the previous two: it maintains a fixed top-level <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> declaration, uses <a href="http://cf-learn.info/ref/methods">methods:</a> calls, but the sequence is determined from the contents of a variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span> <span class="tok-p">{</span>
      <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;config&quot;</span><span class="tok-p">,</span>   <b class="conum">(1)</b>
                          <span class="tok-s">&quot;main&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">main</span>
<span class="tok-p">{</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(config.sequence)</span><span class="tok-s">&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-err">$</span><span class="tok-p">(</span><span class="tok-nf">config</span><span class="tok-err">.</span><span class="tok-nf">sequence</span><span class="tok-p">);</span>   <b class="conum">(2)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>As in the first technique we saw, the
<a href="http://cf-learn.info/ref/bundlesequence"><code>bundlesequence</code></a> declaration
is static. In this case we are calling both the config() bundle, which
stores the list of bundles to execute in a variable, and the main()
bundle, which calls the bundles. The config() bundle is identical to
the one we saw before, so we are omitting it from the listing.</p>
</li>
<li>
<p>The main() bundle now is much shorter than in our first technique.
Instead of coding the <a href="http://cf-learn.info/ref/methods"><code>methods:</code></a>
promises by hand, it uses implicit looping over the
<code>@(config.sequence)</code> list to call each bundle in sequence. You can
observe here that we are using the looped value <code>$(config.sequence)</code>
both in the promiser (the identifier for the
<a href="http://cf-learn.info/ref/methods"><code>methods:</code></a> promise) and as the name
of the bundle to be called.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>CFEngine allows you tremendous flexibility in dynamically determining a sequence of bundles to execute. Choose the one that suits you best. As usual, my advise is to avoid unnecessary complication—keep your policies as simple as possible, and introduce advanced logic or structures only when strictly necessary. This will keep the intent of your policy is as clear as possible, which will be advantageous both to others reading your policy, and to yourself when you look at it in the future!</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. All the parameter names shown in this example start with an underscore, but this has no implicit meaning. It’s just a convention used in the Wordpress installer to indicate internal parameters that will not be written to the WordPress configuration file.
</div>
</div>

  </div>
</div>


</body>
</html>
