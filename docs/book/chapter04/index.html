<!DOCTYPE html>
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Chapter 4: Using CFEngine &middot; Diego Zamboni</title>

  
  <link rel="stylesheet" href='../../css/poole.css'>
  <link rel="stylesheet" href='../../css/hyde.css'>
  <link rel="stylesheet" href='../../css/poole-overrides.css'>
  <link rel="stylesheet" href='../../css/hyde-overrides.css'>
  <link rel="stylesheet" href='../../css/hyde-x.css'>
  <link rel="stylesheet" type="text/css" href='../../css/socialicious.css' media="screen" />
  
  <link href='https://fonts.googleapis.com/css?family=Quattrocento|Quattrocento+Sans' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href='../../css/tachyons.min.css'/>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../apple-touch-icon-144-precomposed.png">
  <link href="../../favicon.png" rel="icon">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Learning CFEngine 3 &middot; Diego Zamboni" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body class="lh-copy">
<div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
      <h1>Learning CFEngine 3</h1>
      
    </div>

    <ul class="sidebar-nav">
      
        <li class="sidebar-nav-item"><a  href="../../home/">Home</a></li>
      
        <li class="sidebar-nav-item"><a  href="../../the-author/">The Author</a></li>
      
        <li class="sidebar-nav-item"><a  href="../../post/">The Blog</a></li>
      
        <li class="sidebar-nav-item"><a  href="../../book/">The Book</a></li>
      
        <li class="sidebar-nav-item"><a  href="../../the-code/">The Code</a></li>
      
        <li class="sidebar-nav-item"><a  href="../../the-raves/">The Raves</a></li>
      
        <li class="sidebar-nav-item"><a  href="../../contact/">Contact</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      
      
      <a href="http://twitter.com/LearningCF3"><li class="icon-twitter"></li></a>&nbsp;
      
      
    </ul>

    <div class="sidebar-sticky"><p>&copy; 2018 Diego Zamboni<br/>
        Powered by <a href="https://gohugo.io">Hugo</a></p></div>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>Chapter 4: Using CFEngine</h1>
    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#ch-using-cfengine">Using CFEngine</a>
<ul class="sectlevel2">
<li><a href="#system-configuration">Initial System Configuration</a></li>
<li><a href="#user-management">User Management</a></li>
<li><a href="#software-installation-servers">Software Installation</a></li>
<li><a href="#using-cfengine-for-security">Using CFEngine for Security</a></li>
<li><a href="#_additional_cfengine_features_and_information">Additional CFEngine Features and Information</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="ch-using-cfengine">Using CFEngine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will now explore how to perform some common configuration tasks using CFEngine. Along the way we will encounter more advanced concepts and structures of the CFEngine language.</p>
</div>
<div class="sect2">
<h3 id="system-configuration">Initial System Configuration</h3>
<div class="paragraph">
<p>After a system is installed, a number of routine tasks needs to be performed before declaring it ready for use. These include installation of base software packages, network configuration, file system configuration, user creation, authentication configuration, and configuration of system components. CFEngine can do all of these tasks consistently and predictably.</p>
</div>
<div class="paragraph">
<p>Throughout this section, we will incrementally build a CFEngine policy that edits a number of configuration files, starting from a single entry point. In the process I will show you some common techniques for passing and processing parameters, and several new CFEngine constructs and concepts.</p>
</div>
<div class="sect3">
<h4 id="_running_these_policies">Running These Policies</h4>
<div class="paragraph">
<p>While you are writing and testing them, it’s easiest to save these policies in a file that you can run by itself from the command line. For this, remember as we saw in <a href="../../book/chapter02/#getting-started-with-cfengine---your-first-policy">Your First CFEngine Policy</a>, that you need to add a body common control in the file that loads the appropriate libraries and specifies which bundles should be executed. For all the system configuration examples, you need to add this at the beginning of the file ("configfiles" is the name of the bundle to execute—adapt it to the different policies and examples):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
    <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/var/cfengine/inputs/libraries/cfengine_stdlib.cf&quot;</span> <span class="tok-p">};</span>
    <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;configfiles&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you are ready to integrate these bundles into your main CFEngine policy, you need to follow the steps described in <a href="../../book/chapter02/#sec-integrating-into-promisescf">Integrating Your New Policy Into Periodic CFEngine Execution</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="editing-sysctl.conf">Editing /etc/sysctl.conf</h4>
<div class="paragraph">
<p>One of the files that commonly requires configuration in a new Linux system is <em>/etc/sysctl.conf</em>. This file contains configuration values for some kernel parameters that control different aspects of system behavior. For example, it may contain the following lines:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>net.ipv4.tcp_syncookies = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.all.log_martians = 1</pre>
</div>
</div>
<div class="paragraph">
<p>These particular parameters control behavior of the networking stack in the kernel (net.ipv4).</p>
</div>
<div class="paragraph">
<p>We can use CFEngine to ensure these parameters are present in the <em>/etc/sysctl.conf</em> file. We will walk through an example that demonstrates this ability, but also shows the different levels at which a CFEngine policy can operate:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At the highest level, the policy simply says “configure the <em>/etc/sysctl.conf</em> file using these parameters.” This part of the policy is a building block that can be added or removed to an installation at a management level without worrying about how it’s implemented.</p>
</li>
<li>
<p>The next level down says “set these values in the <em>/etc/sysctl.conf</em> file and in the running system.” This can be changed as a sysadmin decides what options need to be enabled, without thinking about the syntax of the file.</p>
</li>
<li>
<p>The next level explains the structure of the file and how the parameters should be set. It essentially extracts the implementation details, which are independent of which options you choose.</p>
</li>
<li>
<p>The lowest level explains how to perform the field edits in the file, how classes should be handled, and other implementation details.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span> <b class="conum">(1)</b>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># Files to edit</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sysctl]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/sysctl.conf&quot;</span><span class="tok-p">;</span> <b class="conum">(2)</b>

      <span class="tok-c"># Sysctl variables to set</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.tcp_syncookies]</span><span class="tok-p">&quot;</span>               <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span> <b class="conum">(3)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_source_route]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_redirects]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.rp_filter]</span><span class="tok-p">&quot;</span>           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.log_martians]</span><span class="tok-p">&quot;</span>        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">methods</span><span class="tok-p">:</span> <b class="conum">(4)</b>
      <span class="tok-s">&quot;sysctl&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sysctl</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Configure </span><span class="tok-si">$(files[sysctl])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">edit_sysctl</span>
<span class="tok-p">{</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span> <b class="conum">(5)</b>
      <span class="tok-s">&quot;</span><span class="tok-si">$(configfiles.files[sysctl])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;edit_sysctl&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Make sure sysctl.conf contains desired configuration&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_variable_values</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.sysctl&quot;</span><span class="tok-p">),</span> <b class="conum">(6)</b>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;sysctl_modified&quot;</span><span class="tok-p">);</span> <b class="conum">(7)</b>

  <span class="tok-kd">commands</span><span class="tok-p">:</span> <b class="conum">(8)</b>
    <span class="tok-nc">sysctl_modified.!no_restarts</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/sbin/sysctl -p&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;reload_sysctl&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Make sure new sysctl settings are loaded&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This short CFEngine policy ensures that the appropriate lines are present in the <em>/etc/sysctl.conf</em> file to set the parameters we want. If a parameter is already there but with a different value, the policy will fix it. If a parameter does not appear in the file, the policy will add it. Let’s dissect the example by parts.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The configfiles() agent bundle is a “driver” bundle that calls others to actually perform the work (see the <a href="http://cf-learn.info/ref/methods"><code>methods:</code></a> section later). This allows us (as we will do in later sections) to add more tasks that are called from the same driver bundle.</p>
</li>
<li>
<p>In <code>configfiles()</code>, we first define some variables in a <a href="http://cf-learn.info/ref/vars"><code>vars:</code></a> section. In it, we define an array called files. Remember, as we saw in <a href="book/chapter03/#sec-arrays">Arrays</a>, that arrays in CFEngine are indexed by arbitrary strings. In this case we are specifying an element indexed by the string <code>sysctl</code>, and containing the path of the file to be edited. We will refer back to this array later in the policy, and we will add more elements to it throughout the chapter, to hold the filenames of the different files to edit. To refer back to this array we will use the name configfiles.files, to indicate the files array inside the <code>configfiles()</code> bundle.</p>
</li>
<li>
<p>We also define an array called sysctl (I used the same name as the element defined above in files just because they both refer to the same file, but I could use any name), indexed by parameter name, and containing the value to set for each parameter. This is a common technique that we will use for passing key/value pairs in CFEngine, as it allows us to succinctly define values for configuration files, users, and many other parameters. Note that we define each element of the array on its own line, each element indexed by the name of a parameter to set in <em>/etc/sysctl.conf</em>, and containing as its value the value to set for that parameter. We define the elements as strings to make them generic and able to contain any type of value. To refer to this array from other bundles, we will use its full name configfiles.sysctl, to identify the bundle where it was defined.</p>
</li>
<li>
<p>After setting up the variables in <code>configfiles()</code>, we include a <a href="http://cf-learn.info/ref/methods"><code>methods:</code></a> section, which allows us to specify multiple bundles to be called in sequence. In this example, we have only the call to edit_sysctl(), which does the work of editing the file. (We will describe edit_sysctl() in a moment.) Each method call has an arbitrary identifier. In this case we use the identifier <code>"sysctl"</code> to identify it as part of the sequence that performs the edits on <em>/etc/sysctl.conf</em>. Later in the chapter we will add calls to other bundles that perform different configuration tasks. We also specify a comment attribute to express the higher-level intention of this promise.</p>
<div class="paragraph">
<p>Using <a href="http://cf-learn.info/ref/methods"><code>methods:</code></a> promises to abstract lower-level bundles is a good way of communicating higher-level intentions in CFEngine policies, without the distraction of the actual implementation details.</p>
</div>
</li>
<li>
<p>The edit_sysctl() bundle is called from the <code>methods:</code> section, and contains <em>promises</em> that specify the desired state of the system. The bundle starts with a <a href="http://cf-learn.info/ref/files"><code>files:</code></a> section, in which the promiser is the file to be edited. We use, as the filename, the <code>sysctl</code> element of the configfiles.files array. This is the files array defined in the <code>configfiles()</code> bundle, which gives us the value <code>"/etc/sysctl.conf"</code>. We provide <a href="http://cf-learn.info/ref/handle"><code>handle</code></a> and <a href="http://cf-learn.info/ref/comment"><code>comment</code></a> attributes, which contribute nothing to the configuration activity, but are recommended in all promises because they help you tremendously when observing log output. The <a href="http://cf-learn.info/ref/create"><code>create</code></a> attribute specifies that the file should be created if it does not exist (this may be the case immediately after installation if no custom parameters are set).</p>
</li>
<li>
<p>Next comes the part that actually does the work, and it is surprisingly simple. The <a href="http://cf-learn.info/ref/edit_line"><code>edit_line</code></a> attribute calls the set_variable_values() bundle with the <em>name</em> of the array that contains the values we want to set. We do not pass the array itself but its name, and this name will be dereferenced inside set_variable_values() to find the actual array.</p>
<div class="paragraph">
<p>You probably realize that the set_variable_values() bundle is very important, since it’s the one that actually performs the work of editing the file. This is not a built-in command, but rather is contained in the CFEngine Standard Library (described in <a href="../../book/chapter03/#cfengine_stdlib">CFEngine Standard Library</a>). We will come back to it in a moment.</p>
</div>
</li>
<li>
<p>The <a href="http://cf-learn.info/ref/classes"><code>classes</code></a> attribute tells CFEngine that if the promise is <em>repaired</em>, the <code>sysctl_modified</code> class should be set (the notion of a “class” was explained in <a href="../../book/chapter03/#classes-and-decision-making">Classes and Decision Making</a>) The <code>if_repaired</code> body part is defined in the Standard Library as well.</p>
<div class="paragraph">
<p>Wait a second. What do I mean by <em>repaired</em>? To CFEngine, a promise is repaired when <em>any</em> actions needs to be taken as a result of evaluating the promise, and those actions result in reaching the desired state of the promise. For example, if the file already had the desired configuration values, CFEngine would see no need to edit it, and it would not be marked as repaired (in this case CFEngine would consider the promise as “kept”). On the other hand, if any of the parameters were not present and the promise adds them, then the promise will be flagged as “repaired.” All possible end states of a promise are described in the <a href="http://cf-learn.info/ref/classes-in-*">documentation</a> for the <code>classes</code> attribute. We are free to execute this bundle as many times as we want, and CFEngine will make changes only when they are needed. Thus is the nature of convergent configuration that CFEngine allows us to perform.</p>
</div>
</li>
<li>
<p>If the file did not contain all the configuration parameters and CFEngine adds any of them (thus “repairing” the state of the file), the sysctl_modified class will be set, thanks to the <code>if_repaired</code> body part we just saw in our configuration. This is useful because when the file gets modified, we have to issue the <em>/sbin/sysctl -p</em> command to instruct the system to reload the values and make them effective immediately. Thus, in the <a href="http://cf-learn.info/ref/commands"><code>commands:</code></a> section, you can see that we are issuing this command. The command is preceded by a <a href="http://cf-learn.info/ref/operators"><em>class expression</em></a>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>    <span class="tok-nc">sysctl_modified.!no_restarts</span><span class="tok-p">::</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a boolean expression in which the dot means AND (you can also use an ampersand if it feels more natural), and the exclamation mark means NOT. (A vertical bar or pipe character, which is not used in this example, would mean OR.) In this particular case, the <em>/sbin/sysctl -p</em> command will be executed only if the sysctl_modified class is set (that is, if <em>/etc/sysctl.conf</em> was modified) AND the no_restarts class is not set. This construct allows us to change the configuration files without executing any restart or reconfiguration commands, by defining the no_restarts class (which we could do, for example, by giving the -Dno_restarts command-line option to <a href="http://cf-learn.info/ref/cf-agent"><em>cf-agent</em></a> when executing the policy).</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes the high-level description of the policy, which as you can see, describes in a fairly human-readable fashion what we want to achieve. In summary, our configuration file defines two bundles at the top level: configfiles() and edit_sysctl(). The configfiles() bundle provides the entry point for the policy, defines the files we want to edit and the contents we want them to have, and invokes the edit_sysctl() bundle (later in the chapter we will add calls to other bundles.) That bundle in turn carries out the edits we want to perform on the <em>/etc/sysctl.conf</em> file. Now we will delve deeper into the implementation details.</p>
</div>
<div class="paragraph">
<p>First, let’s come back to the set_variable_values() bundle, since it seems so important. If you open <em>lib/3.5/files.cf</em> (or <em>cfengine_stdlib.cf</em> if you have CFEngine 3.5.0 or older), you will find its definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">edit_line</span> <span class="tok-nf">set_variable_values</span><span class="tok-p">(</span><span class="tok-nv">v</span><span class="tok-p">)</span> <b class="conum">(1)</b>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">index</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(v)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(2)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">cindex[$(index)]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">canonify</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(3)</b>
  <span class="tok-kd">field_edits</span><span class="tok-p">:</span> <b class="conum">(4)</b>
      <span class="tok-s">&quot;</span><span class="tok-se">\s</span><span class="tok-s">*</span><span class="tok-si">$(index)</span><span class="tok-se">\s</span><span class="tok-s">*=.*&quot;</span> <b class="conum">(5)</b>
        <span class="tok-kr">edit_field</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">col</span><span class="tok-p">(</span><span class="tok-s">&quot;=&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;2&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;</span><span class="tok-si">$($(v)[$(index)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;set&quot;</span><span class="tok-p">),</span> <b class="conum">(6)</b>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">if_ok</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(cindex[$(index)])</span><span class="tok-s">_in_file&quot;</span><span class="tok-p">),</span>   <b class="conum">(7)</b>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Match a line starting like key = something&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">insert_lines</span><span class="tok-p">:</span> <b class="conum">(8)</b>
      <span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s">=</span><span class="tok-si">$($(v)[$(index)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Insert a variable definition&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;!</span><span class="tok-si">$(cindex[$(index)])</span><span class="tok-s">_in_file&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember, from <a href="../../book/chapter03/#containers">Bundles, Bodies, and Namespaces</a>, that bundles in CFEngine are equivalent to subroutines in other programming languages—they are self-contained units that can contain most different promise types, thus allowing us to encapsulate functionality. We will now dissect this set_variable_values() bundle to see how it performs its magic.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This bundle receives as its argument, v, the <em>name</em> of an array. In our current example, the bundle will be invoked with v taking the value configfiles.sysctl, in which the indices are parameter names.  The values in the array are the values to which the parameters will be set. So v provides the instructions to edit a file of the form <code>name = value</code>, modifying the values of parameters that already exist, and adding those that do not exist yet.</p>
</li>
<li>
<p>First, we get a list of all the parameters, and store it in the list variable named <code>index</code>. This is done using the built-in CFEngine function <a href="http://cf-learn.info/ref/getindices">getindices()</a> on the passed array, which returns a list of the indices in the array. Note that <a href="http://cf-learn.info/ref/getindices">getindices()</a> also receives the name of the array on which it will operate, so we can simply pass the $(v) parameter to it. In CFEngine, you can use either braces or parenthesis around variable names; they are equivalent, so ${v} would mean the same.</p>
</li>
<li>
<p>Next, we generate an array of canonified parameter names. In CFEngine, a canonified string is a string that can be readily used as a class name. Because some characters are not valid in CFEngine class names, the CFEngine function <a href="http://cf-learn.info/ref/canonify">canonify()</a> allows us to take an arbitrary string and remove invalid characters from it. We store these canonified values in an array named cindex, indexed by the real parameter name so we can relate them to their canonified version. We use CFEngine’s implicit looping to populate the entire array.</p>
</li>
<li>
<p>The next step in performing the edits on the file is to update the values of parameters that already exist in the file. For this we use a <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> section, which also uses implicit looping to apply the editing promise for every parameter.</p>
</li>
<li>
<p>The <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> promise starts with a regular expression that selects the lines in the file that need to have the edit applied. In this case, we want to edit any line that starts with the current parameter name (<code>$(index)</code>), surrounded by optional whitespace (<code>\s*</code>), followed by an equals sign (<code>=</code>), and followed by an arbitrary string (we don’t care about the existing value, since we will replace it with the new one). It is important to note that in <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> promises, CFEngine automatically anchors the given regular expressions to the beginning and end of the line, so the regex we give needs to match the whole line.</p>
<div class="paragraph">
<p>Notice again that thanks to CFEngine’s implicit looping, this whole promise will be executed once for every single parameter stored in our configfiles.sysctl array. In our example, the array contains 5 elements, so the <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> promise will be evaluated 5 times, with $(index) iterating through the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>net.ipv4.tcp_syncookies</code></p>
</li>
<li>
<p><code>net.ipv4.conf.all.accept_source_route</code></p>
</li>
<li>
<p><code>net.ipv4.conf.all.accept_redirects</code></p>
</li>
<li>
<p><code>net.ipv4.conf.all.rp_filter</code></p>
</li>
<li>
<p><code>net.ipv4.conf.all.log_martians</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With a single promise and without any explicit flow-control instructions, CFEngine allows us to apply all of our edits to the whole file.</p>
</div>
<div class="paragraph">
<p>In this example we have a single promise inside the <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> section, but we could have several promises if we wanted to apply different types of field-based edits to the file.</p>
</div>
</li>
<li>
<p>If any lines in the file match the regular expression (this is, that contain a definition of the given parameter), we will apply to them the changes defined by the <a href="http://cf-learn.info/ref/edit_field"><code>edit_field</code></a> attribute of the promise. For this we use yet another definition from the standard library called col(), and which allows generic field-based file editing. In this case, the arguments to col() tell it to use <code>=</code> as the field separator, and to <code>set</code> the second field of the line to the value given by the expression <code>"$($(v)[$(index)])"</code>.</p>
<div class="paragraph">
<p>There is a bit of variable interpolation magic going on here. Variable values in strings are expanded from the inside-out by CFEngine. First, the value of <code>$(v)</code> is expanded, so in our example the string will now read <code>$(configfiles.sysctl[$(index)])</code>. Next, the value of <code>$(index)</code> will be automatically iterated over each parameter value. As an example, for the <code>net.ipv4.tcp_syncookies</code> parameter, it will expand to <code>$(configfiles.sysctl[net.ipv4.tcp_syncookies])</code>. This now looks like a regular variable reference in CFEngine, which will give us the value we want to set for the given parameter, the string <code>"1"</code> in this case.</p>
</div>
</li>
<li>
<p>If the promise is OK (in CFEngine, this means the promise was either already satisfied, or not satisfied but repaired), the <a href="http://cf-learn.info/ref/classes"><code>classes</code></a> attribute sets the <code>"$(cindex[$(index)])_in_file"</code> class. For example, if the parameter <code>net.ipv4.tcp_syncookies</code> already existed in the file, the <code>net_ipv4_tcp_syncookies_in_file</code> class will be set. This is the canonified version of the parameter name, concatenated with the string <code>_in_file</code>.</p>
<div class="paragraph">
<p>Remember from <a href="../../book/chapter03/#classes-and-decision-making">Classes and Decision Making</a> that <em>classes</em> in CFEngine are identifiers that are either set or unset, and that allow us to perform Boolean decisions. In this case, we are setting classes that contain the names of all the parameters that already existed in the file, whether their value was correct already or not. The existence of these classes indicates that there is no further work to be done for those particular parameters.</p>
</div>
</li>
<li>
<p>If a parameter was not found in the file, it needs to be added, and this task is performed by the <a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> section of the bundle. The promiser in this case is the line we want to insert, in the form <code>parameter=value</code>, which promises to be inserted into the file <em>only if</em> the class expression given by the <a href="http://cf-learn.info/ref/ifvarclass"><code>ifvarclass</code></a> attribute is true. In this case, the value of <a href="http://cf-learn.info/ref/ifvarclass"><code>ifvarclass</code></a> is the negation (<code>!</code>) of the class defined by the <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> promise when the parameter was already present in the file. If the class is <em>not</em> defined (which means the parameter was not found in the file), the <a href="http://cf-learn.info/ref/ifvarclass"><code>ifvarclass</code></a> expression evaluates to <code>true</code>, and the missing line will be inserted.</p>
<div class="paragraph">
<p>As an example, lets imagine that the <code>net.ipv4.conf.all.log_martians</code> parameter is not present in the file. Then the <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a> promise will fail (because there is no line that matches the regular expression that searches for a line starting with the parameter name), and so the net_ipv4_conf_all_log_martians_in_file class will <em>not</em> be set. When the <a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> promise is executed, the value of the class expression <code>!$(cindex[$(index)])_in_file</code> (which expands to the string <code>!net_ipv4_conf_all_log_martians_in_file</code>) will be true, indicating that the line needs to be inserted.</p>
</div>
<div class="paragraph">
<p>You will notice this pattern of behavior often in CFEngine policies: doing some checks and fixes, setting certain classes based on the result, and then triggering other actions based on the existence of those classes. It seems convoluted at first, but it allows a lot of flexibility, and particularly allows policies to be convergent, not making changes unless they are necessary.</p>
</div>
<div class="paragraph">
<p>I must note that <a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> promises in CFEngine are quite smart. In particular, they will not insert a line that already exists in the file (this is a consequence of the promise theory underpinnings—if the line is already in the file, the promise has already converged to its desired state, and there is no need to insert it again), so in principle we should not need to set a class and then condition the insertion of the line on it. In this particular case, using the class allows us to account for things like spacing differences (e.g., spaces around the equals sign) that would not be considered by an unconditional <a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> promise.</p>
</div>
</li>
</ol>
</div>
<div id="implicit-looping-in-cfengine" class="sidebarblock">
<div class="content">
<div class="title">Implicit Looping in CFEngine</div>
<div class="paragraph">
<p>Although we have already
described implicit looping in <a href="../../book/chapter03/#looping-in-cfengine">Looping in CFEngine</a>, let us look in
detail at what is going on in this variable assignment, to refresh
your memory. If a list variable is referenced as a scalar (with the
<code>$</code> prefix instead of <code>@</code>), CFEngine automatically loops over all the
values in the list, replacing each element in turn. Thus, by accessing
the index array as a scalar (<code>$(index)</code> instead of <code>@(index)</code>), we are
telling CFEngine to execute the corresponding statement once for every
element of the array. In effect, the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>      <span class="tok-p">&quot;</span><span class="tok-nv">cindex[$(index)]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">canonify</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>will be repeated for every element of @(index), with $(index) taking
each value in sequence. This results in the creation, element by
element, of an array indexed by parameter names, and containing as
values the canonified version of each name.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To finish this discussion, we will go down one more level in the implementation chain, to discuss the three low-level body parts if_repaired(), if_ok(), and col(). None of these are native CFEngine functions, rather they are defined in the standard library as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">classes</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-nv">x</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">promise_repaired</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">classes</span> <span class="tok-nf">if_ok</span><span class="tok-p">(</span><span class="tok-nv">x</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">promise_repaired</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">promise_kept</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">edit_field</span> <span class="tok-nf">col</span><span class="tok-p">(</span><span class="tok-nv">split</span><span class="tok-p">,</span><span class="tok-nv">col</span><span class="tok-p">,</span><span class="tok-nv">newval</span><span class="tok-p">,</span><span class="tok-nv">method</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">field_separator</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(split)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">select_field</span>       <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(col)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">value_separator</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;,&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">field_value</span>        <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(newval)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">field_operation</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(method)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">extend_fields</span>      <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">allow_blank_fields</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>As a general rule, you should not worry too much about the implementation details of bundles in the standard library, just as you don’t worry about the implementation details in the C standard library or in Perl CPAN modules. We are delving into the details here as an opportunity for you to learn more about the CFEngine policy language, and all the different levels at which it operates.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>if_repaired() and if_ok() are both <a href="http://cf-learn.info/ref/classes">classes</a> body parts, which means they can be used as the value of a <a href="http://cf-learn.info/ref/classes">classes</a> attribute. This attribute is allowed in almost any CFEngine promise, and defines classes to be set depending on the result of the promise.</p>
</div>
<div class="paragraph">
<p>The two examples shown here should be fairly self-explanatory. In if_repaired(), we are specifying that the class whose name is given as argument $(x) will be defined only when the promise was repaired (this is, when some change had to be made in order to bring the promise to its desired state). In if_ok(), we are specifying that the class will be defined when the promise was either repaired or kept (this is, it was already true). We examined the col() body in detail in <a href="../../book/chapter03/#sec-bodies">Bodies</a>. In this case we are specifying the field separator, the field to be selected for edition, its value, and the operation to be performed.</p>
</div>
<div class="paragraph">
<p>This finishes our explanation for now. I would like to remind you of the different levels of abstraction present even in this simple example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At the highest level (configfiles() bundle), the policy simply says “configure the <em>/etc/sysctl.conf</em> file with these parameters.”</p>
</li>
<li>
<p>The next level (edit_sysctl bundle), says “set these values in the <em>/etc/sysctl.conf</em> file and in the running system.”</p>
</li>
<li>
<p>The next level (set_variable_values() bundle) explains the structure of the file and how the parameters should be set.</p>
</li>
<li>
<p>The lowest level (col(), if_ok(), if_repaired()) explains how to perform the field edits in the file, how classes should be handled, and other implementation details.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The beauty of CFEngine is that you need to work only at the level of abstraction that is needed at the moment. In fact, different sets of people could operate at each level. A policy maker could set the requirements at the highest level (even higher than the levels shown here, in fact), and both system administrators and CFEngine administrators could operate at the lower levels as required.</p>
</div>
</div>
<div class="sect3">
<h4 id="editing-etcsshd_config">Editing /etc/sshd_config</h4>
<div class="paragraph">
<p>Another common task upon initial installation of a system is to configure certain services, SSH (Secure Shell) being a particularly useful one, and OpenSSH being one of the most popular SSH implementations. By default, the OpenSSH daemon ships with a fairly usable configuration, but you may still want to change it to be more secure, or to adhere to local policies.</p>
</div>
<div class="paragraph">
<p>Having seen how to edit <em>/etc/sysctl.conf</em> in the previous section, you should already start to see how to perform this configuration. For the sake of our example, let’s say we want to modify the following parameters in <em>/etc/ssh/sshd_config</em> from their default configuration in an OpenSSH installation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#Protocol 1,2
#X11Forwarding no
#UseDNS yes</pre>
</div>
</div>
<div class="paragraph">
<p>In OpenSSH, most configuration parameters appear commented out by default, showing their default values. We would like to modify these parameters to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Protocol 2
X11Forwarding yes
UseDNS no</pre>
</div>
</div>
<div class="paragraph">
<p>This is, we want to uncomment the corresponding lines, and modify their values to the ones we want. If the line for the parameter we want does not exist already, we want to add it to the configuration file.</p>
</div>
<div class="paragraph">
<p>With this in mind, we can rewrite our earlier top-level configfiles() bundle to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># Files to edit</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sysctl]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/sysctl.conf&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files[sshd]</span><span class="tok-p">&quot;</span>   <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span><span class="tok-p">;</span>

      <span class="tok-c"># Sysctl variables to set</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.tcp_syncookies]</span><span class="tok-p">&quot;</span>               <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_source_route]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_redirects]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.rp_filter]</span><span class="tok-p">&quot;</span>           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.log_martians]</span><span class="tok-p">&quot;</span>        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>

      <span class="tok-c"># SSHD configuration to set</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[Protocol]</span><span class="tok-p">&quot;</span>                                <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[X11Forwarding]</span><span class="tok-p">&quot;</span>                           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;yes&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[UseDNS]</span><span class="tok-p">&quot;</span>                                  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;no&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;sysctl&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sysctl</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;sshd&quot;</span>    <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sshd</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that we added a second element to the files array, files[sshd], which contains the path of the <em>/etc/ssh/sshd_config</em> file. We have also added a new array called sshd, containing the parameters we want to set in the configuration file. Finally, in the <a href="http://cf-learn.info/ref/methods">methods:</a> section, we added a call to an edit_sshd() bundle, which performs the necessary edits. Note again the very clear separation that CFEngine allows in specifying <em>what to do</em> (the values of the parameters that we want to set) from <em>how to do it</em> (the methods: calls, and their respective implementations). Here is the new edit_sshd() bundle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">edit_sshd</span>
<span class="tok-p">{</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(configfiles.files[sshdconfig])</span><span class="tok-s">&quot;</span>   <b class="conum">(1)</b>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;edit_sshd&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Set desired sshd_config parameters&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_config_values</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.sshd&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;restart_sshd&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">restart_sshd.!no_restarts</span><span class="tok-p">::</span>   <b class="conum">(2)</b>
      <span class="tok-s">&quot;/etc/init.d/sshd reload&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;sshd_restart&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Restart sshd if the configuration file was modified&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">services</span><span class="tok-p">:</span>   <b class="conum">(3)</b>
      <span class="tok-s">&quot;ssh&quot;</span>
        <span class="tok-kr">service_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;start&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The edit_sshd() bundle is in general very similar to edit_sysctl(), but there are a few differences worth exploring.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Instead of calling the set_variable_values() bundle for editing the file (which is used to set lines of the form <code>variable=value</code>) we use the set_config_values() bundle, which is used to set lines of the form <code>variable value</code>, with the additional feature of automatically uncommenting lines if they exist already in commented-out form.</p>
</li>
<li>
<p>The edit_sshd() bundle also has a <a href="http://cf-learn.info/ref/commands"><code>commands:</code></a> section, which is used to restart the <em>sshd</em> daemon if the configuration file was changed. As before, we set the restart_sshd class if the file-editing promise was repaired (that is, if any changes were made to the file), and depending on this class, we issue the necessary command.</p>
</li>
<li>
<p>Independently of restarting the <em>sshd</em> daemon in case of file changes, we want to make sure that the daemon is running.  For this, we introduce a new type of promise called <a href="http://cf-learn.info/ref/services"><code>services:</code></a>, which offers us an abstraction for system services and allows us to declare that the <code>ssh</code> service needs to be running. Because <code>ssh</code> is a standard service, we can simply specify its desired state using the <a href="http://cf-learn.info/ref/service_policy"><code>service_policy</code></a> parameter.</p>
<div class="paragraph">
<p>By default, <a href="http://cf-learn.info/ref/services"><code>services:</code></a> promises call the standard_services() bundle defined in the standard library to actually handle the service operations. This bundle defines the information necessary for checking, starting and stopping a large number of common services, including SSH. If you need to handle some service that is not included in this bundle, you can either modify it to add support for it (don’t forget to submit a pull request so that the community can benefit from your additions!) or write your own service-handling bundles. For more details about <a href="http://cf-learn.info/ref/services"><code>services:</code></a> promises, please see <a href="#service-management">[service-management]</a>.</p>
</div>
<div class="paragraph">
<p>As it evolves, the standard_services() bundle may be able to dynamically manage unknown services without your having to explicitly declare them, but this is not fully implemented at the moment.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let us now look at the set_config_values() bundle, also defined in the standard library.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">edit_line</span> <span class="tok-nf">set_config_values</span><span class="tok-p">(</span><span class="tok-nv">v</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">index</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(v)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(1)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">cindex[$(index)]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">canonify</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
  <span class="tok-kd">replace_patterns</span><span class="tok-p">:</span> <b class="conum">(2)</b>
      <span class="tok-s">&quot;^</span><span class="tok-se">\s</span><span class="tok-s">*(</span><span class="tok-si">$(index)</span><span class="tok-se">\s</span><span class="tok-s">+(?!</span><span class="tok-si">$($(v)[$(index)])</span><span class="tok-s">).*|# ?</span><span class="tok-si">$(index)</span><span class="tok-se">\s</span><span class="tok-s">+.*)$&quot;</span>
        <span class="tok-kr">replace_with</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s"> </span><span class="tok-si">$($(v)[$(index)])</span><span class="tok-s">&quot;</span><span class="tok-p">),</span> <b class="conum">(3)</b>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">always</span><span class="tok-p">(</span><span class="tok-s">&quot;replace_attempted_</span><span class="tok-si">$(cindex[$(index)])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(4)</b>
  <span class="tok-kd">insert_lines</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s"> </span><span class="tok-si">$($(v)[$(index)])</span><span class="tok-s">&quot;</span> <b class="conum">(5)</b>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;replace_attempted_</span><span class="tok-si">$(cindex[$(index)])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle uses a completely different logic from set_variable_values(), even though it performs similar functions. This allows me to introduce you to a couple of new concepts and tricks.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The first part of the bundle is already familiar: it gets a list of
indices from the array passed to the bundle, stores it in index, and
uses it to populate cindex with the canonified versions of those
parameter names, to be used in class names later.</p>
</li>
<li>
<p>The actual line editing is done now by a <a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a> section instead of <a href="http://cf-learn.info/ref/field_edits"><code>field_edits:</code></a>, which allows for more flexible transformations. Promises of this type allow us to search for and replace regular expressions in the file.</p>
<div class="paragraph">
<p>The promiser in a <a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a> promise is the regular expression we want to match. In this case we are asking it to look for two types of lines, corresponding to the two regular expressions separated by a pipe character (<code>|</code>):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lines that start (<code>^</code>) with optional whitespace (<code>\s*</code>), followed by the current parameter name (<code>$(index)</code>) followed by whitespace (<code>\s+</code>) and any string that is not the correct value of the current parameter (<code>(?!$($(v)[$(index)])).*</code>). This represents lines that already set the parameter we are looking for, but with an incorrect value.</p>
</li>
<li>
<p>Lines that start (<code>^</code>) with optional whitespace (<code>\s*</code>), followed by a comment character and an optional space (<code># ?</code>), followed by the current parameter name (<code>$(index)</code>) followed by whitespace (<code>\s+</code>) and any arbitrary string. This represents lines that contain the parameter, but commented out.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Again, we are using implicit looping to iterate over all the parameters to be set, by using <code>$(index)</code> instead of <code>@(index)</code> in the promise.</p>
</div>
<div class="paragraph">
<p>The last part of the first regular expression is complicated because we need to find lines that do not contain the correct value already, and replace them. For this, we use a negative-lookahead expression (<code>(?!&#8230;&#8203;)</code>) that indicates that the text after the whitespace must not match the desired value (<code>(?!$($(v)[$(index)]))</code>). The final part (<code>.*</code>) is necessary to match the actual characters that follow the whitespace, because the whole negative-lookahead expression is zero-length, and does not “consume” any characters during the regex evaluation.</p>
</div>
</li>
<li>
<p>The <a href="http://cf-learn.info/ref/replace_with"><code>replace_with</code></a> attribute tells us what to use as the replacement. In this case, the replacement will be the current parameter and its desired value, separated by a space:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kr">replace_with</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(index)</span><span class="tok-s"> </span><span class="tok-si">$($(v)[$(index)])</span><span class="tok-s">&quot;</span><span class="tok-p">),</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://cf-learn.info/ref/value">value()</a> is another body that specifies the value and
characteristics of the replacement text. It is defined in the standard
library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">replace_with</span> <span class="tok-nf">value</span><span class="tok-p">(</span><span class="tok-nv">x</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">replace_value</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">occurrences</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;all&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>For reasons I will explain in a moment, we want to remember that the
<a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a> promise
has run, whether or not it actually found its pattern. So it ends by
setting the replace_attempted<em>_`parameter`</em> class using the
<a href="http://cf-learn.info/ref/classes"><code>classes</code></a> attribute with the
always() body part. The definition of the always() body part is also found in
the Standard Library:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">classes</span> <span class="tok-nf">always</span><span class="tok-p">(</span><span class="tok-nv">x</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">promise_repaired</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">promise_kept</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">repair_failed</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">repair_denied</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">repair_timeout</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(x)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The effect of using always() is that the class given as a parameter is
set for any of the conditions listed in it (<code>promise_repaired</code>,
<code>promise_kept</code>, <code>repair_failed</code>, <code>repair_denied</code> or <code>repair_timeout</code>).
These are all the possible outcomes of a promise in CFEngine, so the
net effect is to set the class regardless of what has happened.</p>
</div>
</li>
<li>
<p>Up to this point we have
dealt with parameters whose lines are already in the file (maybe
commented out), but we also need to insert parameters that do not yet
appear in the file. How to do this is a little tricky and
counter-intuitive, but it gives us an opportunity to learn more about
how CFEngine works.</p>
<div class="paragraph">
<p>As we saw in
<a href="../../book/chapter03/#normal-ordering">Normal Ordering</a>, promise sections in a CFEngine policy are executed
in a hard-coded sequence known as normal ordering. According to normal
ordering, the <a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a>
section is executed <em>before</em> the
<a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a>
section. This poses a problem in our current example because we want
to try to fix already-existing parameters (possibly commented out or
with incorrect values) <em>before</em> adding any new lines. If we let the
<a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> promise execute
first, we may end up with duplicated definitions of parameters in the
configuration file.</p>
</div>
<div class="paragraph">
<p>To alter the order of execution, we condition the execution of the
<a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> promise on the
existence of the <code>replace_attempted_</code>__parameter__ class defined when
the <a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a>
promise is evaluated. Because CFEngine does up to three passes over
the promises, this makes the
<a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines:</code></a> promise execute
only on the second pass, after the
<a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a> section
has had a chance to uncomment and correct any existing lines. If at
this point the line with the correct value <em>still</em> does not exist,
then inserting it is the correct behavior.</p>
</div>
</li>
</ol>
</div>
<div id="normal-ordering-in-edit_line-bundles" class="sidebarblock">
<div class="content">
<div class="title">Normal Ordering in edit_line Bundles</div>
<div class="paragraph">
<p>Within
<a href="http://cf-learn.info/ref/edit_line"><code>edit_line</code></a> bundles, the sections
are executed, up to three times, in the following order:
<a href="http://cf-learn.info/ref/vars"><code>vars</code></a>,
<a href="http://cf-learn.info/ref/classes"><code>classes</code></a>,
<a href="http://cf-learn.info/ref/delete_lines"><code>delete_lines</code></a>,
<a href="http://cf-learn.info/ref/field_edits"><code>field_edits</code></a>,
<a href="http://cf-learn.info/ref/insert_lines"><code>insert_lines</code></a>,
<a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns</code></a> and
<a href="http://cf-learn.info/ref/reports"><code>reports</code></a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>I know this can be confusing, so here is an example to clarify it. Suppose that our <em>/etc/ssh/sshd_config</em> file contains the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#Protocol 1,2</pre>
</div>
</div>
<div class="paragraph">
<p>The behavior of the set_config_values() bundle will be the following (assuming $(index) currently has the value "Protocol"):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>(First pass) The <a href="http://cf-learn.info/ref/insert_lines">insert_lines:</a> promise for "Protocol 2" is not executed because the replace_attempted_protocol class is not defined. Note that the class name contains the <em>canonified</em> version of the parameter name, which includes making it all lowercase.</p>
</li>
<li>
<p>(First pass) The <a href="http://cf-learn.info/ref/replace_patterns">replace_patterns:</a> promise replaces the original line with its uncommented, correct value, and defines the replace_attempted_protocol class:</p>
<div class="listingblock">
<div class="content">
<pre>Protocol 2</pre>
</div>
</div>
</li>
<li>
<p>(Second pass) The <a href="http://cf-learn.info/ref/insert_lines">insert_lines</a> promise now executes, but because the correct line is already present in the file, it is not inserted again.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now consider the case when the commented-out "Protocol" line is not present at all in the file. Then the flow would be the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>(First pass) The <a href="http://cf-learn.info/ref/insert_lines">insert_lines</a> promise for "Protocol 2" is not executed because the replace_attempted_protocol class is not defined.</p>
</li>
<li>
<p>(First pass) The <a href="http://cf-learn.info/ref/replace_patterns">replace_patterns</a> promise is executed but does not succeed because the line does not exist. It defines the replace_attempted_protocol class anyway, due to the use of the always() body.</p>
</li>
<li>
<p>(Second pass) The <a href="http://cf-learn.info/ref/insert_lines">insert_lines</a> promise now executes, and because the line "Protocol 2" does not exist in the file, it is inserted.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In both cases, the end result is the same: to set the Protocol parameter to its correct value. It is important to note that our previously-examined set_variable_values() bundle could trivially be rewritten using the same technique used by set_config_values(), which would add the functionality of allowing it to handle commented-out lines properly.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note that the example we saw in this section assumes each parameter can only appear once in the file. This assumption does not hold true if the file contains “Match” blocks, which allow specifying conditional configuration values. In the interest of clarity I have considered only the simplest example in the book. For the full functionality, please see the <a href="https://github.com/cfengine/design-center/tree/master/sketches/networking/ssh"><code>networking/ssh</code> sketch in the CFEngine Design Center</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="editing-etcinittab">Editing /etc/inittab</h4>
<div class="paragraph">
<p>Another common initial task when setting up a Unix or Linux system is to customize <em>/etc/inittab</em>. For our example, we will do the following tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the default runlevel from 5 to 3, to disable graphical login by default (this is commonly done on Linux servers, to prevent wasting resources on an unused graphical console).</p>
</li>
<li>
<p>Disable Ctrl-Alt-Del handling, to prevent this key combination from rebooting the system.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To achieve the first task, we need to modify the second field in the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>id:5:initdefault:</pre>
</div>
</div>
<div class="paragraph">
<p>This is a fairly simple task, now that you understand the previous editing tasks we have done. Here is the promise that achieves it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">files</span><span class="tok-p">:</span> <b class="conum">(1)</b>
      <span class="tok-s">&quot;/etc/inittab&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;inittab_set_initdefault&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Ensure graphical mode is disabled (default runmode=3)&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">create</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_timestamp</span><span class="tok-p">,</span> <b class="conum">(2)</b>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_colon_field</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;2&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;3&quot;</span><span class="tok-p">);</span> <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is a <a href="http://cf-learn.info/ref/files"><code>files:</code></a> promise that
indicates the file to edit, and states that the file must not be
created (<code>"create" &#8658; "false"</code>) if it does not exist already, since
<em>/etc/inittab</em> should always exist in a Unix system.</p>
</li>
<li>
<p>The <a href="http://cf-learn.info/ref/edit_defaults"><code>edit_defaults</code></a> attribute
specifies the behavior for the file-editing operation. The definition
of backup_timestamp can be found in the standard library:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">edit_defaults</span> <span class="tok-nf">backup_timestamp</span>
<span class="tok-p">{</span>
        <span class="tok-kr">empty_file_before_editing</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">edit_backup</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;timestamp&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">max_file_size</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;300000&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This states that the file should not be emptied before editing (you
can set this to true when the promise will recreate the file in its
entirety), that a copy of the old version should be kept, named with a
timestamp at the end (this allows you to keep a history of the file,
and is particularly advisable for critical system files, so that you
can quickly revert any changes if problems arise), and that the file
should not be more than 300,000 bytes in size (this is simply a sanity
check to ensure that files do not grow beyond normal limits).</p>
</div>
<div class="paragraph">
<p>You will notice that we had omitted the
<a href="http://cf-learn.info/ref/edit_defaults"><code>edit_defaults</code></a> attribute in
our previous file-editing promises. This is valid and provides sane
default behavior. We use
<a href="http://cf-learn.info/ref/edit_defaults"><code>edit_defaults</code></a> now in
particular because it is a good idea to keep backup copies of the
<em>/etc/inittab</em> file in case anything goes wrong.</p>
</div>
<div class="paragraph">
<p>The backup files are by default stored in the same directory as the
original file. You can modify this behavior to store them under a
separate directory by using the
<a href="http://cfengine.com/docs/3.5/reference-promise-types-files.html#repository"><code>repository</code></a>
attribute for a single <a href="http://cf-learn.info/ref/files"><code>files:</code></a>
promise, or the
<a href="http://cf-learn.info/ref/default_repository"><code>default_repository</code></a>
option in <code>body agent control</code> to use it throughout the entire policy.</p>
</div>
</li>
<li>
<p>The actual editing of <em>/etc/inittab</em>
is done by the standard library <code>set_colon_field()</code> bundle, which allows
us to edit fields in a colon-separated file. Here is its definition:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">edit_line</span> <span class="tok-nf">set_colon_field</span><span class="tok-p">(</span><span class="tok-nv">key</span><span class="tok-p">,</span><span class="tok-nv">field</span><span class="tok-p">,</span><span class="tok-nv">val</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">field_edits</span><span class="tok-p">:</span>
    <span class="tok-s">&quot;</span><span class="tok-si">$(key)</span><span class="tok-s">:.*&quot;</span>
      <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Edit colon-separated file, using first field as a key&quot;</span><span class="tok-p">,</span>
      <span class="tok-kr">edit_field</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">col</span><span class="tok-p">(</span><span class="tok-s">&quot;:&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;</span><span class="tok-si">$(field)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;</span><span class="tok-si">$(val)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;set&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle uses the same
lower-level col() body we employed in <a href="../../book/chapter04/#editing-sysctl.conf">Editing /etc/sysctl.conf</a>, only this
time using the colon as a separator to set the appropriate field to
the value we provide. As used in our promise, col() results in the
second field of the line whose first field is <code>"id"</code> to be set to
<code>"3"</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To achieve the second task, we need to comment out the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ca::ctrlaltdel:/sbin/shutdown -r -t 4 now</pre>
</div>
</div>
<div class="paragraph">
<p>We can use the following promise to achieve this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/etc/inittab&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;inittab_disable_ctrlaltdel&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Ensure handling of ctrl-alt-del is disabled&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">create</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_timestamp</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">comment_lines_matching</span><span class="tok-p">(</span><span class="tok-s">&quot;ca::ctrlaltdel:.*&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;#&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the actual work in this promise is performed by the <a href="http://cf-learn.info/ref/edit_line">edit_line</a> attribute, which in this case calls the comment_lines_matching() bundle. This standard library bundle is used to insert a comment character (given as the second argument, in this case "#") at the beginning of any line that matches the first argument. Here is its definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">edit_line</span> <span class="tok-nf">comment_lines_matching</span><span class="tok-p">(</span><span class="tok-nv">regex</span><span class="tok-p">,</span><span class="tok-nv">comment</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">replace_patterns</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;^(</span><span class="tok-si">$(regex)</span><span class="tok-s">)$&quot;</span>
        <span class="tok-kr">replace_with</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">comment</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(comment)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Search and replace string&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It consists, as you might have expected, of a simple <a href="http://cf-learn.info/ref/replace_patterns">replace_patterns:</a> promise. The replacement string is defined by the <a href="http://cf-learn.info/ref/comment">comment</a> body definition, which is also in the standard library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">replace_with</span> <span class="tok-nf">comment</span><span class="tok-p">(</span><span class="tok-nv">c</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">replace_value</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(c)</span><span class="tok-s"> </span><span class="tok-si">$(match.1)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">occurrences</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;all&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the replace_value attribute, $(c) is the comment string we passed as an argument, and $(match.1) refers to the content of the first set of parenthesis in the regular expression used to select the line. If you look back in the comment_lines_matching() bundle, you’ll see that the regular expression is given as "^($(regex))$", which has grouping parenthesis that capture the whole matched line. This results in the matching line being replaced by the comment character, followed by a space, and then the previous content of the line.</p>
</div>
<div class="paragraph">
<p>Putting it all together, and extending our previous configfiles() bundle to handle editing the <em>/etc/inittab</em> file, we get the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-c"># Files to edit</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">files[sysctl]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/sysctl.conf&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">files[sshd]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">files[inittab]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/inittab&quot;</span><span class="tok-p">;</span>

   <span class="tok-c"># Sysctl variables to set</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.tcp_syncookies]</span><span class="tok-p">&quot;</span>               <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_source_route]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0 &quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.accept_redirects]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.rp_filter]</span><span class="tok-p">&quot;</span>           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sysctl[net.ipv4.conf.all.log_martians]</span><span class="tok-p">&quot;</span>        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>

   <span class="tok-c"># SSHD configuration to set</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sshd[Protocol]</span><span class="tok-p">&quot;</span>                                <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sshd[X11Forwarding]</span><span class="tok-p">&quot;</span>                           <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;yes&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">sshd[UseDNS]</span><span class="tok-p">&quot;</span>                                  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;no&quot;</span><span class="tok-p">;</span>

 <span class="tok-kd">methods</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;sysctl&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sysctl</span><span class="tok-p">;</span>
   <span class="tok-s">&quot;sshd&quot;</span>    <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_sshd</span><span class="tok-p">;</span>
   <span class="tok-s">&quot;inittab&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_inittab</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">edit_inittab</span>
<span class="tok-p">{</span>
 <span class="tok-kd">files</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;</span><span class="tok-si">$(configfiles.files[inittab])</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;inittab_set_initdefault&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Ensure graphical mode is disabled (runmode=3)&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_timestamp</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_colon_field</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;2&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;3&quot;</span><span class="tok-p">);</span>

   <span class="tok-s">&quot;</span><span class="tok-si">$(configfiles.files[inittab])</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;inittab_disable_ctrlaltdel&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Ensure handling of ctrl-alt-del is disabled&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_timestamp</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">comment_lines_matching</span><span class="tok-p">(</span><span class="tok-s">&quot;ca::ctrlaltdel:.*&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;#&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we have simply moved the filename into the files array that we have been using, and added the call to edit_inittab() to the <a href="http://cf-learn.info/ref/methods">methods:</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration-files-with-variable-content">Configuration Files with Variable Content</h4>
<div class="paragraph">
<p>So far, we have been making fixed changes to configuration files, which is helpful enough, but CFEngine is able to handle much more complex situations. In a real network not all systems are the same, and you have a mixture of operating systems, releases, and parameters that affect how each machine should be configured. Handling these almost-the-same-but-slightly-different configurations by hand is a certain recipe for disaster: eventually, someone will lose track of the changes that have to be made, forget to make certain changes, or make the wrong set of changes, and a system will stop working. With CFEngine, these configurations can be made consistently and without errors.</p>
</div>
<div class="sect4">
<h5 id="class-based-configuration">Class-based configuration</h5>
<div class="paragraph">
<p>CFEngine automatically discovers a large amount of information about the system and its current state and sets classes based on them. These are called hard classes in CFEngine terminology because they are set by CFEngine based on system characteristics; they are different from <em>soft classes</em>, which are set by the policy during its execution. Using hard classes, we can instruct CFEngine to act differently depending on characteristics of each system or of the moment when CFEngine is executed.</p>
</div>
<div class="paragraph">
<p>To know which classes are discovered by CFEngine, we can use the <a href="http://cf-learn.info/ref/cf-promises">cf-promises</a> command like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-promises -v <span class="tok-p">|</span> grep classes
<span class="tok-go">2013-10-04T04:31:00+0000  verbose: Discovered hard classes: 10_0_2_15</span>
<span class="tok-go">127_0_0_1 2_cpus 64_bit Day4 Friday GMT_Hr4 Hr04 Hr04_Q3 Lcycle_0</span>
<span class="tok-go">Min30_35 Min31 Night October PK_MD5_0b595fd7ffc16e9bda575402bd2048de</span>
<span class="tok-go">Q3 Yr2013 any cfengine cfengine_3 cfengine_3_5 cfengine_3_5_2</span>
<span class="tok-go">common community_edition compiled_on_linux_gnu debian debian_wheezy</span>
<span class="tok-go">fe80__a00_27ff_fefe_aaaf have_aptitude inform_mode ipv4_10 ipv4_10_0</span>
<span class="tok-go">ipv4_10_0_2 ipv4_10_0_2_15 ipv4_127 ipv4_127_0 ipv4_127_0_0 ipv4_127_0_0_1</span>
<span class="tok-go">linux linux_3_2_0_23_generic linux_x86_64 linux_x86_64_3_2_0_23_generic</span>
<span class="tok-go">linux_x86_64_3_2_0_23_generic__36_Ubuntu_SMP_Tue_Apr_10_20_39_51_UTC_2012</span>
<span class="tok-go">localhost mac_08_00_27_fe_aa_af net_iface_eth0 net_iface_lo somehost</span>
<span class="tok-go">somehost_cfengine_com ubuntu ubuntu_12 ubuntu_12_4 verbose_mode x86_64</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The community-contributed tool <a href="https://github.com/cfengine/design-center/tree/master/tools/hcgrep">hcgrep</a> allows you to easily search and display hard classes defined by CFEngine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let’s look at some of these classes and what the names tell us:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Time information is given by classes such as Day4 (4th of the month), Friday, Hr04 (4AM), Min30_35 (it’s between 3:30 and 3:35), Hr04_Q3 and Q3 (the current quarter-hour), Night (it’s at night, or more precisely, between 00-06 hours), October, Yr2013, Lcycle_0 (this is a “lifecycle index” defined as the year modulo 3, and which can be used for long-term scheduling). All times are expressed in the local system timezone except for GMT_Hr4.</p>
</li>
<li>
<p>Network information is given by classes such as 10_0_2_15 (the host’s IP address), ipv4_10, ipv4_10_0, ipv4_10_0_2, ipv4_10_0_2_15 (the different portions of the IP address), net_iface_eth0 and net_iface_lo (the network interfaces defined in the system).</p>
</li>
<li>
<p>System information is given by classes such as somehost (the host name), somehost_cfengine_com (its FQDN, with the periods replaced by underscores since classnames cannot contain periods), linux, ubuntu, ubuntu_12 (operating system type and, in this case, Linux distribution information), x86_64 (system architecture), and linux_3_2_0_23_generic (Linux kernel version and build information).</p>
</li>
<li>
<p>CFEngine information is given by classes such as cfengine_3, cfengine_3_5, cfengine_3_5_2 (version number), community_edition (indicating that this host is running the CFEngine Community edition), PK_MD5_0b59... (the cryptographic signature of the host’s CFEngine-generated public key, which can be used to uniquely identify the system), and verbose_mode (which tells us CFEngine was run with the -v option, so you could tie your own verbose output to the use of this option).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note that all strings that contain periods or other special characters (e.g. IP addresses, host names, etc.) have those characters replaced by underscores when converted to classnames. You can perform this conversion on any string to get a valid class name by using the <a href="http://cf-learn.info/ref/canonify">canonify()</a> function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hard classes allow a great deal of flexibility in writing configurations by offering very detailed information based on which you can perform configuration actions. Of course, you can also define your own classes in policy to identify any arbitrary conditions you need.</p>
</div>
<div class="paragraph">
<p>As an example, you could use the system type to decide which command to use for a certain task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">reboot</span>
<span class="tok-p">{</span>
  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">linux</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/sbin/shutdown -r now&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">windows</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;c:/Windows/system32/shutdown.exe /r /t 01&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that in CFEngine, lines that end with a double colon are interpreted as <em>class expressions</em>, which indicate that the lines that follow should be evaluated only if the expression evaluates to true. In this case the selection is very simple: we use one command for rebooting Linux systems, and a different one for Windows machines, using the hard classes linux and windows as class expressions.</p>
</div>
<div class="paragraph">
<p>We can also combine classes in more complex expressions. Extending our previous example, we could use the <em>and</em> (. or &amp;) operator to condition a reboot on both the existence of the reboot_needed class and the corresponding operating-system class. Additionally, we can produce an error if the machine is <em>not</em> (!) Linux <em>and</em> (.) <em>not</em> (!) Windows (we can use parenthesis for grouping parts of the expression):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">reboot</span>
<span class="tok-p">{</span>
  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">reboot_needed.linux</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/sbin/shutdown -r now&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">reboot_needed.windows</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;c:/Windows/system32/shutdown.exe /r /t 01&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">reboot_needed.!(linux|windows)</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;I know how to reboot only Linux and Windows machines.&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Time-based classes can be used to emulate cron-like behavior using CFEngine. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">cron_tasks</span>
<span class="tok-p">{</span>
  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-c"># Commands to run hourly between minute 00-05</span>
    <span class="tok-nc">Min00_05</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/usr/sbin/updatedb&quot;</span><span class="tok-p">;</span>
    <span class="tok-c"># Commands to run during hours 00 and 03</span>
    <span class="tok-nc">Hr00</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/usr/local/sbin/logrotate&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;/usr/sbin/tmpclean&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">Hr03</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/usr/local/sbin/run_backups&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">Monday</span><span class="tok-p">::</span>     <span class="tok-c"># Commands to run during Monday</span>
      <span class="tok-s">&quot;/usr/sbin/usercheck&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">Lcycle_0.March</span><span class="tok-p">::</span>   <span class="tok-c"># Commands to run during March every four years</span>
      <span class="tok-s">&quot;/usr/sbin/random_catastrophic_failure&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note that a command (and in general any promise) will execute every time CFEngine runs, as long as its class conditions are true. So the class expression Hr03 means that the /usr/local/sbin/run_backups command will be executed all hour long during 3AM, every time CFEngine runs (by default every 5 minutes). Be mindful to design your class expressions according to what you need. You can configure how often a single promise will be evaluated using the <a href="http://cf-learn.info/ref/ifelapsed">ifelapsed</a> attribute.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In a bundle like this, you can define any number of tasks to execute. The other big advantage is that using CFEngine as a cron replacement allows you to schedule not only commands and shell scripts, but also arbitrary CFEngine promises, which you can use to perform more complex tasks than you could using cron alone.</p>
</div>
<div class="paragraph">
<p>System-information classes allow you to perform different tasks depending on the system state or configuration. For example, you could easily create different network profiles using CFEngine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">network_profiles</span>
<span class="tok-p">{</span>
  <span class="tok-kd">methods</span><span class="tok-p">:</span>
    <span class="tok-c"># At home, 192.168.23.0/24, start my backup</span>
    <span class="tok-nc">ipv4_192_168_23</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;openservices&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">openservices</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;dobackup&quot;</span>     <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;printer&quot;</span>      <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">configure_printer</span><span class="tok-p">(</span><span class="tok-s">&quot;home&quot;</span><span class="tok-p">);</span>
    <span class="tok-c"># At work, 9.4.0.0/16, configure the appropriate printers</span>
    <span class="tok-nc">ipv4_9_4</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;openservices&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">openservices</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;printer&quot;</span>      <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">configure_printer</span><span class="tok-p">(</span><span class="tok-s">&quot;work&quot;</span><span class="tok-p">);</span>
    <span class="tok-c"># Anywhere else, close some services for additional protection</span>
    <span class="tok-nc">!(ipv4_192_168_23|ipv4_9_4)</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;closeservices&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">closeservices</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we are modifying system settings (through bundles we are calling using <a href="http://cf-learn.info/ref/methods">methods:</a> promises) based on the IP address range in which the system is currently configured. The possibilities are endless.</p>
</div>
</div>
<div class="sect4">
<h5 id="system-state-based-configuration">System-state-based configuration</h5>
<div class="paragraph">
<p>Another, even more flexible, way of configuring a system involves using its current state to determine the desired end state, making the policy fully dynamic depending on each particular system.</p>
</div>
<div class="paragraph">
<p>In one of my projects, we had a large number of Linux machines with two network interfaces, one of them connected to the production network (which we called the “green” network) and the other one to the management network (called the “black” network). Due to the characteristics of the networking infrastructure, we had to disable the TSO flag (TCP Segmentation Offload) on the interfaces that were on the green network. In my first attempt at automating this, I observed that the green interface was always eth0 (these were all Linux systems), and hard-coded the CFEngine configuration to add the following line to <em>/etc/inittab</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tso:3:once:/usr/sbin/ethtool -K eth0 tso off</pre>
</div>
</div>
<div class="paragraph">
<p>This results in the ethtool command being run upon system boot to disable this flag. The policy to achieve this is very similar to the ones we have seen before, so I will not show its exact implementation.</p>
</div>
<div class="paragraph">
<p>This worked fine… until exceptions started to appear: systems in which the green interface was not necessarily eth0. Then the rules had to adapt, and with CFEngine this was fairly simple to accomplish.</p>
</div>
<div class="paragraph">
<p>In this particular case, the two networks could be easily identified by their IP address ranges. The green network was in the 192.168.0.0/16 range, and the black network was in the 10.10.0.0/16 range. With this piece of information, I was able to modify the policy so that the correct interface is used in the ethtool command. Here is the complete bundle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">disable_tso_flag</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">ipregex</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;192</span><span class="tok-se">\.</span><span class="tok-s">168</span><span class="tok-se">\.</span><span class="tok-s">.*&quot;</span><span class="tok-p">;</span> <b class="conum">(1)</b>
   <span class="tok-p">&quot;</span><span class="tok-nv">nics</span><span class="tok-p">&quot;</span>    <span class="tok-kt">slist</span>  <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;sys.ipv4&quot;</span><span class="tok-p">);</span>

 <span class="tok-kd">classes</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;isgreen_</span><span class="tok-si">$(nics)</span><span class="tok-s">&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">regcmp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(ipregex)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                                          <span class="tok-s">&quot;</span><span class="tok-si">$(sys.ipv4[$(nics)])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(2)</b>

 <span class="tok-kd">files</span><span class="tok-p">:</span> <b class="conum">(3)</b>
   <span class="tok-s">&quot;</span><span class="tok-si">$(configfiles.files[inittab])</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;inittab_add_ethtool&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Ensure ethtool is run on startup to disable the TSO flag&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">edit_backup</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">replace_or_add</span><span class="tok-p">(</span><span class="tok-s">&quot;tso:3:.*&quot;</span><span class="tok-p">,</span> <b class="conum">(4)</b>
                                 <span class="tok-s">&quot;tso:3:once:/usr/sbin/ethtool -K </span><span class="tok-si">$(nics)</span><span class="tok-s"> tso off&quot;</span><span class="tok-p">),</span>
     <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;isgreen_</span><span class="tok-si">$(nics)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle is meant to be incorporated into the main policy that we have been developing throughout this chapter, since it refers to the configfiles() bundle. Let’s examine it in more detail.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First, we assign to the $(ipregex) variable the regular expression to select the interfaces we want (the green ones, in this case). Next, we store in the @(nics) list the indices of the special CFEngine array sys.ipv4. This is a special variable created by CFEngine that contains all the IP addresses configured in the system, indexed by interface name. Therefore, <code>getindices("sys.ipv4")</code> gives us a list of all the network interfaces on the system.</p>
</li>
<li>
<p>Once we have this list, we again make use of CFEngine’s implicit looping to assign a number of classes named <code>isgreen_</code>__ifname__, where __ifname__ represents each of the network interfaces on the system. Each class is true if the IP address of said interface, given by the value <code>"$(sys.ipv4[$(nics)])"</code> matches $(ipregex) (remember that <code>$(nics)</code> is set to each of the interface names in turn). So, for example, if the system has the following network interfaces:</p>
<div class="ulist">
<ul>
<li>
<p>eth0: 9.4.21.16</p>
</li>
<li>
<p>eth1: 189.177.231.225</p>
</li>
<li>
<p>eth2: 192.168.13.56</p>
</li>
<li>
<p>eth3: 10.10.54.25</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>then the evaluation of the classes will be as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>isgreen_eth0: unset</p>
</li>
<li>
<p>isgreen_eth1: unset</p>
</li>
<li>
<p>isgreen_eth2: <strong>set</strong></p>
</li>
<li>
<p>isgreen_eth3: unset</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This tells us exactly which interface is the one we need to use in the
<em>ethtool</em> command.</p>
</div>
</li>
<li>
<p>Armed with this knowledge, we can proceed to the <a href="http://cf-learn.info/ref/files"><code>files:</code></a> promise, which adds to <code>/etc/inittab</code> the line that executes the <em>ethtool</em> command. This command contains the interface name as given by the $(nics) variable (implicit looping in action again), <em>only</em> if the corresponding isgreen_<em>ifname</em> class is set, as indicated by the <code>ifvarclass &#8658; "isgreen_$(nics)"</code> clause in the promise.</p>
</li>
<li>
<p>To actually append the line we use another bundle from standard library called replace_or_add that does the following: if a line matches the regular expression given by the first argument, it is replaced in its entirety by the second argument.  If no match is found, the line given in the second argument is added to the file. The <code>replace_or_add</code> bundle is very simple. It uses the same trick as the <code>set_config_values</code> bundle we discussed before (setting a class unconditionally upon execution of the <a href="http://cf-learn.info/ref/replace_patterns"><code>replace_patterns:</code></a> promise) to achieve the desired operation:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">edit_line</span> <span class="tok-nf">replace_or_add</span><span class="tok-p">(</span><span class="tok-nv">pattern</span><span class="tok-p">,</span><span class="tok-nv">line</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">cline</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">canonify</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(line)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
  <span class="tok-kd">replace_patterns</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;^(?!</span><span class="tok-si">$(line)</span><span class="tok-s">$)</span><span class="tok-si">$(pattern)</span><span class="tok-s">$&quot;</span>
        <span class="tok-kr">replace_with</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(line)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">always</span><span class="tok-p">(</span><span class="tok-s">&quot;replace_done_</span><span class="tok-si">$(cline)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
  <span class="tok-kd">insert_lines</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(line)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;replace_done_</span><span class="tok-si">$(cline)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>It pays to know the built-in <a href="http://cf-learn.info/ref/hard-classes">classes</a>, <a href="http://cf-learn.info/ref/special-variables">variables</a> and <a href="http://cf-learn.info/ref/special-functions">functions</a> in CFEngine, since they help achieve most necessary processing and data extraction tasks. I would strongly encourage you to read through the corresponding sections in the reference manual to get familiar at least in general terms with the available functionality.</p>
</div>
<div class="paragraph">
<p>We have described the use of CFEngine’s implicit looping several times. This concept isn’t found in most programming languages, so it can be hard to wrap your head around it at the beginning. Once you get the hang of it, you will realize that it can save many lines of flow-control code that would be necessary in other languages, and whose absence in CFEngine allows you to focus on writing the policy. In fact, CFEngine goes out of its way to <em>prevent</em> you from worrying about the flow of execution in a policy, using concepts such as implicit looping and normal ordering to determine how things are executed.</p>
</div>
<div class="paragraph">
<p>It is a natural tendency at the beginning to fight this level of automation, but true CFEngine mastery lies in letting go of the urge to control everything down to the last detail, and using CFEngine the way it is meant to be used. Tell CFEngine what you want and how to do it, and let CFEngine worry about details like the order in which operations will be executed.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="user-management">User Management</h3>
<div class="paragraph">
<p>One of the basic tasks of any system administrator is to control user accounts. Whether they are local accounts or centralized accounts using some network-wide mechanism such as LDAP, CFEngine gives you the exact control you need.</p>
</div>
<div class="paragraph">
<p>From a high-level perspective, the definition of user accounts may be expressed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">manage_users</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-c"># Users to create</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][fullname]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;System administrator&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][uid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][gid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][home]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/root&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][shell]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/bin/bash&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][flags]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;-o -m&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][password]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;FkDMzhB1WnOp2&quot;</span><span class="tok-p">;</span>

   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][fullname]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Diego Zamboni&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][uid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;501&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][gid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;users&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][home]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/home/zamboni&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][shell]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/bin/bash&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][flags]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;-m&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][password]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;dk52ia209rfuh&quot;</span><span class="tok-p">;</span>

 <span class="tok-kd">methods</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;users&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">create_users</span><span class="tok-p">(</span><span class="tok-s">&quot;manage_users.users&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example stores the user characteristics in a two-dimensional array indexed by username and by the different fields of each user record. The create_users() bundle is called from the <a href="http://cf-learn.info/ref/methods">methods:</a> section of the policy, passing the configuration array as an argument. Here is the create_users() bundle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">create_users</span><span class="tok-p">(</span><span class="tok-nv">info</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">user</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(info)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(1)</b>

 <span class="tok-kd">classes</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;add_</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span> <span class="tok-kr">not</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">userexists</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(2)</b>

 <span class="tok-kd">commands</span><span class="tok-p">:</span> <b class="conum">(3)</b>
  <span class="tok-nc">linux</span><span class="tok-p">::</span>
   <span class="tok-s">&quot;/usr/sbin/useradd </span><span class="tok-si">$($(info)[$(user)][flags])</span><span class="tok-s"> -u </span><span class="tok-si">$($(info)[$(user)][uid])</span><span class="tok-s"></span>
<span class="tok-s">       -g </span><span class="tok-si">$($(info)[$(user)][gid])</span><span class="tok-s"> -d </span><span class="tok-si">$($(info)[$(user)][home])</span><span class="tok-s"></span>
<span class="tok-s">       -s </span><span class="tok-si">$($(info)[$(user)][shell])</span><span class="tok-s"> -c &#39;</span><span class="tok-si">$($(info)[$(user)][fullname])</span><span class="tok-s">&#39; </span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;add_</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">windows</span><span class="tok-p">::</span>
   <span class="tok-s">&quot;c:/Windows/system32/net user </span><span class="tok-si">$(user)</span><span class="tok-s"> </span><span class="tok-si">$($(info)[$(user)][password])</span><span class="tok-s"> /add</span>
<span class="tok-s">       </span><span class="tok-se">\&quot;</span><span class="tok-s">/fullname:</span><span class="tok-si">$($(info)[$(user)][fullname])</span><span class="tok-se">\&quot;</span><span class="tok-s"></span>
<span class="tok-s">       </span><span class="tok-se">\&quot;</span><span class="tok-s">/homedir:</span><span class="tok-si">$($(info)[$(user)][home])</span><span class="tok-se">\&quot;</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;add_</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
   <span class="tok-c"># On Windows we use a command to set the password</span>
   <span class="tok-c"># unconditionally in case it has changed.</span>
   <span class="tok-s">&quot;c:/Windows/system32/net user </span><span class="tok-si">$(user)</span><span class="tok-s"> </span><span class="tok-si">$($(info)[$(user)][password])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span> <b class="conum">(4)</b>

 <span class="tok-kd">files</span><span class="tok-p">:</span>
  <span class="tok-nc">linux</span><span class="tok-p">::</span>
   <span class="tok-c"># This is not conditioned to the add_* classes</span>
   <span class="tok-c"># to always check and reset the passwords if needed.</span>
   <span class="tok-s">&quot;/etc/shadow&quot;</span> <b class="conum">(5)</b>
     <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_user_field</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
                                 <span class="tok-s">&quot;</span><span class="tok-si">$($(info)[$(user)][password])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

 <span class="tok-kd">reports</span><span class="tok-p">:</span> <b class="conum">(6)</b>
  <span class="tok-nc">!linux.!windows</span><span class="tok-p">::</span>
   <span class="tok-s">&quot;I only know how to create users under Linux and Windows.&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">verbose_mode</span><span class="tok-p">::</span>
   <span class="tok-s">&quot;Created user </span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;add_</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This particular implementation of create_users() handles only local user accounts, both on Linux and on Windows.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In the <a href="http://cf-learn.info/ref/vars"><code>vars:</code></a> section, we store in <code>@(user)</code> a list of the user accounts to check (the top-level indices of the configuration array) using the <a href="http://cf-learn.info/ref/getindices">getindices()</a> function. This list is used through CFEngine&#8217;s implicit looping to apply the rest of the bundle to each of those accounts.</p>
</li>
<li>
<p>The
<a href="http://cf-learn.info/ref/classes"><code>classes:</code></a> section defines a class
named add_<em>username</em> for each user account that does not exist, by
using the built-in <a href="http://cf-learn.info/ref/userexists">userexists()</a>
function to check for the existence of each user in turn.</p>
<div class="paragraph">
<p>The <a href="http://cf-learn.info/ref/userexists">userexists()</a> function does
not return valid results on Windows when using the community edition
of CFEngine, but it does work properly if you are using one of the
commercial editions. Proper Windows support is one of the benefits of
the commercial versions of CFEngine.</p>
</div>
<div class="paragraph">
<p>Note that we are using implicit looping again, but this time the
variable <code>$(user)</code> is being used in two places: as part of the
classname, and as argument to the
<a href="http://cf-learn.info/ref/userexists">userexists()</a> function.</p>
</div>
</li>
<li>
<p>The <a href="http://cf-learn.info/ref/commands"><code>commands:</code></a> section is divided
by operating systems, using the predefined OS-type hard classes
provided by CFEngine. Here, we issue the necessary command-line
instructions to create the users, but only if the user does not exist
already. This is controlled by the
<a href="http://cf-learn.info/ref/ifvarclass"><code>ifvarclass</code></a> attribute added to
each command promise, which makes the statement execute only if the
given class expression is true.</p>
<div class="paragraph">
<p>Note that the other account attributes (other than the password, see
below) are not verified for accuracy, in this version of the bundle.
If the account exists already, the promise is considered as satisfied.</p>
</div>
</li>
<li>
<p>Since we also want to enforce the passwords for each account, we have
to make sure the passwords are checked and, if needed, changed every
time.</p>
<div class="paragraph">
<p>In the case of Windows, we issue the command to reset the password to
its desired value every time the policy runs. This is done from the
<a href="http://cf-learn.info/ref/commands"><code>commands:</code></a> section. (In this case,
the password has to be given in clear text in the users array.)</p>
</div>
</li>
<li>
<p>For Linux, we reset user passwords in the
<a href="http://cf-learn.info/ref/files"><code>files:</code></a> section, by directly editing
the <em>/etc/shadow</em> file to set the password field to the value given in
the user matrix (this value has to be desired password, already
encoded using the <code>crypt()</code> function appropriate for the operating
system). The <code>set_user_field()</code> bundle
can be found in the standard library, and is very similar to the
<code>set_colon_field()</code> function I described before.</p>
</li>
<li>
<p>Finally, the <a href="http://cf-learn.info/ref/reports"><code>reports:</code></a> section
produces a report for each user that was created, if verbose mode is
enabled (the verbose_mode class is automatically set when the <code>-v</code>
command-line option is given to <em>cf-agent</em>), and also an error if we
are running on an unsupported system.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The call to manage_users() could be easily integrated into the overarching configfiles() bundle we have been building, by adding one more line to the <a href="http://cf-learn.info/ref/methods">methods:</a> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-s">&quot;users&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">manage_users</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make things easier to manage, we could also get rid of manage_users() entirely, move the definition of the user accounts from the manage_users() bundle to the configfiles() bundle, where all our other user-configurable variables are being set, and call create_users() directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">configfiles</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-err">...</span>
   <span class="tok-c"># Users to create</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][fullname]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;System administrator&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][uid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][gid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][home]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/root&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][shell]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/bin/bash&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][flags]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;-o -m&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[root][password]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;FkDMzhB1WnOp2&quot;</span><span class="tok-p">;</span>

   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][fullname]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Diego Zamboni&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][uid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;501&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][gid]</span><span class="tok-p">&quot;</span>      <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;users&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][home]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/home/zamboni&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][shell]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/bin/bash&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][flags]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;-m&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users[zamboni][password]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;dk52ia209rfuh&quot;</span><span class="tok-p">;</span>

 <span class="tok-kd">methods</span><span class="tok-p">:</span>
   <span class="tok-err">...</span>
   <span class="tok-s">&quot;users&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">create_users</span><span class="tok-p">(</span><span class="tok-s">&quot;configfiles.users&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very simple example that manages only local accounts, but which is useful, for example, to set known attributes on common local accounts such as root. However, CFEngine has the ability to manage much more complex scenarios, including centralized user directories. LDAP integration (including Active Directory) is properly supported in the commercial editions of CFEngine.</p>
</div>
</div>
<div class="sect2">
<h3 id="software-installation-servers">Software Installation</h3>
<div class="paragraph">
<p>One of the main tasks of system maintenance is the installation, configuration, upgrading, and removal of software. In old times, most software on a system was (a) part of the operating system, installed or upgraded whenever the whole system was installed or upgraded, (b) commercial software that had its own installation mechanisms, or (c) open-source software that had to be compiled and installed manually. Over time, most operating systems have developed package-management mechanisms, which make it easier to install and manage software of any kind. Unfortunately, package-management mechanisms vary wildly in their capabilities and user interfaces, which makes writing software that can interface with any of them a daunting task. Furthermore, there is still the need (however sporadic) to compile and install software manually.</p>
</div>
<div class="paragraph">
<p>CFEngine provides powerful and generic mechanisms for dealing with this task, that make it possible to adapt it to the needs of every particular system.</p>
</div>
<div class="sect3">
<h4 id="package-based-software-management">Package-Based Software Management</h4>
<div class="paragraph">
<p>CFEngine understands package management as a generic concept. Each package is represented by three attributes: its name, its version, and its architecture. CFEngine allows you to perform operations such as add, <a href="http://cf-learn.info/ref/delete">delete</a>, and <a href="http://cf-learn.info/ref/update">update</a>. The specifics of how to interact with the package-management system are abstracted into discrete components of the policy, and can be customized to interact with any command-line-driven package manager.</p>
</div>
<div class="paragraph">
<p>All package-management promises in CFEngine occur in the <a href="http://cf-learn.info/ref/packages">packages:</a> section of an <a href="http://cf-learn.info/ref/agent">agent</a> bundle. CFEngine allows us to make promises about the state of the packages in the system, and leaves the work of actually modifying the packages to the underlying packaging system. Keep in mind that given the widely varying capabilities of package management systems, we must take their capabilities into consideration when writing package-management promises (for example, if the system uses rpm, we should take into account that it will not automatically fetch and install dependencies of the package being installed).</p>
</div>
<div class="paragraph">
<p>Let us look at a very simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">software</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">pkgs</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span>
                        <span class="tok-s">&quot;subversion&quot;</span><span class="tok-p">,</span>
                        <span class="tok-s">&quot;tcpdump&quot;</span>
                      <span class="tok-p">};</span>
  <span class="tok-kd">packages</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(pkgs)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">package_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;addupdate&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">package_method</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">apt</span><span class="tok-p">;</span>   <span class="tok-c"># For Debian and Ubuntu</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We define a list variable containing the packages we want to install or update (Subversion and tcpdump), and use them in a promise that specifies the addupdate package policy, which means “update the package if it’s installed, install it if not.” We also specify apt as the package method, which is the package management system in Debian-based Linux distributions.</p>
</div>
<div class="paragraph">
<p>Some standard <a href="http://cf-learn.info/ref/package_method">package_method</a> bodies, including apt, are defined in the standard library. Let us look at its definition (some lines have been wrapped and summarized for readability):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">package_method</span> <span class="tok-nf">apt</span>
<span class="tok-p">{</span>
     <span class="tok-kr">package_changes</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;bulk&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_list_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/dpkg -l&quot;</span><span class="tok-p">;</span> <b class="conum">(1)</b>
     <span class="tok-kr">package_list_name_regex</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;ii</span><span class="tok-se">\s</span><span class="tok-s">+([^</span><span class="tok-se">\s</span><span class="tok-s">]+).*&quot;</span><span class="tok-p">;</span> <b class="conum">(2)</b>
     <span class="tok-kr">package_list_version_regex</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;ii</span><span class="tok-se">\s</span><span class="tok-s">+[^</span><span class="tok-se">\s</span><span class="tok-s">]+</span><span class="tok-se">\s</span><span class="tok-s">+([^</span><span class="tok-se">\s</span><span class="tok-s">]+).*&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_installed_regex</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;.*&quot;</span><span class="tok-p">;</span> <span class="tok-c"># all reported are installed</span>
     <span class="tok-kr">package_name_convention</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(name)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span> <b class="conum">(3)</b>

   <span class="tok-c"># set it to &quot;0&quot; to avoid caching of list during upgrade</span>
     <span class="tok-kr">package_list_update_ifelapsed</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;240&quot;</span><span class="tok-p">;</span>

  <span class="tok-nc">have_aptitude</span><span class="tok-p">::</span> <b class="conum">(4)</b>
     <span class="tok-kr">package_add_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/aptitude --assume-yes install&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_list_update_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/aptitude update&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_delete_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/aptitude --assume-yes -q remove&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_update_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/aptitude --assume-yes install&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_verify_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/aptitude show&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_noverify_regex</span> <span class="tok-o">=&gt;</span>
       <span class="tok-s">&quot;(State: not installed|E: Unable to locate package .*)&quot;</span><span class="tok-p">;</span>

  <span class="tok-nc">!have_aptitude</span><span class="tok-p">::</span>
     <span class="tok-kr">package_add_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/apt-get --yes install&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_list_update_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/apt-get update&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_delete_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/apt-get --yes -q remove&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_update_command</span> <span class="tok-o">=&gt;</span>  <span class="tok-s">&quot;/usr/bin/apt-get --yes install&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_verify_command</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/bin/dpkg -s&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">package_noverify_returncode</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <a href="http://cf-learn.info/ref/package_method">package_method</a> body tells CFEngine how to execute the commands that actually perform the operations, and how to process their output to obtain necessary information:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>package_list_command</code> attribute specifies the command to run to
generate a list of packages on the system.</p>
</li>
<li>
<p>Coupled with this, the <code>package_list_name_regex</code> and
<code>package_list_version_regex</code> attributes tell CFEngine the regular
expressions to apply on the output of the package-listing command to
determine each package’s name and version. Additionally, the
<code>package_installed_regex</code> is used to determine which of the packages
in the listing are actually installed (in this case, because of the
command used, all packages in the output are installed, but this may
not be the case in other package-management systems).</p>
</li>
<li>
<p>The <code>package_name_convention</code> attribute tells CFEngine how to specify
a package when executing any of the commands. Some package-management
systems may require both the name and the version to operate. <em>apt</em>
needs only the name, hence it’s specified like this.</p>
</li>
<li>
<p>The have_aptitude class is a hard class that CFEngine defines
automatically on Debian-like systems when the <em>aptitude</em> package
management program is installed, since it provides some additional
capabilities. Depending on this class, the body sets the specific
commands for adding, removing or updating packages.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The standard library includes predefined <a href="http://cf-learn.info/ref/package_method">package_method</a> bodies for several common package managers, including zypper, apt, rpm, yum, Windows MSI installers, the Solaris package manager and the FreeBSD package manager. There is also a generic package method that combines all of the above, and provides the correct values according to the appropriate operating-system hard classes.</p>
</div>
<div class="paragraph">
<p>It is important to note that a <a href="http://cf-learn.info/ref/package_method">package_method</a> definition specifies exactly how to interact with the package manager, and thus allows you to interact with any packaging mechanism you want by writing the appropriate <a href="http://cf-learn.info/ref/package_method">package_method</a>. Useful examples of this would be <a href="http://cf-learn.info/ref/package_method">package_method</a> definitions for popular language-specific or tool-specific package managers, such as <a href="http://pear.php.net/">Pear</a> or <a href="http://rubygems.org/">Ruby Gems</a>.</p>
</div>
<div class="paragraph">
<p>Package promises can be far more complicated. The name, version, and architecture attributes can be used in package promises to define the desired result. We can also use version-comparison operators to further refine the actions. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">software</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">version[openssl]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;0.9.8k-7ubuntu8&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">version[ssl-cert]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1.0.23ubuntu2&quot;</span><span class="tok-p">;</span>

      <span class="tok-p">&quot;</span><span class="tok-nv">architectures</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;x86_64&quot;</span> <span class="tok-p">};</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">allpkgs</span><span class="tok-p">&quot;</span>       <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;version&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">packages</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(allpkgs)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">package_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;add&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">package_select</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;==&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">package_version</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(version[$(allpkgs)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">package_architectures</span> <span class="tok-o">=&gt;</span> <span class="tok-nv">@(architectures)</span><span class="tok-p">,</span>
        <span class="tok-kr">package_method</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">apt</span><span class="tok-p">;</span>   <span class="tok-c"># For Debian and Ubuntu</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we are using an array to store the versions we want, indexed by package name. Then we are using the list of indices from the array to install the specific version we want for each package, also specifying the desired architecture. We are again using an array and implicit looping to request the needed version for each one of the packages. The <a href="http://cf-learn.info/ref/package_select">package_select</a> attribute with value "==" tells CFEngine that we want exactly the specified version of the package (by default its value is "&gt;=", which gives us the latest available version older than the one specified).</p>
</div>
<div class="paragraph">
<p>When <a href="http://cf-learn.info/ref/package_policy">package_policy</a> is verify (this is its default value), all that CFEngine does is check that the desired packages are installed correctly. This can be used to simply report on the correctness of the system, without attempting to fix anything<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">verify_packages</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">allpkgoutput</span><span class="tok-p">&quot;</span>
     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">execresult</span><span class="tok-p">(</span><span class="tok-s">&quot;/usr/bin/rpm -qa --queryformat </span><span class="tok-se">\&quot;</span><span class="tok-s">%{name}</span><span class="tok-se">\n\&quot;</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">allpkgs</span><span class="tok-p">&quot;</span>
     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">splitstring</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(allpkgoutput)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\s</span><span class="tok-s">+&quot;</span><span class="tok-p">,</span> <span class="tok-mi">999999</span><span class="tok-p">);</span>

 <span class="tok-kd">packages</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;</span><span class="tok-si">$(allpkgs)</span><span class="tok-s">&quot;</span>
     <span class="tok-kr">package_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;verify&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">package_method</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">rpm</span><span class="tok-p">,</span>
     <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">if_notkept</span><span class="tok-p">(</span><span class="tok-s">&quot;incorrect_</span><span class="tok-si">$(allpkgs)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

 <span class="tok-kd">reports</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;Problem: package </span><span class="tok-si">$(allpkgs)</span><span class="tok-s"> is not installed correctly.&quot;</span>
     <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;incorrect_</span><span class="tok-si">$(allpkgs)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle starts by getting the listing of all packages by running an external command using the <a href="http://cf-learn.info/ref/execresult">execresult()</a> function, and storing it in the $(allpkgoutput) string, which then gets split by the <a href="http://cf-learn.info/ref/splitstring">splitstring()</a> function into the @(allpkgs) list. We then iterate over this list verifying each package in turn. If the promise is not kept (this is, if the package does not get verified correctly), the <a href="http://cf-learn.info/ref/packages">packages</a> bundle defines a incorrect___packagename__ class. In the <a href="http://cf-learn.info/ref/reports">reports:</a> section, we iterate again over @(allpkgs), printing a message for the packages whose incorrect___packagename__ class is defined. We can use this as a general “sanity check” of a system, for example to produce a report of its current state if we have a new system that comes under our management, or to trigger automatic corrective actions.</p>
</div>
</div>
<div class="sect3">
<h4 id="manual-software-management">Manual Software Management</h4>
<div class="paragraph">
<p>Although package management software is the ideal way to install and uninstall software on a system, there may be cases in which you want or need to manage software manually. One such case would be when the software you need to install is not available in your operating system’s software repository, or if you need to compile or install it in a custom way, or if you need a specific version that is too old or too new to be in the repository.</p>
</div>
<div class="paragraph">
<p>In this section we develop a CFEngine policy to manually install an application. This requires more manual work and each policy will be unique to the application that is being installed, so you may want to minimize the number of applications you install using this method. However, it is useful to know how to perform this task for the times when it is needed.</p>
</div>
<div class="paragraph">
<p>For our example, we will install the <a href="http://wordpress.org/">WordPress</a> blogging and CMS application. From the WordPress documentation, we can see that it has a fairly simple <a href="http://codex.wordpress.org/Installing_WordPress#Detailed_Instructions">installation procedure</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the system requirements: Apache, PHP, and MySQL;</p>
</li>
<li>
<p>Download and extract the package;</p>
</li>
<li>
<p>Create a MySQL database and user to use with WordPress;</p>
</li>
<li>
<p>Set up wp-config.php with the necessary database parameters, using wp-config-sample.php as a starting point.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These steps give us a fairly good guide for implementing the installation using CFEngine. We’ll create a wp_install bundle, but let’s start by thinking how we would like to invoke it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
     <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nf">wp_install</span><span class="tok-p">(</span><span class="tok-s">&quot;g.wp_config&quot;</span><span class="tok-p">)</span> <span class="tok-p">};</span>
     <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;libraries/cfengine_stdlib.cf&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;wordpress.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">g</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">wp_config[DB_NAME]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;wordpress&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">wp_config[DB_USER]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;wordpress&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">wp_config[DB_PASSWORD]</span><span class="tok-p">&quot;</span>   <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;lopsa10linux&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">debian</span><span class="tok-p">::</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">wp_config[_htmlroot]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/www&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">redhat</span><span class="tok-p">::</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">wp_config[_htmlroot]</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/www/html&quot;</span><span class="tok-p">;</span>
  <span class="tok-nc">any</span><span class="tok-p">::</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">wp_config[_wp_dir]</span><span class="tok-p">&quot;</span>       <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(wp_config[_htmlroot])</span><span class="tok-s">/blog&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are defining, in the common g bundle, the wp_config array with our parameters for the installation. The most important parameters are the database name, user and password, and the directory where we want WordPress to be installed. Note that we use classes to assign a different value to the htmlroot parameter depending on whether we are on a Debian or a RedHat system, to account for slight differences between those distributions.</p>
</div>
<div class="paragraph">
<p>The wp_install() bundle is called directly from the <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> declaration, passing the name of the configuration array as a parameter. The wp_install() bundle could also be called, for example, from the <a href="http://cf-learn.info/ref/methods">methods:</a> section of some other bundle, as we did before in our configfiles() bundle.</p>
</div>
<div class="paragraph">
<p>Let’s now walk through the actual implementation of the wp_install policy.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The wp_install() bundle is the point of entry for this policy bundle, which calls all other tasks:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_install</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
 <span class="tok-kd">methods</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;wp_vars&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_vars</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(params)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_pkgs&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_packages_installed</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_svcs&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_services_up</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_tar&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_tarball_is_present</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_xpnd&quot;</span>  <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_tarball_is_unrolled</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_mysql&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_mysql_configuration</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_cfgcp&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_config_exists</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
   <span class="tok-s">&quot;wp_cfg&quot;</span>   <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">wp_is_properly_configured</span><span class="tok-p">(</span><span class="tok-s">&quot;wp_vars.conf&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle receives as argument a variable called params, which must contain <em>the name of an array</em> that itself contains the different adjustable parameters of this bundle, such as the database user and password to use (as in the sample invocation we saw before, the argument was the string "g.wp_config"; this is how we have passed configuration arrays before: by using their name instead of passing the array itself). In the first methods: call to the wp_vars() bundle, the configuration array is extended with default parameter values (for those that are not specified by the user), and with some hard-coded internal parameters related to the operation of the bundle, such as the file into which the <em>wordpress.tar.gz</em> file will be downloaded, the URL from where it will be fetched, the path of the service command, and the name by which the Apache web server is identified. The extended parameter array is stored in wp_vars.conf, which will be used by all the other bundles (we will examine in detail the operation of the wp_vars() bundle in <a href="#passing-name-value-pairs-to-bundles">[passing-name-value-pairs-to-bundles]</a>). In the rest of the <a href="http://cf-learn.info/ref/methods">methods:</a> section of this bundle, we call the other bundles that actually perform the required tasks. The wp_vars.conf array is passed to every single bundle. In methods: promises, the promiser is an arbitrary string that (at least in current CFEngine versions) is not used for any purpose. For clarity, we use short identifiers for each of the methods we are calling.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first step of the actual installation process is to make sure all WordPress prerequisites are properly installed and working. This is taken care of by two bundles, wp_packages_installed() and wp_services_up(). The first one uses the native package-management facilities to install the prerequisites for WordPress:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_packages_installed</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
    <span class="tok-nc">debian</span><span class="tok-p">::</span>  <b class="conum">(1)</b>
      <span class="tok-p">&quot;</span><span class="tok-nv">desired_package</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span>
                                   <span class="tok-s">&quot;apache2&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-s">&quot;php5&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-s">&quot;php5-mysql&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-s">&quot;mysql-server&quot;</span><span class="tok-p">,</span>
                                 <span class="tok-p">};</span>
    <span class="tok-nc">redhat</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">desired_package</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span>
                                   <span class="tok-s">&quot;httpd&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-s">&quot;php&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-s">&quot;php-mysql&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-s">&quot;mysql-server&quot;</span><span class="tok-p">,</span>
                                 <span class="tok-p">};</span>
  <span class="tok-kd">packages</span><span class="tok-p">:</span>  <b class="conum">(2)</b>
      <span class="tok-s">&quot;</span><span class="tok-si">$(desired_package)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">package_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;add&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">package_method</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">generic</span><span class="tok-p">,</span>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;packages_added&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">packages_added</span><span class="tok-p">::</span>  <b class="conum">(3)</b>
      <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_sys_servicecmd])</span><span class="tok-s"> </span><span class="tok-si">$($(params)[_sys_apachesrv])</span><span class="tok-s"> graceful&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Restarting httpd so it can pick up new modules.&quot;</span><span class="tok-p">;</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We first define the list of necessary packages for each operating
system that we want to support.</p>
</li>
<li>
<p>This is
then used in the <a href="http://cf-learn.info/ref/packages"><code>packages:</code></a>
section of the bundle to install them as appropriate. If any of the
package promises are <em>repaired</em> (this means, if any of the packages
need to be installed), the packages_added class will be defined.</p>
</li>
<li>
<p>If the packages_added class is defined, Apache needs to be restarted
to ensure it uses any newly-available modules. The path of the
<em>service</em> command and the name of the service to restart (<code>httpd</code> in
RedHat, <code>apache2</code> in Debian) are taken from the params array as
defined in wp_vars().</p>
</li>
</ol>
</div>
</li>
<li>
<p>The wp_services_up() bundle ensures that both MySQL and Apache are running:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_services_up</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">processes</span><span class="tok-p">:</span>
    <span class="tok-nc">debian</span><span class="tok-p">::</span> <b class="conum">(1)</b>
      <span class="tok-s">&quot;/usr/sbin/mysqld&quot;</span> <span class="tok-kr">restart_class</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;start_mysqld&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;/usr/sbin/apache2&quot;</span>  <span class="tok-kr">restart_class</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;start_httpd&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">redhat</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;^mysqld&quot;</span> <span class="tok-kr">restart_class</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;start_mysqld&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;^httpd&quot;</span>  <span class="tok-kr">restart_class</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;start_httpd&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span> <b class="conum">(2)</b>
    <span class="tok-nc">start_mysqld</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_sys_servicecmd])</span><span class="tok-s"> mysql start&quot;</span><span class="tok-p">;</span>

    <span class="tok-nc">start_httpd</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_sys_servicecmd])</span><span class="tok-s"> </span><span class="tok-si">$($(params)[_sys_apachesrv])</span><span class="tok-s"> start&quot;</span> <span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First we
ensure that both <code>mysqld</code> and <code>httpd</code> are running by using a
<a href="http://cf-learn.info/ref/processes"><code>processes:</code></a> section. Different
process-matching strings are used depending on the Linux distribution
used, due to the differences in how the processes appear in the
process table. If any of the processes are not running, the
corresponding restart_class is defined.</p>
</li>
<li>
<p>If any of the restart classes are defined (start_mysqld or
start_httpd), the corresponding command is run to start the
appropriate service.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>This bundle could be rewritten to make use of <a href="http://cf-learn.info/ref/services">services:</a> promises, which are available since CFEngine 3.3.0. In this case it would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bundle agent wp_services_up(params)
{
  services:
      "www"   service_policy =&gt; "start";
      "mysql" service_policy =&gt; "start";
}</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#service-management">[service-management]</a> for more information about service management using <a href="http://cf-learn.info/ref/services">services:</a> promises.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After both of these bundles are called from the <a href="http://cf-learn.info/ref/methods">methods:</a> section of the main wp_install() bundle, both the HTTP and MySQL daemons will be running, with the appropriate modules installed.</p>
</div>
</li>
<li>
<p>Next, we need to download the WordPress distribution file if it is not present already. This is taken care of by the wp_tarball_is_present() bundle:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_tarball_is_present</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span> <b class="conum">(1)</b>
      <span class="tok-s">&quot;wordpress_tarball_is_present&quot;</span>
        <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">fileexists</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_tarfile])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span> <b class="conum">(2)</b>
    <span class="tok-nc">!wordpress_tarball_is_present</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/usr/bin/wget -q -O </span><span class="tok-si">$($(params)[_tarfile])</span><span class="tok-s"> </span><span class="tok-si">$($(params)[_downloadurl])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Downloading latest version of WordPress.&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span> <b class="conum">(3)</b>
    <span class="tok-nc">wordpress_tarball_is_present</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;WordPress tarball is on disk.&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In the <a href="http://cf-learn.info/ref/classes"><code>classes:</code></a> section we define
a class depending on the existence of the tar file that contains the
WordPress distribution. The location and filename of this file is also
contained in the params configuration array.</p>
</li>
<li>
<p>If the class is not defined (which means the file is not present), the
<a href="http://cf-learn.info/ref/commands"><code>commands:</code></a> section uses the <em>wget</em>
command to download the file to the proper location.</p>
</li>
<li>
<p>If the file was already there, we don’t download it again, and simply
report its existence in the
<a href="http://cf-learn.info/ref/reports"><code>reports:</code></a> section.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once we ensure that the WordPress distribution file is present, the wp_tarball_is_unrolled() bundle makes sure it has been expanded:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_tarball_is_unrolled</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span> <b class="conum">(1)</b>
      <span class="tok-s">&quot;wordpress_src_dir_is_present&quot;</span>
        <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">fileexists</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_htmlroot])</span><span class="tok-s">/wordpress&quot;</span><span class="tok-p">);</span>
      <span class="tok-s">&quot;wordpress_final_dir_is_present&quot;</span>
        <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">fileexists</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_wp_dir])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">wordpress_final_dir_is_present</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;WordPress directory is present.&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">!wordpress_final_dir_is_present&amp;!wordpress_src_dir_is_present</span><span class="tok-p">::</span> <b class="conum">(2)</b>
      <span class="tok-s">&quot;/bin/tar -xzf </span><span class="tok-si">$($(params)[_tarfile])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Unroll WP tar to </span><span class="tok-si">$($(params)[_htmlroot])</span><span class="tok-s">/wordpress.&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">contain</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">in_dir_shell</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_htmlroot])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
    <span class="tok-nc">wordpress_src_dir_is_present&amp;!wordpress_final_dir_is_present</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/bin/mv </span><span class="tok-si">$($(params)[_htmlroot])</span><span class="tok-s">/wordpress </span><span class="tok-si">$($(params)[_wp_dir])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Rename unrolled directory to </span><span class="tok-si">$($(params)[_wp_dir])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle is very similar to the previous one, except that:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The existence check is done on the directory into which the tar file
expands, contained in the <code>_wp_dir</code> parameter of the configuration
array.</p>
</li>
<li>
<p>If it does not exist, we use the <em>tar</em> command to expand it under the
directory defined by the <code><em>htmlroot</code> parameter. This will create a
directory named _wordpress</em> under that directory, since that is how
the WordPress tar file is packaged. After unpacking the distribution,
we rename the resulting <code>wordpress</code> directory to its final name as
indicated by the <code>_wp_dir</code> parameter, from where it will be served by
the web server.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Once the files are in place, it is time to configure WordPress, and the first step is creating a MySQL database and user for WordPress to use. This is done by the wp_mysql_configuration() bundle:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_mysql_configuration</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">commands</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/usr/bin/mysql -u root -e </span><span class="tok-se">\&quot;</span><span class="tok-s"></span>
<span class="tok-s">      CREATE DATABASE IF NOT EXISTS </span><span class="tok-si">$($(params)[DB_NAME])</span><span class="tok-s">;</span>
<span class="tok-s">      GRANT ALL PRIVILEGES ON </span><span class="tok-si">$($(params)[DB_NAME])</span><span class="tok-s">.*</span>
<span class="tok-s">      TO &#39;</span><span class="tok-si">$($(params)[DB_USER])</span><span class="tok-s">&#39;@localhost</span>
<span class="tok-s">      IDENTIFIED BY &#39;</span><span class="tok-si">$($(params)[DB_PASSWORD])</span><span class="tok-s">&#39;;</span>
<span class="tok-s">      FLUSH PRIVILEGES;</span><span class="tok-se">\&quot;</span><span class="tok-s"></span>
<span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very simple bundle: it just runs the mysql command-line utility with the appropriate SQL commands to perform the task. In this respect, MySQL makes things quite easy, since a single command can be used to create the database if it doesn’t exist already, create the user if it doesn’t exist already, and set the user password.</p>
</div>
</li>
<li>
<p>The second bundle involved in configuring WordPress is wp_config_exists():</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_config_exists</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;wordpress_config_file_exists&quot;</span>  <b class="conum">(1)</b>
        <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">fileexists</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_wp_config])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
    <span class="tok-nc">!wordpress_config_file_exists</span><span class="tok-p">::</span>  <b class="conum">(2)</b>
      <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_wp_config])</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_local_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_wp_cfgsample])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">wordpress_config_file_exists</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;WordPress config file </span><span class="tok-si">$($(params)[_wp_config])</span><span class="tok-s"> is present&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">!wordpress_config_file_exists</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;WordPress config file </span><span class="tok-si">$($(params)[_wp_config])</span><span class="tok-s"> is not present&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This bundle first checks whether the <em>wp-config.php</em> file already
exists inside the WordPress installation directory. If it does, we do
not want to overwrite it, since it may already have some
customizations (this is useful when updating WordPress to a new
version).</p>
</li>
<li>
<p>If the file does not exist, the wordpress_config_file_exists class
will not be set, and in this case the
<a href="http://cf-learn.info/ref/files"><code>files:</code></a> section will create it using
the <em>wp-config-sample.php</em> file shipped with WordPress as the starting
point.</p>
</li>
</ol>
</div>
</li>
<li>
<p>After making sure the configuration file is in its proper place, we want to ensure that it contains the appropriate parameters. For this we use the wp_is_properly_configured() bundle:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">wp_is_properly_configured</span><span class="tok-p">(</span><span class="tok-nv">params</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">allparams</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(params)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(1)</b>
    <span class="tok-nc">secondpass</span><span class="tok-p">::</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">wpparams</span><span class="tok-p">&quot;</span>  <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">grep</span><span class="tok-p">(</span><span class="tok-s">&quot;[^_].*&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;allparams&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;secondpass&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">isvariable</span><span class="tok-p">(</span><span class="tok-s">&quot;allparams&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$($(params)[_wp_config])</span><span class="tok-s">&quot;</span> <b class="conum">(2)</b>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span>
          <span class="tok-nf">replace_or_add</span><span class="tok-p">(</span>
           <span class="tok-s">&quot;define</span><span class="tok-se">\(</span><span class="tok-s">&#39;</span><span class="tok-si">$(wpparams)</span><span class="tok-s">&#39;, *(?!&#39;</span><span class="tok-si">$($(params)[$(wpparams)])</span><span class="tok-s">)&#39;.*&quot;</span><span class="tok-p">,</span>
           <span class="tok-s">&quot;define(&#39;</span><span class="tok-si">$(wpparams)</span><span class="tok-s">&#39;, &#39;</span><span class="tok-si">$($(params)[$(wpparams)])</span><span class="tok-s">&#39;);&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this is a short bundle, there is a lot going on behind the scenes, so let us take a moment to understand what it does.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First, we store in the <code>allparams</code> list the indices of the configuration
array that is passed into the bundle as the params argument. This
gives us, according to the definition given in our example, the
following values: <code>{ DB_NAME, DB_USER, DB_PASSWORD, <em>htmlroot, _tarfile, &#8230;&#8203; }</code>
We then use the <code>grep()</code> built-in function to select from <code>allparams</code> only
those parameters that do not start with an underscore, to avoid
storing internal parmeters in the WordPress configuration file. The
filtered list is stored in <code>wpparams</code>, which would have in our example
the following values: <code>{ DB_NAME, DB_USER, DB_PASSWORD }</code>
Due to an artifact
of the way variables are converged in the current version of CFEngine,
we need to use a trick to make sure the <code>wpparams</code> list is assigned only
on the _second pass</em> of the CFEngine policy evaluation (remember that
CFEngine makes three passes over each bundle). Not doing this results
in the <code>wpparams</code> list being empty, because it is filled using the
original value of <code>allparams</code> and not the final value obtained using the
<code>getindices()</code> function. To achieve this, we set class <code>secondpass</code> in the
<code>classes:</code> section based on whether the <code>allparams</code> variable exists, and
in the <code>vars:</code> section, <code>wpparams</code> is only created when the <code>secondpass</code>
class is true. For details about how this works, see
<a href="#controlling-promise-execution-order">[controlling-promise-execution-order]</a>.</p>
</li>
<li>
<p>To understand the trick we are about to use, we need to look at the lines in the <em>wp-config.php</em> file that we want to modify:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-sd">/** The name of the database for WordPress */</span>
<span class="tok-nb">define</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_NAME&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;database_name_here&#39;</span><span class="tok-p">);</span>

<span class="tok-sd">/** MySQL database username */</span>
<span class="tok-nb">define</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_USER&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;username_here&#39;</span><span class="tok-p">);</span>

<span class="tok-sd">/** MySQL database password */</span>
<span class="tok-nb">define</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_PASSWORD&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;password_here&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we have used, as the indices in the wp_config array, the same parameter names used in the <em>wp-config.php</em> file (plus some others, which we use internally in the policy). This allows the <a href="http://cf-learn.info/ref/edit_line"><code>edit_line</code></a> statement in the <a href="http://cf-learn.info/ref/files"><code>files:</code></a> section to do its magic using CFEngine’s implicit looping (you should by now be getting the idea that this is one of the most powerful features in CFEngine!). In this statement, we replace the following regexp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nx">define\</span><span class="tok-p">(</span><span class="tok-s1">&#39;$(wpparams)&#39;</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-o">?!</span><span class="tok-s1">&#39;$($(params)[$(wpparams)]))&#39;</span><span class="tok-o">.*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>by the following text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nb">define</span><span class="tok-p">(</span><span class="tok-s1">&#39;$(wpparams)&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;$($(params)[$(wpparams)])&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Through implicit looping, <code>$(wpparams)</code> takes the value of each index in
sequence. So, for example, when <code>$(wpparams)</code> has the value <code>DB_NAME</code>,
the regular expression looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nx">define\</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_NAME&#39;</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-o">?!</span><span class="tok-s1">&#39;$($(params)[DB_NAME]))&#39;</span><span class="tok-o">.*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and the replacement string looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nb">define</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_NAME&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;wordpress&#39;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The negative look-ahead <code>(?!&#8230;&#8203;)</code> in the regular expression is used to
match only lines in which the correct value is not already present,
and to ensure the proper convergence of the replacement operation.
Without this, CFEngine notices that the regular expression matches the
line even after the replacement operation has taken place, and
considers it to be a non-properly-convergent operation. It still
works, but will produce a warning from CFEngine every time it runs.</p>
</div>
<div class="paragraph">
<p>This means, we will replace whatever value the <code>DB_NAME</code> parameter has
at the moment with the correct one, taken from the wp_config array. If
the line does not exist at all, it will be added to the file. This
will happen for all the parameters in that array automatically, and
the file will be rewritten to disk only if at least one change is
actually made to it. A nice side effect of this automation is that we
can modify any parameter in the <em>wp-config.php</em> file just by adding a
new element to the configuration array. For example, if we needed to
set the <code>DB_CHARSET</code> parameter, all we need to add is the following
line to the definition of wp_config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-s2">&quot;wp_config[DB_CHARSET]&quot;</span>  <span class="tok-nx">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;iso8859-1&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are a few aspects of this configuration to focus on. First, I would like to draw a contrast between this policy and a shell script that would perform the same tasks. The main difference is that in a CFEngine policy, we simply specify the end state we want to achieve (for example, a directory or a file existing), and CFEngine only proceeds with the actions if any aspects of the system are not in the desired state.</p>
</div>
<div class="paragraph">
<p>Second, notice that we are making use of some of the generic tools and tricks that we have built elsewhere, or that are available in the standard libraries. For example, we use the replace_or_add() bundle from standard library to edit the WordPress configuration file. And we are using an array to pass parameters, which allows us to do some generic manipulations and traversing of the data, as seen in the wp_is_properly_configured() bundle.</p>
</div>
<div class="paragraph">
<p>Third, note how using the <a href="http://cf-learn.info/ref/methods">methods:</a> section allows us to break a task into sub-tasks, thereby providing a single point of entry (in this case, the wp_install() bundle) into a policy that may be arbitrarily complex.</p>
</div>
<div class="paragraph">
<p>In general, I would advise you to use the built-in package management facilities for handling software in the system, using the interfaces that CFEngine provides to these systems. However, as we have just seen, it is entirely possible to perform ad-hoc software installation and configuration when needed. These are tasks that, when managing systems manually, you would have to perform anyway. CFEngine allows you to automate and perform them in the best possible way. As your mechanism to install and configure the software improves (or, for example, when the package appears in a proper way in the software repository), your CFEngine policy can evolve to adapt to your needs and possibilities. For example, when WordPress becomes available in the software repository, you could keep wp_install() as the main entry point for the policy, and simply replace the first five calls in the <a href="http://cf-learn.info/ref/methods">methods:</a> section by a single call to a bundle that handles the installation using <a href="http://cf-learn.info/ref/packages">packages:</a> promises.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-cfengine-for-security">Using CFEngine for Security</h3>
<div class="paragraph">
<p>A large part of maintaining security in a computer system consists of maintaining proper configuration of the systems, which makes CFEngine well suited for the task of configuring, maintaining, and monitoring security-related state. In this section we will explore some of the applications of CFEngine in this area.</p>
</div>
<div class="sect3">
<h4 id="policy-enforcement">Policy Enforcement</h4>
<div class="paragraph">
<p>Many organizations have security policies that are in turn translated into specific configuration specifications for computer systems. While CFEngine cannot help with mapping high-level policies into procedures and implementations, it can certainly make sure that the implementations are correctly applied and maintained. Here are some example security-related policies that are common in some systems, and how CFEngine can help in enforcing them. In the process we will learn and revisit some CFEngine concepts and constructs.</p>
</div>
<div class="sect4">
<h5 id="login-banners">Template-based login banners</h5>
<div class="paragraph">
<p>CFEngine can make sure a login banner is always present, and contains the approved text according to a template that contains the policy-mandated text, plus some variable per-host information. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
     <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;login_banner&quot;</span> <span class="tok-p">};</span>
     <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/var/cfengine/inputs/libraries/cfengine_stdlib.cf&quot;</span> <span class="tok-p">};</span> <b class="conum">(1)</b>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">login_banner</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">template_file</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/cfengine/templates/motd_template.txt&quot;</span><span class="tok-p">;</span> <b class="conum">(2)</b>
   <span class="tok-p">&quot;</span><span class="tok-nv">motd_file</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc/motd&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">support</span><span class="tok-p">&quot;</span>       <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;Solaris: John Doe (x3478)&quot;</span><span class="tok-p">,</span>
                              <span class="tok-s">&quot;Linux: Sam Wilson (x7832)&quot;</span><span class="tok-p">,</span>
                              <span class="tok-s">&quot;AIX: Steve Clark (x3212)&quot;</span> <span class="tok-p">};</span>
 <span class="tok-kd">files</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;</span><span class="tok-si">$(motd_file)</span><span class="tok-s">&quot;</span> <b class="conum">(3)</b>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;set_login_banner&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Ensure the login banner is set to the authorized text&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">perms</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">mog</span><span class="tok-p">(</span><span class="tok-s">&quot;744&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;root&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;wheel&quot;</span><span class="tok-p">),</span>
     <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">empty</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_template</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(template_file)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span> <b class="conum">(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we are making use of templates in CFEngine to populate the <em>/etc/motd</em> file with the appropriate content. A template is a partially complete file that you fill in with the particular values you want. CFEngine then expands the template. Let us examine what is going on in the example.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First, we must include the CFEngine standard library, because the policy makes use of several bodies and bundles defined in it.</p>
</li>
<li>
<p>We store in variables the filenames of the template file, and of the actual file to be edited. This is not needed, but it is a good practice to have all user-defined values in a single, differentiated place. We will look at the contents of the template file in a moment.  Note that we also define some information that will be included in the template when expanded.</p>
</li>
<li>
<p>In the <a href="http://cf-learn.info/ref/files"><code>files:</code></a> promise we tell CFEngine, among other things, that the <em>/etc/motd</em> file needs to be created if it doesn’t exist, that it needs to have permissions 644 (or <code>rw-r&#8212;&#8203;r--</code>), belong to user <code>root</code> and group <code>wheel</code>, and that it should be emptied completely before inserting the lines. For these specifications we use two bodies from the standard library, namely:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">perms</span> <span class="tok-nf">mog</span><span class="tok-p">(</span><span class="tok-nv">mode</span><span class="tok-p">,</span><span class="tok-nv">user</span><span class="tok-p">,</span><span class="tok-nv">group</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kr">owners</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(user)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kr">groups</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(group)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kr">mode</span>   <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(mode)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
<span class="tok-k">body</span> <span class="tok-k">edit_defaults</span> <span class="tok-nf">empty</span>
<span class="tok-p">{</span>
  <span class="tok-kr">empty_file_before_editing</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
  <span class="tok-kr">edit_backup</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">;</span>
  <span class="tok-kr">max_file_size</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;300000&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both of these bodies are very simple. The first one simply passes on the permissions it receives, and the second simply specifies that the file must be emptied before starting the editing. Remember that CFEngine does all the editing in memory and writes results to the disk only if they are different from what was there before, so there are no unnecessary edits of the file, even when <code>empty_file_before_editing</code> is used.</p>
</div>
</li>
<li>
<p>The <code>edit_template</code> attribute is the one that actually specifies how the file will be edited. We have seen in previous examples the use of <a href="http://cf-learn.info/ref/edit_line">edit_line</a> to add and delete lines, how to search and replace using regular expressions, and to edit field-based files. Now we use yet another file-editing facility provided by CFEngine, that of using templates for specifying the contents of a file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The value of the <a href="http://cf-learn.info/ref/edit_template"><code>edit_template</code></a> attribute must be the filename of the template to expand, which could contain something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>[%CFEngine BEGIN %]   <b class="conum">(1)</b>
This system may be accessed by authorized users only.
Use of this system implies acceptance of authorized use policies.
Misuse may be subject to prosecution.

Host: $(sys.fqhost) ($(sys.ipv4))   <b class="conum">(2)</b>
This system is managed by CFEngine v$(sys.cf_version)
This file was generated from $(login_banner.template_file)
[%CFEngine END %]
[%CFEngine BEGIN %]
Support for $(login_banner.support).   <b class="conum">(3)</b>
[%CFEngine END %]
[%CFEngine Night:: %]   <b class="conum">(4)</b>
REMEMBER: Nighttime logins are subject to additional scrutiny.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us look at some of the constructs that can be used in a template:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Lines containing the special strings <code>[%CFEngine BEGIN %]</code> and <code>[%CFEngine END %]</code> are used to delimit blocks of text within the template that should not be broken. Normally, each line in the template is translated internally to a separate <a href="http://cf-learn.info/ref/edit_line"><code>edit_line</code></a> promise, but when grouping them in a block, CFEngine ensures that all the lines remain together and without alteration (for example, duplicate empty lines are preserved).</p>
</li>
<li>
<p>Variables in the template are referenced just as you would in any other string. Keep in mind that all variables in the template must be referenced with their full module path, as shown in the reference to the login_banner.template_file variable.</p>
</li>
<li>
<p>Implicit looping is supported within the template. If a list is referenced inside the template, the line or block containing the reference will be repeated for each value in the list. In this particular case, The entire block is repeated for each value contained in the support list in the login_banner() bundle.</p>
</li>
<li>
<p>Conditional blocks using class expressions are also supported, by using the special line <code>[%CFEngine classexpression:: %]</code>. Everything that follows that line will be included only if the given class expression is true. In this example, the last line of the template will only be included when the <code>Night</code> class is defined, which CFEngine defines only between midnight and 6AM.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When we execute this policy, the output may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent -f ./login_banner.cf
<span class="tok-gp">#</span> cat /etc/motd
<span class="tok-go">This system may be accessed by authorized users only.</span>
<span class="tok-go">Use of this system implies acceptance of authorized use policies.</span>
<span class="tok-go">Misuse may be subject to prosecution.</span>

<span class="tok-go">Host: cfma-10022 (192.168.1.140)</span>
<span class="tok-go">This system is managed by CFEngine v3.4.2</span>
<span class="tok-go">This file was generated from /var/cfengine/templates/motd_template.txt</span>

<span class="tok-go">Support for Solaris: John Doe (x3478).</span>
<span class="tok-go">Support for Linux: Sam Wilson (x7832).</span>
<span class="tok-go">Support for AIX: Steve Clark (x3212).</span>
<span class="tok-go">REMEMBER: Nighttime logins are subject to additional scrutiny.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Template files are a powerful mechanisms for generating files using CFEngine. They make it easier to modify the contents of a file without having to touch the policy files that maintain it, and make it easier to understand what the final contents of the file will be without having to untangle the logic of the code.</p>
</div>
</div>
<div class="sect4">
<h5 id="password-expiration-periods">Password expiration periods</h5>
<div class="paragraph">
<p>Password expiration is another common configuration policy that is mandated by security policies, and which is possible to set and maintain using CFEngine. For example, in Linux systems this is commonly done using the /etc/login.defs file. We can use the following bundle to set these parameters appropriately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">password_expiration</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-c"># Maximum password age</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">logindefs[PASS_MAX_DAYS]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;180&quot;</span><span class="tok-p">;</span>   <b class="conum">(1)</b>
   <span class="tok-c"># Minimum password age (minimum days between changes)</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">logindefs[PASS_MIN_DAYS]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;10&quot;</span><span class="tok-p">;</span>
   <span class="tok-c"># Warning period (in days) before password expires</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">logindefs[PASS_WARN_AGE]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;5&quot;</span><span class="tok-p">;</span>

   <span class="tok-c"># Position of each parameter in /etc/shadow</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">fieldnum[PASS_MIN_DAYS]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;4&quot;</span><span class="tok-p">;</span>   <b class="conum">(2)</b>
   <span class="tok-p">&quot;</span><span class="tok-nv">fieldnum[PASS_MAX_DAYS]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;5&quot;</span><span class="tok-p">;</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">fieldnum[PASS_WARN_AGE]</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;6&quot;</span><span class="tok-p">;</span>

   <span class="tok-c"># List of parameters to modify</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">params</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;logindefs&quot;</span><span class="tok-p">);</span>   <b class="conum">(3)</b>

   <span class="tok-c"># UIDs below this threshold will not be touched</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">uidthreshold</span><span class="tok-p">&quot;</span> <span class="tok-kt">int</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;500&quot;</span><span class="tok-p">;</span>   <b class="conum">(4)</b>
   <span class="tok-c"># Additionally, these users and UIDs will not be touched.</span>
   <span class="tok-c"># These are comma-separated lists.</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">skipped_users</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;vboxadd,nobody&quot;</span><span class="tok-p">;</span>   <b class="conum">(5)</b>
   <span class="tok-p">&quot;</span><span class="tok-nv">skipped_uids</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1000,1005&quot;</span><span class="tok-p">;</span>

   <span class="tok-c"># Get list of users, and also generate them in canonified form</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">users</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getusers</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(skipped_users)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-si">$(skipped_uids)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>   <b class="conum">(6)</b>
   <span class="tok-p">&quot;</span><span class="tok-nv">cusers[$(users)]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">canonify</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(users)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

 <span class="tok-kd">classes</span><span class="tok-p">:</span>
   <span class="tok-c"># Define classes for users that must not be modified,</span>
   <span class="tok-c"># either by UID threshold or by username</span>
   <span class="tok-s">&quot;skip_</span><span class="tok-si">$(cusers[$(users)])</span><span class="tok-s">&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">islessthan</span><span class="tok-p">(</span><span class="tok-nf">getuid</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(users)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>  <b class="conum">(7)</b>
                                                       <span class="tok-s">&quot;</span><span class="tok-si">$(uidthreshold)</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

 <span class="tok-kd">files</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;/etc/login.defs&quot;</span>   <b class="conum">(8)</b>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;edit_logindefs&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Set desired login.defs parameters&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_config_values</span><span class="tok-p">(</span><span class="tok-s">&quot;password_expiration.logindefs&quot;</span><span class="tok-p">);</span>

   <span class="tok-s">&quot;/etc/shadow&quot;</span>   <b class="conum">(9)</b>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;edit_shadow_</span><span class="tok-si">$(params)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Modify </span><span class="tok-si">$(params)</span><span class="tok-s"> for individual users.&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_timestamp</span><span class="tok-p">,</span>
     <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_user_field</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(users)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                                 <span class="tok-s">&quot;</span><span class="tok-si">$(fieldnum[$(params)])</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                                 <span class="tok-s">&quot;</span><span class="tok-si">$(logindefs[$(params)])</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>
     <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;!skip_</span><span class="tok-si">$(cusers[$(users)])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The idea is to set in <em>/etc/login.defs</em> new default values for the minimum and maximum password ages, as well as the warning period to users when the password expiration date is approaching. To ensure consistency, we also edit <em>/etc/shadow</em> to change all user-specific expiration settings to the default value. But we don’t want to blindly change all the user entries, because this would most certainly cause problems by changing the password periods for system accounts such as root, lpd, or daemon. To address this, we include a system for excluding certain users by user ID threshold (all UIDs below a set threshold are ignored), and also by specific usernames and user IDs. This bundle brings together several concepts we have discussed before and introduces a couple of new ideas. Let us look in detail at how it works:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We set the value we want for each of the parameters. The parameter names (the array indices) are the names as they appear in <em>/etc/login.defs</em>. In this case, we want to set a maximum password lifetime of 180 days, a minimum of 10 days between password changes, and a warning period of 5 days before the password expires.</p>
</li>
<li>
<p>Like we said, we need to set these parameters also in <em>/etc/shadow</em> for preexisting users. For this reason, we define the field number in which each parameter appears in this file. This will allow us to make the promise that edits <em>/etc/shadow</em> generic as well.</p>
</li>
<li>
<p>The list variable <code>@(params)</code> holds the list of parameters whose values we want to set, obtained automatically from the <code>logindefs</code> array.  Defining this list will allow us to write generic file-editing promises, as we will see in a moment.</p>
</li>
<li>
<p>We now get to the definition of the exceptions. First we define <code>$(uidthreshold)</code>, which contains the minimum User ID for which changes in <em>/etc/shadow</em> will be applied. (In this case, all users with UID smaller than 500 will be skipped. This includes most system and application users.)</p>
</li>
<li>
<p>Continuing with the exceptions, we define <code>$(skipped_users)</code> and <code>$(skipped_uids)</code>, both of which contain comma-separated lists of usernames and user IDs to skip. This is meant to allow more fine-grained control over users whose parameters should not be modified.</p>
<div class="paragraph">
<p>The exception definitions are combined: both users with a UID lower than <code>$(uidthreshold)</code>, <em>and</em> those listed in <code>$(skipped_users)</code> or <code>$(skipped_uids)</code>, will be skipped when making changes.</p>
</div>
</li>
<li>
<p>We get a list of all the users in the system using the built-in function <a href="http://cf-learn.info/ref/getusers">getusers()</a>. This function returns a list of users and takes two parameters, which allow us to specify lists of users and UIDs that should not be returned, so we use our two variables <code>$(skipped_users)</code> and <code>$(skipped_uids)</code> directly. We store the list of users in the <code>@(users)</code> list variable.</p>
<div class="paragraph">
<p>Additionally, we generate a list of canonified usernames, and store them in the <code>@(cusers)</code> array. Most usernames should be safe to use in class names, but it’s better to do this conversion anyway to have the certainty that they will not produce errors.</p>
</div>
</li>
<li>
<p>In the <a href="http://cf-learn.info/ref/classes"><code>classes:</code></a> section of the policy, we finally start applying the logic of the policy to decide which users must be skipped. For this, we make use one more time of CFEngine’s implicit looping to create per-users classes named skip___username__. The class is defined using the built-in function <a href="http://cf-learn.info/ref/islessthan">islessthan()</a> to compare the user ID of the current user (the current username is contained in <code>$(users)</code> by the magic of implicit looping, and its user ID is obtained using the <a href="http://cf-learn.info/ref/getuid">getuid()</a> function) against the threshold defined in the <code>$(uidthreshold)</code> variable. The class skip___username__ will be defined for all those users for which the condition is true.</p>
<div class="paragraph">
<p>Finally, by this point we have the list of users to edit, the list and values of the parameters to modify, and all the per-user classes to tell us which users need to be skipped. Now we will apply these pieces of information into editing <em>/etc/login.defs</em> and <em>/etc/shadow</em>.</p>
</div>
</li>
<li>
<p>We use a <a href="http://cf-learn.info/ref/files"><code>files:</code></a> promise to edit the values in <em>/etc/login.defs</em>. This is a fairly simple promise: we use the <code>set_config_values()</code> bundle just like we did in <a href="#editing-etcsshd_config">Editing /etc/sshd_config</a>.</p>
</li>
<li>
<p>The second files: promise does the editing of <em>/etc/shadow</em> for all users in the system. Note that this promise is parameterized using the <code>$(params)</code> variable, which means that in practice it is evaluated as three promises: one for each element of <code>@(params)</code>. Note that we use <code>$(params)</code> even in the handle and comment of the promise, so that we can clearly identify which parameters failed.</p>
<div class="paragraph">
<p>The promise also loops over all the available users, thanks to the reference to the <code>$(users)</code> variable. The <a href="http://cf-learn.info/ref/ifvarclass"><code>ifvarclass</code></a> attribute indicates that only those users for which the skip___username__ class is not defined will be examined.</p>
</div>
<div class="paragraph">
<p>The editing work is done, as usual, by the <a href="http://cf-learn.info/ref/edit_line"><code>edit_line</code></a> attribute. This attribute tells CFEngine that the corresponding field for each parameter (as indicated by <code>$(fieldnum[$(params)])</code> must be set to the correct value, as stored in <code>$(logindefs`</code>[$(params)])<code>. The `set_user_field()</code> bundle comes from the standard library.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_security_scanning">Security Scanning</h4>
<div class="paragraph">
<p>Let us now look at another way to use CFEngine as a security tool. A common strategy is to establish mechanisms to detect unwanted file changes—in fact one of the oldest and most respected security tools, Tripwire, does precisely this, and is the centerpiece of a successful business venture. CFEngine can also perform monitoring for file changes. CFEngine keeps cryptographic hash values for all the files it manages in order to detect changes that may trigger certain actions (for example, the file may need to be re-copied from a remote server, or fixed in some way). The trick is to leverage this database to focus on change detection as the end objective.</p>
</div>
<div class="paragraph">
<p>Looking at the CFEngine reference manual, we find that there exists a <a href="http://cf-learn.info/ref/changes">changes</a> attribute to <a href="http://cf-learn.info/ref/files">files:</a> promises. It is defined as a body, which means it needs to be declared as an external body part. It looks promising, since it supports the following attributes: <a href="http://cf-learn.info/ref/hash">hash</a>, report_changes, update_hashes and report_diffs.</p>
</div>
<div class="paragraph">
<p>The standard library is a good source for learning how to use different CFEngine constructs, and in this case it doesn’t disappoint. Looking for “body changes” definitions, we find the following little gem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">changes</span> <span class="tok-nf">detect_all_change</span>
<span class="tok-p">{</span>
        <span class="tok-kr">hash</span>           <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;best&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">report_changes</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;all&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">update_hashes</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;yes&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This seems to be exactly what we need. And indeed, it is all we need if we only want to monitor a single file. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">monitor_files</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/bin/ls&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/etc/passwd&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/etc/motd&quot;</span> <span class="tok-p">};</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(files)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">changes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">detect_all_change</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This simple bundle allows us to define an arbitrary list of files to monitor in the @(files) list, and will produce an alert when one of them changes. The first time you run it, you will see something like this, as CFEngine adds the hashes of the files to its database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent -KI -f ./monitor_one_file.cf
<span class="tok-go">2013-10-14T04:34:48+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  File &#39;/bin/ls&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:34:48+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  File &#39;/bin/ls&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:34:48+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  File &#39;/etc/passwd&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:34:48+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  File &#39;/etc/passwd&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:34:48+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  File &#39;/etc/motd&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:34:48+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  File &#39;/etc/motd&#39; was not in &#39;sha1&#39; database - new file found</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>I have switched to using the short form of the cf-agent command-line options (-KI instead of --no-lock --inform) now that you have seen them a few times. I will continue using the short form throughout the rest of the book.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Afterward, if any of the files is modified, CFEngine will produce the appropriate alerts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> <span class="tok-nb">echo</span> <span class="tok-s2">&quot;Hello world&quot;</span> &gt;&gt; /etc/motd
<span class="tok-gp">#</span> cf-agent -KI -f ./monitor_one_file.cf
<span class="tok-go">2013-10-14T04:36:38+0000    error: Hash &#39;md5&#39; for &#39;/etc/motd&#39; changed!</span>
<span class="tok-go">2013-10-14T04:36:38+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  Updating hash for &#39;/etc/motd&#39; to &#39;MD5=53d50cd5338eef7f35afb9e5bb1c6972&#39;</span>
<span class="tok-go">2013-10-14T04:36:38+0000    error: Hash &#39;sha1&#39; for &#39;/etc/motd&#39; changed!</span>
<span class="tok-go">2013-10-14T04:36:38+0000    error: /monitor_files/files/&#39;$(files)&#39;:</span>
<span class="tok-go">  Updating hash for &#39;/etc/motd&#39; to &#39;SHA=62c6f6d8a41279e2f07f4818b8563375413a5818&#39;</span>
<span class="tok-go">2013-10-14T04:36:38+0000   notice: Last modified time for &#39;/etc/motd&#39;</span>
<span class="tok-go">  changed &#39;Mon Oct 14 04:34:44 2013&#39; -&gt; &#39;Mon Oct 14 04:36:36 2013&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each file is checked (and reported) twice because we are using <code>hash &#8658; "best"</code>, which according to the documentation “correlates the best two available algorithms known in the OpenSSL library.” We could specify a specific algorithm (e.g. "sha256") to check each file only once.</p>
</div>
<div class="paragraph">
<p>As written, the detect_all_change body will automatically update the hashes database whenever a change is detected, but changing the value of update_hashes to "no" would prevent this from happening, and it would keep warning you about changes until you update the database.</p>
</div>
<div class="paragraph">
<p>More useful in many cases would be the ability to monitor whole directories for unauthorized changes. For this we use the same detect_all_change body, but we add additional attributes to the <a href="http://cf-learn.info/ref/files">files:</a> promise that uses it, so that it recurses into the directories we specify:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">monitor_for_changes</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files_dirs</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/bin&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/etc/passwd&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/etc/motd&quot;</span> <span class="tok-p">};</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(files_dirs)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">changes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">detect_all_change</span><span class="tok-p">,</span>
        <span class="tok-kr">depth_search</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">recurse</span><span class="tok-p">(</span><span class="tok-s">&quot;inf&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we are combining in the same list both directories and files that we want to monitor. When running this bundle for the first time, you will see how CFEngine populates its database of hashes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent -KI -f ./monitor_for_changes.cf
<span class="tok-go">2013-10-14T04:39:19+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/chown&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:19+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/chown&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:19+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/tar&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:19+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/tar&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:19+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/kbd_mode&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:19+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/kbd_mode&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">...</span>
<span class="tok-go">2013-10-14T04:39:20+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/etc/passwd&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:20+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/etc/passwd&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:20+0000  warning: depth_search (recursion) is promised for a</span>
<span class="tok-go">  base object &#39;/etc/passwd&#39; that is not a directory</span>
<span class="tok-go">2013-10-14T04:39:20+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/etc/motd&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:20+0000    error: /monitor_for_changes/files/&#39;$(files_dirs)&#39;:</span>
<span class="tok-go">  File &#39;/etc/motd&#39; was not in &#39;sha1&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:39:20+0000  warning: depth_search (recursion) is promised for a</span>
<span class="tok-go">  base object &#39;/etc/motd&#39; that is not a directory</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the two warning messages I have highlighted — CFEngines tells us that it cannot recurse into files. It will still compute the hashes and monitor the files for changes, but if we want to eliminate these spurious warnings, we can change the bundle to use two lists, one for directories and one for files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">monitor_for_changes</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">dirs</span><span class="tok-p">&quot;</span>  <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/bin/&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/usr/bin/&quot;</span> <span class="tok-p">};</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">files</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/etc/passwd&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/etc/motd&quot;</span> <span class="tok-p">};</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(dirs)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">changes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">detect_all_change</span><span class="tok-p">,</span>
        <span class="tok-kr">depth_search</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">recurse</span><span class="tok-p">(</span><span class="tok-s">&quot;inf&quot;</span><span class="tok-p">);</span>

      <span class="tok-s">&quot;</span><span class="tok-si">$(files)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">changes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">detect_all_change</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a recursive search, CFEngine will detect new files, in addition to file changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> touch /bin/blah
<span class="tok-gp">#</span> cf-agent -KI -f ./monitor_for_changes.cf
<span class="tok-go">2013-10-14T04:43:59+0000    error: /monitor_for_changes/files/&#39;$(dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/blah&#39; was not in &#39;md5&#39; database - new file found</span>
<span class="tok-go">2013-10-14T04:43:59+0000    error: /monitor_for_changes/files/&#39;$(dirs)&#39;:</span>
<span class="tok-go">  File &#39;/bin/blah&#39; was not in &#39;sha1&#39; database - new file found</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Unfortunately, as of 3.5.2, there is a bug in CFEngine which prevents it from detecting when a file in a monitored directory is deleted unless you specify update_hashes as “no” in the detect_all_change body. In this case, if a file disappears, you will see a message like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2013-10-14T04:51:48+0000    error: /monitor_for_changes:
  File '/bin/blah' no longer exists</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The weak point of any file-change monitoring solution such as the one described above, or in Tripwire, is the hashes database. If an attacker manages to modify the database, he can update it with the new hash values of any files he modifies, and those changes will not be detected nor reported.</p>
</div>
<div class="paragraph">
<p>One way in which CFEngine can help to solve this problem is by performing distributed monitoring of the hash database. CFEngine is able to automatically and transparently distribute the monitoring among groups of hosts so that if the hash database is modified in any one of them, a group of others will detect the change and notify about it. The idea is that an attacker might modify the database in a single host, but if that database is replicated across several other hosts, it’s very unlikely that the attacker will be able to modify all those copies simultaneously.</p>
</div>
<div class="paragraph">
<p>For this, we again use CFEngine’s file-comparison abilities, coupled with its ability to automatically determine groups of hosts. The <a href="http://cf-learn.info/ref/peers">peers()</a> function allows us to break a list of hosts into subsets of arbitrary size, and allows each host to determine its “neighbors” in the group. Using this capability, we can instruct hosts to cross-copy the database file among themselves. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">neighborhood_watch</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">neighbors</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">peers</span><span class="tok-p">(</span><span class="tok-s">&quot;/var/cfengine/inputs/hostlist&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;#.*&quot;</span><span class="tok-p">,</span><span class="tok-mi">4</span><span class="tok-p">),</span>   <b class="conum">(1)</b>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Get my neighbors from a list of all hosts&quot;</span><span class="tok-p">;</span>
 <span class="tok-kd">files</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;</span><span class="tok-si">$(sys.workdir)</span><span class="tok-s">/nw/</span><span class="tok-si">$(neighbors)</span><span class="tok-s">_checksum_digests.tcdb&quot;</span>   <b class="conum">(2)</b>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Watch our peers remote hash tables!&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">remote_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(sys.workdir)</span><span class="tok-s">/checksum_digests.tcdb&quot;</span><span class="tok-p">,</span>
                            <span class="tok-s">&quot;</span><span class="tok-si">$(neighbors)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>   <b class="conum">(3)</b>
     <span class="tok-kr">action</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">neighbor_report</span><span class="tok-p">(</span><span class="tok-s">&quot;File changes observed on </span><span class="tok-si">$(neighbors)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>   <b class="conum">(4)</b>
     <span class="tok-kr">depends_on</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;grant_hash_tables&quot;</span> <span class="tok-p">};</span>   <b class="conum">(5)</b>
<span class="tok-p">}</span>

<span class="tok-k">body</span> <span class="tok-k">action</span> <span class="tok-nf">neighbor_report</span><span class="tok-p">(</span><span class="tok-nv">msg</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
     <span class="tok-kr">ifelapsed</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;30&quot;</span><span class="tok-p">;</span>
     <span class="tok-kr">log_string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(msg)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s examine how this works.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We assume each client has a list of all hosts in the network stored at
<em>/var/cfengine/inputs/hostlist</em>. This
file could be generated by the policy hub using the
<a href="http://cf-learn.info/ref/hostsseen">hostsseen()</a> function (left as an
exercise to the reader), and then copied using CFEngine to all other
hosts. The <a href="http://cf-learn.info/ref/peers">peers()</a> function splits
this list into chunks of the given size (4 hosts per group in this
case), and assigns into the @(neighbors) list the list of the peers of
the current host. In each host,
<a href="http://cf-learn.info/ref/peers">peers()</a> will determine the group to
which the current host belongs, and then return all the hosts in that
group, except the current one.</p>
</li>
<li>
<p>The <a href="http://cf-learn.info/ref/files"><code>files:</code></a> promise will repeat for
each one of the neighbors using implicit looping, and will copy their
hash database into a local file under <em>/var/cfengine/nw/</em>, named
after the corresponding host name.</p>
</li>
<li>
<p>The file to be copied from each neighbor is
<em>/var/cfengine/checksum_digests.tcdb</em>. (This filename may change
depending on the database engine that CFEngine is using)</p>
</li>
<li>
<p>We determine that the action to be taken when the promise is repaired
is to generate a log message about it, indicating the host in which
the discrepancy was found.</p>
<div class="paragraph">
<p>Let’s analyze for a moment the behavior of this code. It’s a simple
file-copy operation, like the ones we use to copy updated policies
from the policy hub into the clients. However, in this case we are
dealing with a file that should very rarely change, so whenever it
changes, it’s a noteworthy event. When the hash database is modified
in any of the neighbors, the other neighbors will notice this change
and re-copy the file to their local disk. The promise is marked as
repaired, and a message is generated.</p>
</div>
</li>
<li>
<p>The correct execution of this neighborhood-watch technique depends on
being able to copy the hash databases among neighbors. For this
reason, we make this promise dependent on another promise that sets
the appropriate access rules for the file, and which must be defined
in a bundle of type <a href="http://cf-learn.info/ref/server"><code>server</code></a>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">server</span> <span class="tok-nf">access_rules</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
 <span class="tok-kd">vars</span><span class="tok-p">:</span>
   <span class="tok-c"># List here the IP masks that we grant access to on the server</span>
   <span class="tok-p">&quot;</span><span class="tok-nv">acl</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span>
                   <span class="tok-s">&quot;</span><span class="tok-si">$(sys.ipv4)</span><span class="tok-s">/24&quot;</span><span class="tok-p">,</span>
                   <span class="tok-s">&quot;128.39.89.233&quot;</span><span class="tok-p">,</span>
                   <span class="tok-s">&quot;2001:700:700:3.*&quot;</span>
   <span class="tok-p">},</span>
     <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Define an acl for the machines to be granted accesses&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;common_def_vars_acl&quot;</span><span class="tok-p">;</span>

 <span class="tok-kd">access</span><span class="tok-p">:</span>
   <span class="tok-s">&quot;/var/cfengine/checksum_digests.tcdb&quot;</span>
     <span class="tok-kr">handle</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;grant_hash_tables&quot;</span><span class="tok-p">,</span>
     <span class="tok-kr">admit</span>   <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nv">@(acl)</span> <span class="tok-p">},</span>
     <span class="tok-kr">maproot</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nv">@(acl)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bundles of this type define behavior of the
<a href="http://cf-learn.info/ref/cf-serverd"><code>cf-serverd</code></a> process, and among
other things, define which machines can access which files through it.
The <a href="http://cf-learn.info/ref/cf-serverd"><code>cf-serverd</code></a> process running
on each machine is the one that will provide access to the
<em>/var/cfengine/checksum_digests.tcdb</em> file so that neighbors can copy
it as described before. For this to work, we are using an
<a href="http://cf-learn.info/ref/access"><code>access:</code></a> promise to specify who can
read this file. The <a href="http://cf-learn.info/ref/admit"><code>admit</code></a> attribute
indicates which IP addresses will have permission to access the file,
and the <a href="http://cf-learn.info/ref/maproot"><code>maproot</code></a> attribute
indicates which machines can have access to any file on the system. We
set both of these attributes to the value of the <code>@(acl)</code> list, which
we define in the <a href="http://cf-learn.info/ref/vars"><code>vars:</code></a> section. The
first value in <code>@(acl)</code> is <code>"$(sys.ipv4)/24"</code>, which indicates that we
want the whole class-C network segment (<code>/24</code>) in which the machine is
located (<code>$(sys.ipv4)</code> contains the current IP address), to have
access.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> We also specify,
for the sake of example, two individual IP addresses (one IPv4, one
IPv6) as part of @(acl).</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Using this technique, we can have a self-maintaining, self-protecting system for monitoring file changes. We can add more hosts into the peer groups to increase security (by increasing the number from 4 to whatever we need), at the expense of additional file copy operations among the hosts.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_additional_cfengine_features_and_information">Additional CFEngine Features and Information</h3>
<div class="paragraph">
<p>In this chapter we have seen a number of examples of CFEngine policy, through which we have explored many of the CFEngine language features and abilities. Of course, this is only the beginning, and I cannot possibly show you examples of all the useful features of the CFEngine policy language. In this section I will give you some pointers to some of those features, for you to explore on your own.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/bundle-edit_xml">Editing XML files</a></dt>
<dd>
<p>The <a href="http://cf-learn.info/ref/bundle-edit_xml">edit_xml</a> bundle type allows you to specify instructions for editing XML files, analogous to the way <a href="http://cf-learn.info/ref/edit_line">edit_line</a> bundles allow you to specify editing operations on plain text files. With <a href="http://cf-learn.info/ref/bundle-edit_xml">edit_xml</a> you can perform XPath-based selection and editing of an XML file to insert, delete, and modify arbitrary nodes and attributes in the file.</p>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/guest_environments">Managing virtual machines</a></dt>
<dd>
<p>CFEngine allows you to manage virtual machines through <a href="http://cf-learn.info/ref/guest_environments">guest_environments:</a> promises. If CFEngine was compiled with <a href="http://libvirt.org">libvirt</a> support, these promises allow you to interface with Xen, KVM, VMWare and other virtualization solutions.</p>
</dd>
<dt class="hdlist1"><a href="http://cfengine.com/docs/3.5/reference-promise-types-databases.html">Managing databases</a></dt>
<dd>
<p><a href="http://cf-learn.info/ref/databases">databases:</a> promises allow you to interact with PostgreSQL and MySQL databases (and, in CFEngine Enterprise, with LDAP and Windows Registry) to manage their structure and contents.</p>
</dd>
<dt class="hdlist1"><a href="http://cfengine.com/docs/3.5/reference-functions.html">CFEngine functions</a></dt>
<dd>
<p>The CFEngine language includes many functions that allow you to manipulate or obtain data or system information. As with any language, having a mental overview of the types of functions available will help you while writing policies, and just reading through the list may trigger ideas of things you could do with CFEngine to better manage your systems.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>CFEngine 3.5.0 introduced a large number of new functions for data and class manipulation, including <a href="http://cf-learn.info/ref/sublist">sublist()</a>, <a href="http://cf-learn.info/ref/uniq">uniq()</a>, <a href="http://cf-learn.info/ref/filter">filter()</a>, <a href="http://cf-learn.info/ref/format">format()</a>, <a href="http://cf-learn.info/ref/filestat">filestat()</a>, <a href="http://cf-learn.info/ref/classesmatching">classesmatching()</a>, <a href="http://cf-learn.info/ref/ifelse">ifelse()</a>, and many others.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you work more with CFEngine, you will discover new features and new ways of doing things. Now that you have read through this chapter, I encourage you to go back and look at the list of resources in <a href="../../book/chapter03/#cfengine-information-resources">CFEngine Information Resources</a>. Many of them will probably make much more sense now.</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The concept of “verify” is dependent on the package manager, and some <a href="http://cf-learn.info/ref/package_method">package_method</a> bodies do not support it.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. This policy was originally written by Aleksey Tsalolikhin. It is available in the <a href="https://github.com/cfengine/design-center">CFEngine Design Center</a> and is used with permission.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. This is just an example. You would of course need to adapt it according to the specifics of your network.
</div>
</div>

  </div>
</div>


</body>
</html>
