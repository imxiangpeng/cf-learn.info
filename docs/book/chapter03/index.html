<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Chapter 3: CFEngine Basics &middot; Diego Zamboni</title>

  
  <link rel="stylesheet" href="http://cf-learn.info/css/poole.css">
  <link rel="stylesheet" href="http://cf-learn.info/css/hyde.css">
  <link rel="stylesheet" href="http://cf-learn.info/css/poole-overrides.css">
  <link rel="stylesheet" href="http://cf-learn.info/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://cf-learn.info/css/hyde-x.css">
  <link rel="stylesheet" type="text/css" href="http://cf-learn.info/css/socialicious.css" media="screen" />
  
  <link href='http://fonts.googleapis.com/css?family=Quattrocento|Quattrocento+Sans' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="http://cf-learn.info/css/tachyons.min.css"/>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://cf-learn.info/apple-touch-icon-144-precomposed.png">
  <link href="http://cf-learn.info/favicon.png" rel="icon">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Learning CFEngine 3 &middot; Diego Zamboni" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body class="lh-copy">
<div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
      <h1>Learning CFEngine 3</h1>
      
    </div>

    <ul class="sidebar-nav">
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/home/">Home</a></li>
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/the-author/">The Author</a></li>
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/post/">The Blog</a></li>
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/book/">The Book</a></li>
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/the-code/">The Code</a></li>
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/the-raves/">The Raves</a></li>
      
        <li class="sidebar-nav-item"><a  href="http://cf-learn.info/contact/">Contact</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      
      
      <a href="http://twitter.com/LearningCF3"><li class="icon-twitter"></li></a>&nbsp;
      
      
    </ul>

    <div class="sidebar-sticky"><p>&copy; 2017 Diego Zamboni<br/>
        Powered by <a href="http://gohugo.io">Hugo</a></p></div>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>Chapter 3: CFEngine Basics</h1>
    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#ch-cfengine-basics">CFEngine Basics</a>
<ul class="sectlevel2">
<li><a href="#I_sect13_d1e1706">Basic Principles</a></li>
<li><a href="#sec-cfengine-components">CFEngine Components</a></li>
<li><a href="#a-first-example">A First Example</a></li>
<li><a href="#cfengine-policy-structure">CFEngine Policy Structure</a></li>
<li><a href="#clients-and-servers-2">Clients and Servers</a></li>
<li><a href="#cfengine-information-resources">CFEngine Information Resources</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="ch-cfengine-basics">CFEngine Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will take a more detailed look at the basic concepts behind CFEngine, including its theoretical foundation, the syntax and constructs of its policy language, and some unique aspects of its behavior. I will also point you to some of the many online resources available for learning and improving your CFEngine skills.</p>
</div>
<div class="sect2">
<h3 id="I_sect13_d1e1706">Basic Principles</h3>
<div class="paragraph">
<p>One of CFEngine’s unique characteristics is that it is built upon predefined, solid theoretical and behavioral principles. These principles guide the design and implementation of all the CFEngine components and of its policy language, and ensure that the behavior of those components remains consistent. These principles are: desired-state configuration, a minimum base set of native operations, promise theory, and convergent configuration. Let us look at them in more detail.</p>
</div>
<div class="sect3">
<h4 id="principles">Desired-State Configuration</h4>
<div class="paragraph">
<p>CFEngine is different from many other automation mechanisms in that you do not need to tell it what to do. Instead, you specify the state in which you wish the system to be, and CFEngine will automatically decide the actions to take to reach the desired state, or as close to it as possible. In programming language terms, we say that the CFEngine policy language is <em>declarative</em>, as opposed to <em>imperative</em>.</p>
</div>
<div class="paragraph">
<p>These are some examples of the things that you can express to CFEngine as desired states:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>“Make sure file <em>/etc/ssh/sshd_config</em> contains the line UseDNS no”</p>
</li>
<li>
<p>“Make sure user mysql exists/does not exist”</p>
</li>
<li>
<p>“Make sure process httpd is (not) running”</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At a higher level of abstraction, you can encapsulate CFEngine operations and express high-level desired states:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>“Make sure all web servers have Apache installed”</p>
</li>
<li>
<p>“Make sure all root accounts have the same, centrally-designated password”</p>
</li>
<li>
<p>“Make sure parameters UseDNS and PermitRootLogin are disabled on all sshd configurations, except on servers dbsrv01 and dbsrv02, where PermitRootLogin should be enabled”</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And at an even higher level, you can express top-level desired states like these:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>“Configure host dbsrv01 as a database server”</p>
</li>
<li>
<p>“Create a new cluster of VMs to use as web servers”</p>
</li>
<li>
<p>“Give me a new datacenter in EC2 region ap-northeast-1”</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course, in reality things are not so simple. At some point, CFEngine needs to know what specific changes to make to the system, and how to make them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_cfengine_operations">Basic CFEngine Operations</h4>
<div class="paragraph">
<p>These are some of the basic operations that CFEngine natively knows how to perform:<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract information from the system itself about its current state and configuration.</p>
</li>
<li>
<p>Inspect and modify the contents of text and XML files.</p>
</li>
<li>
<p>Check for and manipulate file permissions and ownerships.</p>
</li>
<li>
<p>Check for existence of processes running in the system.</p>
</li>
<li>
<p>Check for existence of users in the system.</p>
</li>
<li>
<p>Run programs and check their exit status.</p>
</li>
<li>
<p>Check and manipulate packages installed on the system.</p>
</li>
<li>
<p>Check and manipulate services on Unix systems.</p>
</li>
<li>
<p>Query and manipulate databases and their contents (as of this writing, MySQL, PostgreSQL and SQLite are supported).</p>
</li>
<li>
<p>Examine and manipulate POSIX Access Control Lists (ACLs).</p>
</li>
<li>
<p>Manipulate virtual machines on several different platforms (as of this writing, VMware ESX, KVM, Xen and VirtualBox are supported).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The commercial version of CFEngine has some additional capabilities, including the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check and manipulate the Windows registry, event logs, and services.</p>
</li>
<li>
<p>Query and manipulate LDAP (and, by extension, Active Directory) databases.</p>
</li>
<li>
<p>Examine and manipulate Windows Access Control Lists (ACLs).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These operations are sufficient to perform most configuration tasks on a system. At the lowest possible level, CFEngine contains functional specifications of how to make changes to the system. At the highest level, however, you declare what you want as shown in <a href="#principles">Desired-State Configuration</a>, and leave the details to CFEngine.</p>
</div>
<div class="paragraph">
<p>CFEngine ships with some built-in libraries that perform more advanced operations using these basic capabilities, and you can also build your own libraries to perform custom checks and activities.</p>
</div>
</div>
<div class="sect3">
<h4 id="promise-theory">Promise Theory</h4>
<div class="paragraph">
<p>CFEngine 3 works on top of a theoretical model called <a href="http://research.iu.hio.no/promises.php">Promise Theory</a>. This theory models the behavior of autonomous agents in an environment without central authority, based only on promises of behavior made by each agent, and shows that even without central control, the system can converge to a stable state.</p>
</div>
<div class="paragraph">
<p>Promise Theory underlays one of the basic tenets of CFEngine: voluntary cooperation. In CFEngine, each system participates voluntarily, makes promises only about its own behavior (if you think about it, it makes no sense for a system to make promises about someone else’s behavior), and cannot be forced to accept commands or information from any external entities. This gives CFEngine very strong security properties, since it means that CFEngine running on a host cannot be coerced into modifying its behavior according to some external influence. It may <em>choose</em> to do so (for example, by getting policies from a central server), but unlike many other configuration management systems, CFEngine does not require you to open a command channel through which each host can be given instructions (all you can do is “ping” clients so that they run their policies before their scheduled time, or to query them for information, but never to perform arbitrary actions or commands).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>It’s worth mentioning that CFEngine’s principle of voluntary cooperation is more than a theoretical nicety in terms of security: in its entire 20-year history (spanning versions 1 through 3), CFEngine has had only <a href="http://web.nvd.nist.gov/view/vuln/search-results?query=cfengine">six published vulnerabilities</a>, only three of which were remotely exploitable. The last one of those was published in 2005, still in CFEngine 2. CFEngine 3 has the impressive record of zero published vulnerabilities since its release in 2009.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A promise is simply a declaration of <em>intent</em>, a model of the desired state of the promiser. A promise does not imply that the desired state will be reached in the next iteration (or ever), but implies a capability for verifying whether the promise has been satisfied. Through this seemingly simple characteristic, promise theory allows CFEngine to deal with a crucial aspect of systems management: operational uncertainty. Systems are under constant change, both intentional (changing requirements, changing software, changing user behavior, security attacks) and accidental (disconnected network links, disappearing resources, software crashes) and have to react to it, often with incomplete information. Promise theory allows CFEngine to deal with these conditions in a resilient fashion.</p>
</div>
<div class="paragraph">
<p>Promise Theory was developed initially as the foundation for CFEngine’s behavior (in fact, the policy language in CFEngine 3 was redesigned to reflect this theory), but it has found more general applications in Computer Science and in other disciplines such as Economics and Organization.</p>
</div>
<div class="paragraph">
<p>According to Promise Theory, everything in CFEngine 3 is a promise, with specifications of what to do if the promise is already satisfied, if the promise was not satisfied but could be fixed, if the promise was not satisfied and could not be fixed, etc. <a href="#tab-promise-examples">Examples of objects (promisers), promises, and repair actions in CFEngine</a> shows some examples of promises you could find in a CFEngine policy, and of the possible actions CFEngine could take automatically if the promise is not kept.</p>
</div>
<table id="tab-promise-examples" class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Examples of objects (promisers), promises, and repair actions in CFEngine</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Promiser</th>
<th class="tableblock halign-left valign-top">Promises to…</th>
<th class="tableblock halign-left valign-top">If not currently kept, CFEngine will…</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…hold a certain value of a certain type.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…store the appropriate value in the variable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…have certain characteristics (permissions, ownership, ACLs, etc.).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…set the desired properties on the file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…exist and to have certain content.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…create the file if needed, modify its content (add, remove or edit lines) to match the desired state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…exist and have certain characteristics (home directory, group, etc.)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…create the user account with the desired characteristics.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A process</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…be running on the system.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…run the appropriate command to create the process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A shell command</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…have been executed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…execute the command and collect its output and exit status.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A directory on the policy hub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…provide access to its content to certain clients.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…reconfigure its access rules to permit or block the access as desired.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An output message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…be generated when certain conditions arise, with a certain frequency and in a certain format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">…produce the appropriate message.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When a promise is not already satisfied (e.g., a file does not exist as it should), CFEngine will take the necessary actions to fix it, according to both its built-in rules and any additional promises declared in the policy.</p>
</div>
<div class="paragraph">
<p>Depending on the current state of the system with respect to a given promise, on the actions that CFEngine took when evaluating a promise, and on the result of those actions, CFEngine defines the following promise states:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Promise kept</dt>
<dd>
<p>The state of the system was already as described by the promise, so no action had to be taken.</p>
</dd>
<dt class="hdlist1">Promise repaired</dt>
<dd>
<p>The state of the system was not as required by the promise, so CFEngine took the appropriate actions, and repaired the system state to match the requirements of the promise.</p>
</dd>
<dt class="hdlist1">Repair failed</dt>
<dd>
<p>Repair actions were attempted by CFEngine, but they failed for some reason (for example, lack of permissions to edit a file). Depending on why the repair action failed, one of the following states may also be set:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Repair denied</dt>
<dd>
<p>Repair actions were attempted by CFEngine, but they failed due to lack of access to some resource.</p>
</dd>
<dt class="hdlist1">Repair timeout</dt>
<dd>
<p>Repair actions were attempted by CFEngine but took too long to execute, and CFEngine cancelled the operation.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A CFEngine policy is constructed out of individual promises that get executed in certain order, and that can interact with other promises. After a promise is evaluated (executed), you can determine its state and act based on it, triggering further actions such as reporting, command execution, or evaluation of other promises.</p>
</div>
</div>
<div class="sect3">
<h4 id="convergent-configuration">Convergent Configuration</h4>
<div class="paragraph">
<p>One of CFEngine’s basic principles is convergent configuration. This means that you don’t have to leave the system in the desired state on the first pass. Instead, you make changes incrementally, getting closer to the objective every time, independently of the starting state of the system. A CFEngine policy may not leave the system completely configured on the first pass, but at least it will make some changes. On subsequent passes, it will continue to make changes, eventually bringing it as close as possible to the desired state.</p>
</div>
<div class="paragraph">
<p>One advantage of convergent configuration, and of the declarative nature of CFEngine, is that you do not need to know the current state of the system in order to correct it. If the system is already in the desired state, a correctly written CFEngine policy will do nothing. If it’s not, CFEngine will iteratively make discrete changes to bring it closer to the ideal, taking only the necessary actions to correct the existing deviations.</p>
</div>
<div class="paragraph">
<p>In order to carry out convergent configuration, CFEngine performs three passes over its policy. During each pass, all the promises in the policy are evaluated. There may be some promises that cannot be evaluated until the second or third pass due to dependencies between different components of the policy, so the multiple passes help CFEngine bring things to a convergent state as soon as possible.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-cfengine-components">CFEngine Components</h3>
<div class="paragraph">
<p>A CFEngine installation contains multiple components that perform different, specific functions, as shown in <a href="#cfengine-components">CFEngine components and their relationships</a>. Dotted lines represent components that execute others, solid lines represent communication among components, and bold lines indicate data flow.</p>
</div>
<div class="paragraph">
<p>Let’s look in more detail at the functionality and role of each one of these components.</p>
</div>
<div id="cfengine-components" class="imageblock">
<div class="content">
<img src="../figs/web/lcfe_0301.png" alt="lcfe 0301">
</div>
<div class="title">Figure 1. CFEngine components and their relationships</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-agent"> cf-agent </a></dt>
<dd>
<p>This is the “instigator of change,” as described in the CFEngine documentation. <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> is the program that evaluates policies and acts on them, making any necessary changes to the system. <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> is normally started directly by the user (for example, we have been running it manually from the command line to test the policies in this book), or by one of two higher-level commands: <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> (as a mechanism for starting it at regular intervals) or <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> (in response to the <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> command executed from a different host). Note that depending on its policies, <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> can in turn be responsible for restarting <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a>, cf-serverd or <a href="http://cf-learn.info/ref/cf-monitord">cf-monitord</a> if they have stopped for any reason (in addition, <a href="http://cf-learn.info/ref/cf-promises">cf-promises</a> is used by <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> to validate its policies before attempting to run them).</p>
<div class="paragraph">
<p>By default, <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> will attempt to run <em>/var/cfengine/inputs/promises.cf</em> (more precisely, the file found by expanding the string $(sys.workdir)/inputs/promises.cf) when invoked, unless a different file is specified using the -f command-line option. If the filename executed produces an error, <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> will try to run <em>/var/cfengine/inputs/failsafe.cf</em>. The idea is for <em>failsafe.cf</em> to be a barebones policy that does little more than try to restore the CFEngine policies to a working state. Normally <em>failsafe.cf</em> will attempt to update the local policies from the policy hub, and it may also try to start <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> and <a href="http://cf-learn.info/ref/cf-monitord">cf-monitord</a> to have at least a minimal CFEngine infrastructure running. If the <em>failsafe.cf</em> file is not found, <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> will generate it.</p>
</div>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-execd"> cf-execd </a></dt>
<dd>
<p>This process executes <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> in a periodic basis, collecting its output, and potentially emailing it somewhere. By default, <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> runs <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> every five minutes, but you can modify its behavior using an executor control body. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">executor</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
    <span class="tok-nc">any</span><span class="tok-p">::</span>

        <span class="tok-kr">splaytime</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;10&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">mailto</span>     <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;cfengine@example.org&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">mailfrom</span>   <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;cfengine@</span><span class="tok-si">$(sys.host)</span><span class="tok-s">.example.org&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">smtpserver</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;mail.example.org&quot;</span><span class="tok-p">;</span>

        <span class="tok-kr">schedule</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;Min00_05&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;Min30_35&quot;</span> <span class="tok-p">};</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the <a href="http://cf-learn.info/ref/schedule">schedule</a> attribute tells <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> to only run <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> every 30 minutes (more precisely, whenever either the Min00_05 or Min30_35 classes are enabled, which would be the case between 00-05 and 30-35 minutes of every hour). The <a href="http://cf-learn.info/ref/splaytime">splaytime</a> parameter tells <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> that the execution could be delayed up to 10 minutes (this is useful in large installations to prevent all the clients from connecting to the server at once). The <a href="http://cf-learn.info/ref/mailto">mailto</a>, <a href="http://cf-learn.info/ref/mailfrom">mailfrom</a> and <a href="http://cf-learn.info/ref/smtpserver">smtpserver</a> attributes determine how email reports will be sent.</p>
</div>
<div class="paragraph">
<p>It is common for <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> to be the one process started by the operating system (for example, through a cron job or an init script) when the system starts. <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a> then runs <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a>, which makes sure through the appropriate policies that <a href="http://cf-learn.info/ref/cf-execd">cf-execd</a>, <a href="http://cf-learn.info/ref/cf-monitord">cf-monitord</a>, and <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> are running in the background, if needed.</p>
</div>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-serverd"> cf-serverd </a></dt>
<dd>
<p>This component implements server functionality in CFEngine—the ability to listen for connections from clients and serve files to them. <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> also has the ability to listen for connections from the <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> process in other hosts, and according to its configuration, respond by executing <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> locally (this is the one reason why you may want to run <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> on CFEngine clients: if you want the policy hub to be able to remotely instruct clients to run <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a>). We will look in more detail at the <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> configuration in <a href="#clients-and-servers-2">Clients and Servers</a>. <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> listens on port TCP/5308, and this is the only port that needs to be open for the clients to be able to communicate with the server.</p>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-runagent"> cf-runagent </a></dt>
<dd>
<p>Invokes <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> on remote hosts so that they evaluate their policies. This is the only form of control a remote machine may exercise over another in CFEngine. We will talk more about this in <a href="#remote-execution-cfrunagent">CFEngine Remote Execution Using cf-runagent</a>.</p>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-key"> cf-key </a></dt>
<dd>
<p>This is one of the first commands you run when installing CFEngine on a new host. It creates a cryptographic key pair for the current host, which is used for authentication when communicating with the policy hub or any other CFEngine server.</p>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-monitord"> cf-monitord </a></dt>
<dd>
<p>This process is intended to run continuously in the background. It collects statistical information about different aspects of the system and makes it available to <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> through the specialmon variable context. Some examples of the information collected by <a href="http://cf-learn.info/ref/cf-monitord">cf-monitord</a> are the numbers of users with active processes in the system (mon.value_users), free space in the root disk partition (mon.value_diskfree), and kernel load average (mon.value_loadavg). For most values <a href="http://cf-learn.info/ref/cf-monitord">cf-monitord</a> also keeps a running average and the standard deviation (for example, mon.av_loadvg and mon.dev_loadavg).</p>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/cf-hub">cf-hub</a></dt>
<dd>
<p>This process exists only in CFEngine Enterprise, and is responsible for collecting from all the clients information about their current status, reports and monitoring information, for analysis and reporting purposes. cf-hub periodically connects to the cf-serverd process on all the clients it knows about (this is, all the clients that have bootstrapped to it) to collect this information. If it cannot connect to a client, this information is also reported in the Enterprise console.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="a-first-example">A First Example</h3>
<div class="paragraph">
<p>Let’s consider the simple case of modifying the configuration of an ssh server. At the top level, we need to make sure the sshd service is up and running. With CFEngine, we can simply write the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">services</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;ssh&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will by default enable and make sure the service is running, on any operating system. If we wanted to make sure the service is not running, we would simply need to write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">services</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;ssh&quot;</span> <span class="tok-kr">service_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;stop&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>A new model for <a href="http://cf-learn.info/ref/services">services:</a> promises was introduced in CFEngine 3.3.0, which allows greatly simplified service management as shown above. In previous versions, you needed to manipulate the services through a combination of <a href="http://cf-learn.info/ref/processes">processes:</a> and <a href="http://cf-learn.info/ref/commands">commands:</a> promises.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, let’s go down a level and change the configuration of the ssh daemon. Traditionally, we would do this sort of task with a shell script. The following snippet from a shell script is intended to add a line to <em>/etc/ssh/sshd_config</em> to prevent root logins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>echo &quot;PermitRootLogin no&quot; &gt;&gt; /etc/ssh/sshd_config</code></pre>
</div>
</div>
<div class="paragraph">
<p>As is, this code will add a new line to the file every time it runs. It assumes that the file does not contain the line already. Of course, you can add checks for this, but the code quickly becomes unreadable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>(grep -iq &#39;PermitRootLogin&#39; /etc/ssh/sshd_config ||
 echo &quot;PermitRootLogin no&quot; &gt;&gt; /etc/ssh/sshd_config) &amp;&amp;
 sed -i &#39;s/^.*PermitRootLogin.*$/PermitRootLogin no/;&#39; /etc/ssh/sshd_config</code></pre>
</div>
</div>
<div class="paragraph">
<p>This snippet uses the grep command to determine if the file alredady contains the PermitRootLogin string, and based on the result either adds the corresponding line or uses the sed command to edit the existing line.</p>
</div>
<div class="paragraph">
<p>Compare this with the equivalent CFEngine declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">files</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span> <span class="tok-o">-&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;security_officer@example.net&quot;</span> <span class="tok-p">}</span>
    <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Disallow direct root login&quot;</span><span class="tok-p">,</span>
    <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">replace_or_add</span><span class="tok-p">(</span><span class="tok-s">&quot;.*PermitRootLogin.*&quot;</span><span class="tok-p">,</span>
                                <span class="tok-s">&quot;PermitRootLogin no&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The CFEngine policy will add the line only if it is not there already. Additionally, you can see that CFEngine rules allow comments as rule attributes. These comments can be made available as the policy executes, allowing administrators to better understand and debug the actions taken by CFEngine. CFEngine also allows setting a promisee or stakeholder for each promise ("security_officer@example.net” in this example), which can be used to link promises together, or to indicate what or who might care about a particular promise.</p>
</div>
<div class="paragraph">
<p>Rules in CFEngine can be as detailed or as high-level as you wish. For example, you could generalize the SSH configuration file mechanism and express it like this (and we will look into the details of how to do this in <a href="#editing-etcsshd_config">[editing-etcsshd_config]</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-c"># SSHD configuration to set</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[Protocol]</span><span class="tok-p">&quot;</span>        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[X11Forwarding]</span><span class="tok-p">&quot;</span>   <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;yes&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[UseDNS]</span><span class="tok-p">&quot;</span>          <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;no&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">sshd[PermitRootLogin]</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;no&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span>
        <span class="tok-kr">handle</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;sshd_config&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span>   <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Set sshd configuration&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_config_values</span><span class="tok-p">(</span><span class="tok-s">&quot;sshd&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">classes</span>   <span class="tok-o">=&gt;</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;restart_sshd&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">commands</span><span class="tok-p">:</span>
    <span class="tok-nc">restart_sshd</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;/etc/init.d/sshd reload&quot;</span>
        <span class="tok-kr">handle</span>  <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;sshd_restart&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Restart sshd if the config file was modified&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This CFEngine policy allows you to define arbitrary configuration parameters in the sshd array defined at the top (in the <a href="http://cf-learn.info/ref/vars">vars:</a> section), which will be applied by the <a href="http://cf-learn.info/ref/files">files:</a> section by modifying or adding only those parameters that need to be fixed. Finally, sshd will be restarted only if any changes were made. In other words, the promise of having the right parameters in the file could be satisfied just by checking that they’re set properly already (the “Promise kept” state described earlier), so the restart will take place only in the “Promise repaired” state.</p>
</div>
<div class="paragraph">
<p>Let’s go back to our description of promises, to start figuring out what is happening in this policy. The <a href="http://cf-learn.info/ref/vars">vars:</a> section is simply variable declarations—in this case, an array indexed by configuration parameter names, and containing the values of each parameter. In the <a href="http://cf-learn.info/ref/files">files:</a> section, the <em>/etc/ssh/sshd_config</em> file promises to have its content edited according to the specifications contained in the set_config_values() <em>bundle</em> (a named collection of CFEngine promises), and to set the restart_sshd class if the file needed to be repaired (i.e. modified to satisfy the promise). Finally, in the <a href="http://cf-learn.info/ref/commands">commands:</a> section, the command to restart sshd promises to run only if the restart_sshd class is set (if this class is set, it means that the file was modified, so the daemon needs to be restarted for the changes to take effect).</p>
</div>
<div class="paragraph">
<p>Not shown in this example is the set_config_values() bundle. This bundle is part of the CFEngine Standard Library (described in <a href="#cfengine_stdlib">CFEngine Standard Library</a>), and which takes care of the actual editing of the file to set the desired parameters, using the built-in file-editing primitives in CFEngine. We will examine this bundle in detail in <a href="#editing-etcsshd_config">[editing-etcsshd_config]</a>.</p>
</div>
<div class="paragraph">
<p>CFEngine allows you to express configuration policies at the level of abstraction you wish, leaving lower-level details out of sight but available when you need them. Now, let’s take a more detailed look at the syntax of a CFEngine policy.</p>
</div>
</div>
<div class="sect2">
<h3 id="cfengine-policy-structure">CFEngine Policy Structure</h3>
<div class="paragraph">
<p>The syntax of the CFEngine 3 configuration files is very uniform, since everything is a promise. In general, every element in a CFEngine policy has the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">promise_type</span><span class="tok-p">:</span>
  <span class="tok-nc">class_expression</span><span class="tok-p">::</span>
    <span class="tok-s">&quot;promiser&quot;</span> <span class="tok-o">-&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;promisee1&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;promiseeX&quot;</span> <span class="tok-p">}</span>
        <span class="tok-kr">attribute1</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value1</span><span class="tok-p">,</span>
        <span class="tok-kr">attributeX</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">valueX</span><span class="tok-p">;</span>
        <span class="tok-err">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The values that <em>promise_type</em> can have depend on the type of container in which the promise is stored (and we will look at them in detail in <a href="#containers">Bundles, Bodies, and Namespaces</a>). The value of <em>promise_type</em> determines how the <em>"promiser"</em> is interpreted, which <em>attributes</em> are valid and how their corresponding <em>values</em> are used. The attribute values can be either constant values, variables of the types described in <a href="#sec-cfengine-variables">Data Types and Variables in CFEngine</a>, or container names as described in <a href="#containers">Bundles, Bodies, and Namespaces</a>. The type of allowed values is fixed for each attribute.</p>
</div>
<div class="paragraph">
<p>The <em>promisees</em> are optional and, if specified, contain references to other promises that depend on the current one, and are used for documentation. In this way, we can specify which promises affect others or who might care about a particular promise. CFEngine has the ability to produce reports that include this information. Note that specifying promisees has no effect on the execution order of the policy, they are merely for informational purposes. Promisees can be arbitrary strings.</p>
</div>
<div class="paragraph">
<p>The <em>class_expression</em>, if specified, allows the promise to be conditionally executed depending on the value of the expression. If omitted it defaults to any, which is always defined (you can also use the class expression line any:: to make this explicit). We will look at them in detail in <a href="#classes-and-decision-making">Classes and Decision Making</a>.</p>
</div>
<div class="paragraph">
<p>Depending on the type of promise, almost all elements of this syntax, except for the <em>promise_type</em> and the <em>promiser</em>, are optional. For example, to unconditionally execute a command, we would simply state it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">commands</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/bin/ls /&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case <a href="http://cf-learn.info/ref/commands">commands:</a> is the promise type, and specifies that the promisers in the following section are to be interpreted as commands to execute. The promiser, "/bin/ls /" indicates the command to execute. Since no attributes are specified, the command will always be executed and its output reported by CFEngine.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can find some guidance on the style and form of policy writing in the <a href="https://cfengine.com/docs/3.5/manuals-writing-policy-policy-style-guide.html">CFEngine Policy Style Guide</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sec-cfengine-variables">Data Types and Variables in CFEngine</h4>
<div class="paragraph">
<p>CFEngine supports different data types: scalars can be strings, integers or floating-point numbers; lists contain an ordered set of scalars, and arrays contain sets of values indexed by arbitrary strings. These data types can be used as constant values or be stored in variables.</p>
</div>
<div class="sect4">
<h5 id="_variable_declarations">Variable declarations</h5>
<div class="paragraph">
<p>Variables in CFEngine are declared in the <a href="http://cf-learn.info/ref/vars">vars:</a> section (they are promises of type <a href="http://cf-learn.info/ref/vars">vars:</a>) of a bundle. <a href="http://cf-learn.info/ref/vars">vars:</a> is one of the common promise types (along with <a href="http://cf-learn.info/ref/classes">classes:</a> and <a href="http://cf-learn.info/ref/reports">reports:</a>) that can be included in any type of bundle. <a href="http://cf-learn.info/ref/vars">vars:</a> promises adhere to the common structure described in <a href="#cfengine-policy-structure">CFEngine Policy Structure</a>, which in this case is interpreted as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;variable&quot;</span>
        <span class="tok-kr">type</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The promiser is the name of the variable in quotes. The type of the variable is given as an attribute, and its value indicates the value to store in the variable. Normally you write the whole declaration in a single line for brevity, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">name</span><span class="tok-p">&quot;</span>   <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Diego&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">year</span><span class="tok-p">&quot;</span>   <span class="tok-kt">int</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;2011&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">colors</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span>  <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;red&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;green&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;blue&quot;</span> <span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only valid attribute in variable declarations besides the type is <a href="http://cf-learn.info/ref/policy">policy</a>, which defines whether a variable can be modified without warning. By default, CFEngine will give you a warning if you assign a new value to a previously-defined variable. If you know a variable will need to change value during the execution of the policy, you can avoid these warnings by setting <a href="http://cf-learn.info/ref/policy">policy</a> to "overridable" or "free" (they are synonyms).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>CFEngine will in any case change the value of the variable, <a href="http://cf-learn.info/ref/policy">policy</a> only controls whether you will get a warning.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us now look at the details of the different data types available in CFEngine.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-strings-and-numbers">Strings</h5>
<div class="paragraph">
<p>Strings in CFEngine are declared using the string type. String values must always be enclosed by single or double quotes (there is no difference in their behavior). If you need to include a double quote in a double-quoted string, you need to precede it with a backslash (and similarly for single quotes inside single-quoted strings). You can create multiline strings simply by splitting them across multiple lines. To reference a string variable (and any scalar variable), you need to enclose the variable name in parentheses or curly braces, and precede them with a dollar sign.</p>
</div>
<div class="paragraph">
<p>You can interpolate variables into a string simply by referencing them inside the string. The following example shows some examples of strings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">s1</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;one&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">s2</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;this</span>
<span class="tok-s">is a</span>
<span class="tok-s">multine string&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">s3</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;with </span><span class="tok-se">\&quot;</span><span class="tok-s">quotes</span><span class="tok-se">\&quot;</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;s1 = </span><span class="tok-si">$(s1)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;s2 = </span><span class="tok-si">$(s2)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;s3 = </span><span class="tok-si">$(s3)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you save this short policy into a file and run it, you will get the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --no-lock --inform -f ./vars_string_examples.cf
<span class="tok-go">2013-10-14T05:22:19+0000   notice: /test: R: s1 = one</span>
<span class="tok-go">2013-10-14T05:22:19+0000   notice: /test: R: s2 = this</span>
<span class="tok-go">is a</span>
<span class="tok-go">multine string</span>
<span class="tok-go">2013-10-14T05:22:19+0000   notice: /test: R: s3 = with &quot;quotes&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the strings in the <a href="http://cf-learn.info/ref/reports">reports:</a> section adhere to the same rules, and contain the interpolated values of the declared variables.</p>
</div>
</div>
<div class="sect4">
<h5 id="_numbers">Numbers</h5>
<div class="paragraph">
<p>CFEngine supports both integers and floating-point numbers, denoted by the int and real types. Note that numeric values are also given as strings in CFEngine, but they are checked for validity before they are stored in the variable. For integers, CFEngine supports the suffixes k, m, and g to represent powers of 10 (that is, 1000, etc.), and the suffixes K, M, and G to represent powers of 2 (that is, 1024, etc.). Real numbers can be specified in decimal or exponential notation. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">i1</span><span class="tok-p">&quot;</span> <span class="tok-kt">int</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;25&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">i2</span><span class="tok-p">&quot;</span> <span class="tok-kt">int</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;10k&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">i3</span><span class="tok-p">&quot;</span> <span class="tok-kt">int</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;10K&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">r1</span><span class="tok-p">&quot;</span> <span class="tok-kt">real</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1.2&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">r2</span><span class="tok-p">&quot;</span> <span class="tok-kt">real</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;10e-5&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;i1 = </span><span class="tok-si">$(i1)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;i2 = </span><span class="tok-si">$(i2)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;i3 = </span><span class="tok-si">$(i3)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;r1 = </span><span class="tok-si">$(r1)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;r2 = </span><span class="tok-si">$(r2)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Produces the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --no-lock --inform -f ./vars_num_examples.cf
<span class="tok-go">2013-10-14T05:23:17+0000   notice: /test: R: i1 = 25</span>
<span class="tok-go">2013-10-14T05:23:17+0000   notice: /test: R: i2 = 10000</span>
<span class="tok-go">2013-10-14T05:23:17+0000   notice: /test: R: i3 = 10240</span>
<span class="tok-go">2013-10-14T05:23:17+0000   notice: /test: R: r1 = 1.200000</span>
<span class="tok-go">2013-10-14T05:23:17+0000   notice: /test: R: r2 = 0.000100</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sec-lists">Lists</h5>
<div class="paragraph">
<p>CFEngine supports ordered lists of any of the scalar types: lists of strings (slist), lists of integers (ilist) and lists of reals (rlist). In all cases, the values have to be specified as strings, but they are interpreted and validated according to the declared type. You can assign and store lists across variables of different types, as long as the values are compatible. This means you can always assign an ilist or an rlist into an slist, but you can assign an slist into an ilist or rlist only if it contains valid values according to the type of the destination variable.</p>
</div>
<div class="paragraph">
<p>You can refer to list variables by using an at-sign (@) before the variable name. By doing this you can pass the whole list to a function that expects a list argument. You can also specify a list as part of another list value, and it will be expanded in place. The following example illustrates these points:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;l1&quot;</span> <span class="tok-kr">ilist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;3&quot;</span> <span class="tok-p">};</span>
      <span class="tok-s">&quot;l2&quot;</span> <span class="tok-kr">rlist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;1.0&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;2.0&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;3.0&quot;</span> <span class="tok-p">};</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">l3</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;one&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;two&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;three&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@(l1)</span><span class="tok-p">,</span> <span class="tok-nv">@(l2)</span> <span class="tok-p">};</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;l3 = </span><span class="tok-si">$(l3)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run it you get the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --no-lock --inform -f ./vars_list_examples.cf
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = one</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = two</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = three</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = 1</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = 2</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = 3</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = 1.0</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = 2.0</span>
<span class="tok-go">2013-10-14T05:23:40+0000   notice: /test: R: l3 = 3.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both @(l1) and @(l2) are being expanded inside @(l3), so that its final value is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>   <span class="tok-p">{</span> <span class="tok-s">&quot;one&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;two&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;three&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;3&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;1.0&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;2.0&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;3.0&quot;</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we are also using CFEngine implicit looping by referring to the @(l3) array as a scalar $(l3). See <a href="#looping-in-cfengine">Looping in CFEngine</a> for a full explanation of how this works.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-arrays">Arrays</h5>
<div class="paragraph">
<p>Arrays are sets of values indexed by a string (they are commonly called <em>hashes</em> in other programming languages). Array elements can contain scalars, lists or other arrays, even within the same array.</p>
</div>
<div class="paragraph">
<p>In CFEngine, arrays are declared element by element, as if they were regular variables, except their name contains the index surrounded by brackets. There is no shortcut for declaring the whole array in a single step. There are certain functions that operate on arrays, such as <a href="http://cf-learn.info/ref/getindices">getindices()</a> and <a href="http://cf-learn.info/ref/getvalues">getvalues()</a>, and they receive as argument the name of the array as a string. For example, we could use an array to store user account information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">user[name]</span><span class="tok-p">&quot;</span>              <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;zamboni&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">user[fullname][first]</span><span class="tok-p">&quot;</span>   <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Diego&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">user[fullname][last]</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Zamboni&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">user[dirs]</span><span class="tok-p">&quot;</span>              <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;/home/zamboni&quot;</span><span class="tok-p">,</span>
                                           <span class="tok-s">&quot;/tmp/zamboni&quot;</span><span class="tok-p">,</span>
                                           <span class="tok-s">&quot;/export/home/zamboni&quot;</span> <span class="tok-p">};</span>

      <span class="tok-p">&quot;</span><span class="tok-nv">fields</span><span class="tok-p">&quot;</span>     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;user&quot;</span><span class="tok-p">);</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">userfields</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;user[fullname]&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;user fields = </span><span class="tok-si">$(fields)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;account name = </span><span class="tok-si">$(user[name])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(userfields)</span><span class="tok-s"> name = </span><span class="tok-si">$(user[fullname][$(userfields)])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;user dir = </span><span class="tok-si">$(user[dirs])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example is intentionally contrived to show how you can store different data types in an array. Note how @(fields) is being automatically populated by <a href="http://cf-learn.info/ref/getindices">getindices()</a> based on the indices declared for the user array. In other words, the statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>      <span class="tok-p">&quot;</span><span class="tok-nv">fields</span><span class="tok-p">&quot;</span>     <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;user&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>creates a variable named fields that refers to a list of three strings taken from the indices: name, fullname, and dirs. The list can then be used to loop through the user array, like before. Additionally, @(userfields) is being populated with the indices of the array stored in user[fullname]:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>      <span class="tok-p">&quot;</span><span class="tok-nv">userfields</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;user[fullname]&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, observe that user[dirs] contains a list of strings, and we are looping over that list as we would over a regular list variable (such as @(fields) or @(userfields) in this example) by referencing it as a scalar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>      <span class="tok-s">&quot;user dir = </span><span class="tok-si">$(user[dirs])</span><span class="tok-s">&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is its output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --no-lock --inform -f ./vars_array_examples2.cf
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: user fields = name</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: user fields = fullname</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: user fields = dirs</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: account name = zamboni</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: first name = Diego</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: last name = Zamboni</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: user dir = /home/zamboni</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: user dir = /tmp/zamboni</span>
<span class="tok-go">2013-10-14T05:27:44+0000   notice: R: user dir = /export/home/zamboni</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="classes-and-decision-making">Classes and Decision Making</h4>
<div class="paragraph">
<p>Classes are the key to controlling flow and making decisions in a CFEngine policy. In CFEngine, classes are named boolean values that can be either <em>true</em> (the class is defined) or <em>false</em> (the class is undefined). Classes can represent any characteristic of the system, information that is known (true) or unknown (false), or any condition that you want to indicate in the policy. They can be volatile (they stop existing as soon as the current CFEngine run is over) or persistent for a period of time you define. While many important classes are predefined by CFEngine (hard classes), you can define others for your particular needs (soft classes).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Hard classes</dt>
<dd>
<p>These are defined automatically by CFEngine when it runs, and represent mainly information about the system or the current environment that is discovered by CFEngine. Examples of hard classes include:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Host information (e.g., class doomsday would be defined if the hostname of the machine where <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> is running is “doomsday” and class ipv4_192_168_1_2 would be defined if the host’s IP address is 192.168.1.2).</p>
</li>
<li>
<p>Time information (e.g., class Hr5 would be set if CFEngine is running between 5 and 6 AM, class Min15_20 is defined if it is currently between minutes 15 and 20 of the hour, and class Mon would be set if it’s Monday).</p>
</li>
<li>
<p>Operating system information (e.g., linux would be set on any Linux system, and suse_9 would be set if the Linux distribution is SuSE 9).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To see the full list of hard classes defined on a particular system, run the following command (example output from an Ubuntu policy server at 4:28 UTC on a Friday):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-promises -v <span class="tok-p">|</span> grep classes
<span class="tok-go">2013-09-13T04:28:43+0000  verbose: Discovered hard classes: 10_0_2_15</span>
<span class="tok-go">127_0_0_1 192_168_122_1 2_cpus 64_bit Day13 Friday GMT_Hr4 Hr04 Hr04_Q2</span>
<span class="tok-go">Lcycle_0 Min25_30 Min28 Night PK_MD5_cd178888ee05e6a3461d4a2707ba9f97</span>
<span class="tok-go">Q2 September Yr2013 am_policy_hub any cfengine cfengine_3</span>
<span class="tok-go">cfengine_3_6 cfengine_3_6_0a1 cfengine_3_6_0a1_c861b92 common</span>
<span class="tok-go">compiled_on_linux_gnu debian debian_wheezy fe80__a00_27ff_fefe_aaaf</span>
<span class="tok-go">have_aptitude inform_mode ipv4_10 ipv4_10_0 ipv4_10_0_2</span>
<span class="tok-go">ipv4_10_0_2_15 ipv4_127 ipv4_127_0 ipv4_127_0_0 ipv4_127_0_0_1</span>
<span class="tok-go">ipv4_192 ipv4_192_168 ipv4_192_168_122 ipv4_192_168_122_1 linux</span>
<span class="tok-go">linux_3_2_0_23_generic linux_x86_64 linux_x86_64_3_2_0_23_generic</span>
<span class="tok-go">linux_x86_64_3_2_0_23_generic__36_Ubuntu_SMP_Tue_Apr_10_20_39_51_UTC_2012</span>
<span class="tok-go">localhost mac_08_00_27_fe_aa_af mac_be_1c_95_4f_d7_c3 net_iface_eth0</span>
<span class="tok-go">net_iface_lo net_iface_virbr0 policy_server precise64 ubuntu ubuntu_12</span>
<span class="tok-go">ubuntu_12_4 verbose_mode x86_64</span></code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Soft classes</dt>
<dd>
<p>These are defined by the policy during its execution. For example, a class could be defined in the following cases:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Depending on whether a certain file exists. In this example, we set the devel_host class if the <em>/var/sitedata/devel_host.flag</em> file exists, using the built-in <a href="http://cf-learn.info/ref/fileexists">fileexists()</a> function to perform the check:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">classes</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;devel_host&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span>
                 <span class="tok-nf">fileexists</span><span class="tok-p">(</span><span class="tok-s">&quot;/var/sitedata/devel_host.flag&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Setting a class like this might be useful, for example, to establish whether certain executable programs or other capabilities are present on a system before invoking them, or to apply different configurations to the system.</p>
</div>
</li>
<li>
<p>As a Boolean expression of other classes. In this example, test_host will be defined if any of testhost1, testhost2, or testhost3 classes is defined. These might be the hostnames of the machines in which you want the test_host class to be defined:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">classes</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;test_host&quot;</span> <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;testhost1&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;testhost2&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;testhost3&quot;</span><span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Setting a class like this might be useful to run certain operations on certain systems—tests in this case.</p>
</div>
</li>
<li>
<p>As an indication of the status of a particular promise. In this example, if any changes are made to the <em>/etc/ssh/sshd_config</em> file by the <a href="http://cf-learn.info/ref/edit_line">edit_line</a> attribute, CFEngine would consider the promise as <em>repaired</em>, in which case the restart_sshd class will be defined:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">files</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;/etc/ssh/sshd_config&quot;</span>
    <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_config_values</span><span class="tok-p">(</span><span class="tok-s">&quot;sshd&quot;</span><span class="tok-p">),</span>
    <span class="tok-kr">classes</span>   <span class="tok-o">=&gt;</span> <span class="tok-nf">if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;restart_sshd&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Setting a class like this might be useful to keep track of the state of the system, and make sure that CFEngine follows up on an operation during its next pass.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that classes can be explicitly defined in a <a href="http://cf-learn.info/ref/classes">classes:</a> section, but as you can see in the third example, they can also be defined by the common <a href="http://cf-learn.info/ref/classes">classes</a> attribute, which you can use in all promises to set or unset classes based on the result of the promise. Several <a href="http://cf-learn.info/ref/classes">classes</a> bodies are predefined in the CFEngine standard library, including if_repaired, if_ok, if_notkept, if_else, always and classes_generic.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The classes_generic body provides a useful way to set consistent class names depending on the outcome of a promise. If you specify, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">classes_generic</span><span class="tok-p">(</span><span class="tok-s">&quot;foo&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, depending on the state of the promise, you will get one of foo_repaired, foo_failed, foo_denied, foo_timeout or foo_kept defined. This body also defines a few other class name patterns, including foo_reached, which gets defined regardless of the promise outcome and can be used to determine if a promise has been evaluated at all.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
</dl>
</div>
<div id="I_sidebar3_d1e3965" class="sidebarblock">
<div class="content">
<div class="title">Classes and Contexts</div>
<div class="paragraph">
<p>You may see “classes” described sometimes as “contexts”. This term expresses the idea of a particular <em>context</em> (be it time or date, operating system, architecture, etc.) in which a host is at the moment. The CFEngine team has decided to keep using <em>class</em> in all official documentation to avoid confusion, but <em>context</em> might still be used in some explanations when it makes things clearer.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Apart from defining classes, you need a way to act on them. This is what the <em>class_expression</em> shown in <a href="#cfengine-policy-structure">CFEngine Policy Structure</a> is for. A class expression in CFEngine is a boolean expression constructed with class names and the boolean operators AND (&amp; or .), OR (|) and NOT (!). Parenthesis can be used to group parts of the expression. When a line ends with a double colon, it is evaluted as a class expression. Only if the class expression is true are the lines that follow evaluated. The following are examples of valid class expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-c"># True if the linux class is defined</span>
<span class="tok-nc">linux</span><span class="tok-p">::</span>
<span class="tok-c"># True if both reboot_needed and linux are defined</span>
<span class="tok-nc">reboot_needed.linux</span><span class="tok-p">::</span>
<span class="tok-c"># True if reboot_needed is defined and neither linux nor windows are defined</span>
<span class="tok-nc">reboot_needed.!(linux|windows)</span><span class="tok-p">::</span>
<span class="tok-c"># The any class is always defined, so whatever follows will always be evaluated</span>
<span class="tok-nc">any</span><span class="tok-p">::</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, you can use the <a href="http://cf-learn.info/ref/ifvarclass">ifvarclass</a> attribute in most promise types to condition the evaluation of one promise to the result of the included class expression. For example, the following two promises are equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">commands</span><span class="tok-p">:</span>
  <span class="tok-c"># First command is conditioned by the ifvarclass attribute</span>
  <span class="tok-s">&quot;/usr/sbin/shutdown -r now&quot;</span>
    <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;linux&quot;</span><span class="tok-p">;</span>

  <span class="tok-c"># Second command is conditioned by the class expression before it</span>
  <span class="tok-nc">linux</span><span class="tok-p">::</span>
    <span class="tok-s">&quot;/usr/sbin/shutdown -r now&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="http://cf-learn.info/ref/ifvarclass">ifvarclass</a> attribute allows you to place a condition around a single promise. It has the advantage of specifying the class expression as a string, which means you can use variables in the class expression, and they will be expanded before evaluating the expression. This allows a lot of flexibility in the types of conditions that you can use. For example, you can construct class names on the fly using variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">words</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;chair&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;darwin&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;table&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;linux&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;Class </span><span class="tok-si">$(words)</span><span class="tok-s"> is defined&quot;</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(words)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;Class </span><span class="tok-si">$(words)</span><span class="tok-s"> is not defined&quot;</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;!</span><span class="tok-si">$(words)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <a href="http://cf-learn.info/ref/reports">reports:</a> section is looping through all the strings in the @(words) list (see <a href="#looping-in-cfengine">Looping in CFEngine</a>), and the corresponding message is printed depending on whether the class named after the current value is defined. Note how the class expression for the second report (“not defined”) includes the NOT character at the beginning. Here is its output on a Mac (whose base operating system is Darwin, so the darwin class is defined):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --no-lock --inform -f ./ifvarclass_examples.cf
<span class="tok-go">2013-10-14T00:34:51-0500   notice: R: Class darwin is defined</span>
<span class="tok-go">2013-10-14T00:34:51-0500   notice: R: Class apple is not defined</span>
<span class="tok-go">2013-10-14T00:34:51-0500   notice: R: Class table is not defined</span>
<span class="tok-go">2013-10-14T00:34:51-0500   notice: R: Class linux is not defined</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Class expressions can also be used to define other classes using the <a href="http://cf-learn.info/ref/expression">expression</a> attribute in a <a href="http://cf-learn.info/ref/classes">classes:</a> promise. For example, the test_host class shown above could also be defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kd">classes</span><span class="tok-p">:</span>
  <span class="tok-s">&quot;test_host&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;testhost1|testhost2|testhost3&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, classes can be made persistent, even across invocations of <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a>, by using the <a href="http://cf-learn.info/ref/persistence">persistence</a> attribute in the class declaration. Its value should be the length of time, in minutes, for which the class should retain its value after being evaluated. This can be useful if the class value is the result of a time-consuming or otherwise expensive operation, to avoid recomputation every time <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> runs.</p>
</div>
<div class="paragraph">
<p>Note that setting a class as persistent does not mean it will not be reevaluated every time cf-agent runs, only that its previous value will be available during the persistence period. To avoid unnecessary reevaluation, the usual practice is to use a “flag class” with the same persistence period. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
    <span class="tok-nc">!cache_is_active</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;line_exists&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">regline</span><span class="tok-p">(</span><span class="tok-s">&quot;.*foo.*&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/tmp/test_data.txt&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">persistence</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
      <span class="tok-s">&quot;cache_is_active&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;any&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">persistence</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">line_exists</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;Line exists in file&quot;</span><span class="tok-p">;</span>
    <span class="tok-nc">!line_exists</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;Line does not exist in file&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we are using cache_is_active as the “flag class” to indicate whether we should recompute the value of line_exists, which would arguably be a very costly class to compute. In this case we are using <a href="http://cf-learn.info/ref/regline">regline()</a> to look for a line containing “foo” in the file <em>/tmp/test_data.txt</em>). In the <a href="http://cf-learn.info/ref/classes">classes:</a> section, we evaluate the classes only when cache_is_active is not defined. In this case, we set cache_is_active unconditionally (using the special expression "any"), and set line_exists depending on the result of the function, both with the same persistence period. This means that within one minute, no matter how many times cf-agent executes, the classes will not be reevaluated and their cached values will be reported. You can test this behavior in the previous example by running it, then editing the file, and observing that the changes are not detected until a minute has passed since the last execution. In deployment, this can be extremely useful to limit reevaluation of complex or costly class expressions whose values change slowly or infrequently.</p>
</div>
</div>
<div class="sect3">
<h4 id="containers">Bundles, Bodies, and Namespaces</h4>
<div class="paragraph">
<p>CFEngine policies can grow quite complex, so it would not be very scalable simply to list promises back to back. For this reason, and to promote reusability, CFEngine groups its syntax elements into two types of structures: <em>bundles</em> and <em>bodies</em>, and they in turn can be grouped into <em>namespaces</em>.</p>
</div>
<div class="sect4">
<h5 id="_bundles">Bundles</h5>
<div class="paragraph">
<p>Bundles are the most general and powerful grouping mechanism. They are the only elements that can contain promises. A bundle can contain many promises, possibly separated into sections. The structure described at the beginning of <a href="#cfengine-policy-structure">CFEngine Policy Structure</a> can be contained only inside a bundle. Bundles are defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">type</span> <span class="tok-nf">name</span><span class="tok-p">(</span><span class="tok-nv">arguments</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kd">promise_type</span><span class="tok-p">:</span>
    <span class="tok-nc">class_expression</span><span class="tok-p">::</span>
      <span class="tok-nf">promise</span>
      <span class="tok-err">...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>name</em> of the bundle is an arbitrary string that you can use to identify it. The <em>type</em> of the bundle has to be one of the CFEngine-recognized types, and it defines the semantics of the bundle (that is, how are the promises in it interpreted), as well as the promise type sections it can contain. All bundles can receive an arbitrary number of arguments. If no arguments are needed, the parenthesis are optional.</p>
</div>
<div class="paragraph">
<p>The bundle types defined by CFEngine are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/agent"> agent </a></dt>
<dd>
<p>Bundles of type <a href="http://cf-learn.info/ref/agent">agent</a> are “executable” bundles that can be called from the main <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> declaration, or as method calls in the <a href="http://cf-learn.info/ref/methods">methods:</a> section of another agent bundle. In this respect they could be compared to subroutines in other programming languages. They are the most extensive and powerful type of bundle, and the ones that actually implement any changes that we want to make in the system. These bundles can contain the following promise types:</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://cf-learn.info/ref/commands">commands:</a> to specify commands to be executed</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/files">files:</a> to edit and manipulate files</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/methods">methods:</a> to call other agent bundles</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/packages">packages:</a> to query and manipulate software packages in the system</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/processes">processes:</a> to query and manipulate running processes</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/storage">storage:</a> to query and configure file systems</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/services">services:</a> to configure system services in Unix-like systems (CFEngine Enterprise also supports Windows system services)</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/databases">databases:</a> to manipulate and configure databases</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/guest_environments">guest_environments:</a> to manipulate and configure virtual environments</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/common"> common </a></dt>
<dd>
<p>Bundles of this type are just like <a href="http://cf-learn.info/ref/agent">agent</a> bundles, but are special in two big ways:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>The variables and classes defined in them are automatically available to every other bundle in your policy.</p>
</li>
<li>
<p>They are evaluated by all the CFEngine components (cf-agent, cf-serverd, cf-monitord, etc.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For these reasons, they are a good place to define globally useful variables and classes. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">g</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">localdir</span><span class="tok-p">&quot;</span>    <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/usr/local&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">confdir</span><span class="tok-p">&quot;</span>     <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/etc&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;testhost&quot;</span>    <span class="tok-kr">or</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;testhost1&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;testhost2&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example defines two variables with strings that will be useful in other parts of the policy, and which we can reference as $(g.localdir) and $(g.confdir) (in general, any variable can be accessed from anywhere else by prefixing it with the name of the bundle where it was defined). Also defined is a class based on whether either of the classes testhost1 or testhost2 is defined (this would be the case if the current host has any of those names, and is a common way of defining a class for a certain group of hosts—more on this in <a href="#sec-defining-classes-for-groups-of-hosts">[sec-defining-classes-for-groups-of-hosts]</a>). This class is automatically made global, which means it can be used in any other bundle.</p>
</div>
<div id="I_sidebar3_d1e4574" class="sidebarblock">
<div class="content">
<div class="title">Class and Variable Scoping</div>
<div class="paragraph">
<p>All variables in CFEngine are local to the bundle in which they are defined. However, they can be accessed from any other bundle by prefixing them with the bundle name in which they are defined, separated by a dot, as in $(g.localdir).</p>
</div>
<div class="paragraph">
<p>Most classes in CFEngine are local to the bundle in which they are defined, and they cannot be accessed from anywhere else (there is no mechanism for specifying the bundle of a class). The exceptions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Classes defined in a <a href="http://cf-learn.info/ref/common">common</a> bundle are automatically global.</p>
</li>
<li>
<p>Classes defined by the <a href="http://cf-learn.info/ref/classes">classes</a> attribute in a promise (as a result of its status) are automatically global. This is useful because these classes are commonly used as a signaling mechanism across promises and bundles.</p>
</li>
<li>
<p>Since CFEngine 3.5.0, both <a href="http://cfengine.com/docs/3.5/reference-promise-types-classes.html">classes:</a> promises and <a href="http://cfengine.com/docs/3.5/reference-promise-types.html#classes">classes</a> bodies can specify a scope attribute, which can take the values “bundle” (the default for classes: promises) and “namespace” (the default for classes bodies)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note that <a href="http://cf-learn.info/ref/common">common</a> bundles are not necessarily evaluated before regular <a href="http://cf-learn.info/ref/agent">agent</a> bundles, although this is a common misconception. You can (and should) put them in <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> to ensure they are evaluated at the correct moment (normally, you would put them at the beginning of the execution sequence, to ensure the values defined in them are properly available to all other bundles).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/edit_line"> edit_line </a></dt>
<dd>
<p>Bundles of type <a href="http://cf-learn.info/ref/edit_line">edit_line</a> can be used to change a file, one of the most common and most complex operations performed by CFEngine. These bundles must be specified as the value of the <a href="http://cf-learn.info/ref/edit_line">edit_line</a> attribute in a file-editing promise (this is, a promise of type <a href="http://cf-learn.info/ref/files">files:</a>). <a href="http://cf-learn.info/ref/edit_line">edit_line</a> bundles themselves can be quite complex and contain their own set of allowable promise types, which include:</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://cf-learn.info/ref/insert_lines">insert_lines:</a> to add lines to a file</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/delete_lines">delete_lines:</a> to remove lines from a file</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/field_edits">field_edits:</a> to make field-oriented changes in a file</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/replace_patterns">replace_patterns:</a> to make regular expression substitutions in a file</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/server"> server </a></dt>
<dd>
<p>Bundles of type <a href="http://cf-learn.info/ref/server">server</a> control the behavior of the <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> process, which has the task of serving files to other CFEngine machines that request them (<a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> normally runs on the CFEngine policy hub). This type of bundle can contain two promise types:</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://cf-learn.info/ref/access">access:</a> to define access permissions to different resources on the server.</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/roles">roles:</a> to define which users can indicate classes (and which classes they can define) in the server process, to alter the behavior of the <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> daemon. One of CFEngine’s strong security features is that remote machines can never execute arbitrary commands. Instead, they can execute certain bundles. Some users, as defined by <a href="http://cf-learn.info/ref/roles">roles:</a> promises, may have the ability to set custom classes when invoking those remote promises, thus allowing them to modify the promises’ behavior, but only as allowed by the remote bundle and its handling of the defined classes.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><a href="http://cf-learn.info/ref/monitor"> monitor </a></dt>
<dd>
<p>Bundles of this type are supported only in commercial editions of CFEngine. They define custom parameters that CFEngine can monitor automatically, and specify how to react to changes in their values. CFEngine natively knows how to monitor a large set of system values, such as CPU and memory utilization. This type of bundle supports only one section called <a href="http://cf-learn.info/ref/measurements">measurements:</a>, which contains promises defining what and how to monitor it, and how to react to changes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Certain generic promise types are allowed in all bundle types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://cf-learn.info/ref/vars">vars:</a> to define variables</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/classes">classes:</a> to define classes</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/reports">reports:</a> to define produced output</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/meta">meta:</a> to define metadata about a bundle.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="sec-bodies">Bodies</h5>
<div class="paragraph">
<p>Bodies are collections of attributes and values that can be used as values to other attributes. Bodies cannot contain promises nor sections, although they can receive arguments, and can contain class expressions to specify different values for some of the attributes. Bodies, just like bundles, have a type, which indicates the attribute to which they can be passed, as well as the attributes they can contain. The generic structure of a body is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">type</span> <span class="tok-nf">name</span><span class="tok-p">(</span><span class="tok-nv">arguments</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kr">attribute1</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value1</span><span class="tok-p">;</span>
  <span class="tok-kr">attribute2</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">value2</span><span class="tok-p">;</span>
  <span class="tok-err">...</span>
<span class="tok-err">[</span><span class="tok-nc">class_expression</span><span class="tok-p">::</span><span class="tok-err">]</span>
  <span class="tok-kr">attributeN</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">valueN</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some common bodies you will use include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://cf-learn.info/ref/control">control</a> bodies are special structures that are not referenced in any promises, but that control the behavior of different aspects of CFEngine itself. There are different types of control bodies, depending on the component whose behavior they control. The one you are bound to use is the common control body. Among other things, it is in this body that you specify which bundles will be executed in your policy and in which order, using the <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> attribute, and which additional files to read, using the <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;tests.cf&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>This block tells CFEngine to load the file <em>tests.cf</em> and to execute the test bundle. Every CFEngine policy needs to have a <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> definition, and this is most commonly done through a <a href="http://cf-learn.info/ref/control-common">common control</a> body. (You can also specify it with the -b option to <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a>, but I normally do this only when testing policy components.)</p>
</div>
<div class="paragraph">
<p>As you might imagine, <a href="http://cf-learn.info/ref/control-common">common control</a> supports many other attributes that specify global CFEngine behavior. There are also <a href="http://cf-learn.info/ref/control">control</a> bodies for specific CFEngine components, including the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>agent control bodies to specify promise-evaluation behavior such as minimum time between consecutive evaluations of the same promise (<a href="http://cf-learn.info/ref/ifelapsed">ifelapsed</a>), classes that tell CFEngine to abort (<a href="http://cf-learn.info/ref/abortclasses">abortclasses</a>), and many others.</p>
</li>
<li>
<p>server control bodies to specify server behavior, such as addresses and users from which connections will be allowed (<a href="http://cf-learn.info/ref/allowconnects">allowconnects</a>, <a href="http://cf-learn.info/ref/allowusers">allowusers</a>) and the interface to which the <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> process should bind (<a href="http://cf-learn.info/ref/bindtointerface">bindtointerface</a>).</p>
</li>
<li>
<p>Others such as <a href="http://cf-learn.info/ref/control-monitor">monitor control</a>, runagent control, <a href="http://cf-learn.info/ref/control-executor">executor control</a>, hub control and <a href="http://cf-learn.info/ref/file-control">file control</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p><a href="http://cf-learn.info/ref/classes">classes</a> bodies specify which classes will be defined depending on the outcome of a promise. These bodies are valid attributes for all promise types. For example, consider the following file promise:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-s">&quot;/var/run/somefile&quot;</span>
  <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">,</span>
  <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">passfail</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, passfail is the name of a body, of type <a href="http://cf-learn.info/ref/classes">classes</a>, that needs to be defined somewhere else. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">classes</span> <span class="tok-nf">passfail</span>
<span class="tok-p">{</span>
  <span class="tok-kr">promise_kept</span>     <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;fileexisted&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kr">promise_repaired</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;filecreated&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kr">repair_failed</span>    <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;fileerror&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several things you should notice here. First, the type of the body part is <a href="http://cf-learn.info/ref/classes">classes</a>, which means it can be used only as the value of a <a href="http://cf-learn.info/ref/classes">classes</a> attribute in a promise. The name passfail is an arbitrary identifier. The <a href="http://cfengine.com/docs/3.5/reference-promise-types.html#classes">documentation for the classes body type</a> lists the attributes it can contain. In this case, if <em>/var/run/somefile</em> already existed (the promise was <em>kept</em>), the fileexisted class will be defined after the promise runs. If <em>/var/run/somefile</em> did not exist and CFEngine was able to create it (the promise was <em>repaired</em>), filecreated will be defined. And if the file cannot be created for some reason (the <em>repair failed</em>), the fileerror class will be defined. These classes can be used later on to control other promises. And more importantly, the passfail body can be used in many different promises, allowing for encapsulation and code reutilization.</p>
</div>
<div class="paragraph">
<p>An important thing to notice is that body parts can also have parameters, which allows even further customization of their behavior. For example, suppose we want the repaired/kept/failed classes to contain an arbitrary identifier to help us differentiate among multiple file checks. We could define passfail as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">classes</span> <span class="tok-nf">passfail</span><span class="tok-p">(</span><span class="tok-nv">id</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kr">promise_kept</span>     <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(id)</span><span class="tok-s">_existed&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kr">promise_repaired</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(id)</span><span class="tok-s">_created&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kr">repair_failed</span>    <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(id)</span><span class="tok-s">_error&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We would then have to modify the files promises to something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-s">&quot;/var/run/somefile&quot;</span>
  <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">,</span>
  <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">passfail</span><span class="tok-p">(</span><span class="tok-s">&quot;somefile&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now "somefile" is being passed as an argument to the passfail body part, and used as part of the class names to define. This means that depending on the result of the promise, the classes somefile_existed, somefile_created or somefile_error will be defined, instead of the generic names we had used before.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The classes_generic body defined in the CFEngine Standard Library behaves much like our passfail body, but considers all possible promise outcomes, and defines several classname patterns for each outcome. For example, if a promise is repaired and you call classes_generic("somefile”) you will get the following classes defined: promise_repaired_somefile, somefile_repaired, somefile_ok and somefile_reached.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</li>
<li>
<p><a href="http://cf-learn.info/ref/action">action</a> is another attribute that can be used in any promise, and defines how the promise should be evaluated and fixed. Using it we can define that promises should only be checked but not fixed, whether the actions related to the promise should occur in the background, how often promises should be checked, logging behavior for the promise, and other attributes. For example, the following promise will warn if a certain line does not exist in /etc/motd, and will issue the warning only every hour, even if CFEngine checks more frequently:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/etc/motd&quot;</span>
        <span class="tok-kr">edit_lines</span> <span class="tok-o">=&gt;</span>
      <span class="tok-nf">insert_lines</span><span class="tok-p">(</span><span class="tok-s">&quot;Unauthorized access will be prosecuted.&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">action</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">warn_hourly</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">body</span> <span class="tok-k">action</span> <span class="tok-nf">warn_hourly</span>
<span class="tok-p">{</span>
      <span class="tok-c"># Produce warning only, don&#39;t fix anything</span>
        <span class="tok-kr">action_policy</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;warn&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">ifelapsed</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;60&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p><a href="http://cf-learn.info/ref/copy_from">copy_from</a> is an attribute that can be used only in <a href="http://cf-learn.info/ref/files">files:</a> promises, and indicates from where and how a file will be copied. It is an extremely flexible attribute, since it allows us to request local or remote file copies, how the files will be compared, whether the file will be encrypted in transit, and many other parameters. For example, the following two bodies are from CFEngine’s standard library:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">copy_from</span> <span class="tok-nf">secure_cp</span><span class="tok-p">(</span><span class="tok-nv">from</span><span class="tok-p">,</span><span class="tok-nv">server</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">source</span>      <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(from)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">servers</span>     <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(server)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">compare</span>     <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;digest&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">encrypt</span>     <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">verify</span>      <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">body</span> <span class="tok-k">copy_from</span> <span class="tok-nf">remote_cp</span><span class="tok-p">(</span><span class="tok-nv">from</span><span class="tok-p">,</span><span class="tok-nv">server</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">servers</span>     <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(server)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">source</span>      <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(from)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">compare</span>     <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;mtime&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both handle copying files from a remote server, and take both a server address and a source file as arguments. The first one specifies that the connection will be encrypted (using an internal CFEngine mechanism), that the files will be verified after copying them, and that files will be compared by computing a cryptographic hash of their contents. The second one is simpler, indicating no need for encryption or verification, and the comparison will be made using simply the time of last modification (mtime) of both files. The former, more expensive verification mechanism allows us to reliably detect changes in the files in cases when their modification date might not be a reliable indicator. In both cases, the comparison mechanism allows CFEngine to skip the expensive copy operation if the files already match.</p>
</div>
</div>
</div>
</li>
<li>
<p><a href="http://cf-learn.info/ref/depth_search">depth_search</a> is another attribute of <a href="http://cf-learn.info/ref/files">files:</a> promises that allows us to control recursive operations. It specifies how deep to traverse, which directories to skip, and other parameters. For example:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">depth_search</span> <span class="tok-nf">recurse_ignore</span><span class="tok-p">(</span><span class="tok-nv">d</span><span class="tok-p">,</span><span class="tok-nv">list</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">depth</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(d)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">exclude_dirs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-nv">@(list)</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This definition specifies that only directories up to $(d) levels deep will be traversed (the special string "inf" can be used to specify infinite recursion), and allows the caller to specify a list of directories to exclude.</p>
</div>
<div class="paragraph">
<p>Putting <a href="http://cf-learn.info/ref/copy_from">copy_from</a> and <a href="http://cf-learn.info/ref/depth_search">depth_search</a> together, we can already create a functional file-copy promise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">update_inputs</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">server</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;10.1.1.1&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">inputs</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/cfengine/masterfiles/inputs&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(sys.workdir)</span><span class="tok-s">/inputs&quot;</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">remote_cp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(server)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-si">$(inputs)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">depth_search</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">recurse_ignore</span><span class="tok-p">(</span><span class="tok-s">&quot;inf&quot;</span><span class="tok-p">,</span> <span class="tok-p">{</span> <span class="tok-s">&quot;_.*&quot;</span> <span class="tok-p">});</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we will be copying all files from the directory <em>/var/cfengine/masterfiles/inputs</em> on server 10.1.1.1 onto the local /var/cfengine/inputs directory ($(sys.workdir) is an internal variable that CFEngine defines to be its working directory, normally /var/cfengine). A recursive copy of infinite depth will be done, but all directories starting with _ will be ignored (the patterns provided have to be regular expressions and not shell metacharacter expressions, hence the <code><em>.<strong></code> instead of just <code></em></strong></code>). Note that it is not possible to use <a href="http://cf-learn.info/ref/depth_search">depth_search</a> in conjunction with edit_line. For editing files, the precise file to be edited needs to be specified.</p>
</div>
</div>
</div>
</li>
<li>
<p><a href="http://cf-learn.info/ref/edit_defaults">edit_defaults</a> is an attribute of <a href="http://cf-learn.info/ref/files">files:</a> promises that controls parameters of the file-editing process. You can specify whether backups should be made of the original file, the maximum size of a reasonable file for editing, and whether the file should be emptied and recreated every time. In the following example, timestamped copies of the file will be kept every time the file is changed:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">editexample</span>
<span class="tok-p">{</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/etc/motd&quot;</span>
        <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">insert_lines</span><span class="tok-p">(</span><span class="tok-s">&quot;Unauthorized use will be prosecuted&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">edit_defaults</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">backup_timestamp</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">body</span> <span class="tok-k">edit_defaults</span> <span class="tok-nf">backup_timestamp</span>
<span class="tok-p">{</span>
        <span class="tok-kr">empty_file_before_editing</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">edit_backup</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;timestamp&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">max_file_size</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;300000&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p><a href="http://cf-learn.info/ref/edit_field">edit_field</a> is an attribute of <a href="http://cf-learn.info/ref/field_edits">field_edits:</a> promises that performs field-based editing in a file (it must be specified as an attribute in a promise of type <a href="http://cf-learn.info/ref/field_edits">field_edits:</a>, which in turn is allowable only inside <a href="http://cf-learn.info/ref/edit_line">edit_line</a> bundles). It specifies what characters to use as delimiters and which actions will be taken on which fields. For example, the following definition from the Standard Library performs generic field-editing operations using user-provided information:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">edit_field</span> <span class="tok-nf">col</span><span class="tok-p">(</span><span class="tok-nv">split</span><span class="tok-p">,</span><span class="tok-nv">col</span><span class="tok-p">,</span><span class="tok-nv">newval</span><span class="tok-p">,</span><span class="tok-nv">method</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
        <span class="tok-kr">field_separator</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(split)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">select_field</span>       <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(col)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">value_separator</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;,&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">field_value</span>        <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(newval)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">field_operation</span>    <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(method)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">extend_fields</span>      <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">allow_blank_fields</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The split argument specifies a regular expression to use as separator (thus it gets assigned to the field_separator attribute), col indicates the column on which to operate and gets assigned to select_field (by default CFEngine starts counting from one, although this behavior can be changed using the start_fields_from_zero attribute in the <a href="http://cf-learn.info/ref/edit_field">edit_field</a> body), newval indicates the value to insert or delete from that field (it gets used for field_value, each field can contain multiple values separated by value_separator, a comma in this case), and method indicates which operation to perform (set, <a href="http://cf-learn.info/ref/delete">delete</a>, append, prepend, etc.).</p>
</div>
<div class="paragraph">
<p>The col() body definition can be used, for example, to edit colon-separated files, such as <em>/etc/passwd</em> in Unix systems (this set_user_field() bundle is also defined in the Standard Library):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">edit_line</span> <span class="tok-nf">set_user_field</span><span class="tok-p">(</span><span class="tok-nv">user</span><span class="tok-p">,</span><span class="tok-nv">field</span><span class="tok-p">,</span><span class="tok-nv">val</span><span class="tok-p">)</span>

<span class="tok-c"># Set the value of field number &quot;field&quot; in</span>
<span class="tok-c"># a :-field formatted file like /etc/passwd</span>

<span class="tok-p">{</span>
  <span class="tok-kd">field_edits</span><span class="tok-p">:</span>

      <span class="tok-s">&quot;</span><span class="tok-si">$(user)</span><span class="tok-s">:.*&quot;</span>

        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Edit a user attribute in the password file&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">edit_field</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">col</span><span class="tok-p">(</span><span class="tok-s">&quot;:&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;</span><span class="tok-si">$(field)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;</span><span class="tok-si">$(val)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;set&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This
bundle takes three arguments: the user to edit (<code>user</code>), the field
number to edit (<code>field</code>), and the value to set in that field
(<code>val</code>). In
<a href="http://cf-learn.info/ref/field_edits">field_edits:</a> promises,
the promiser is interpreted as a regular expression that is matched
against all the lines in the file, to select which lines to edit. In
this case, the value of the $(user) parameter is used to select
the line that starts with that string, followed by a colon and any
other text ("$(user):.*" —the pattern is automatically anchored by
CFEngine to the beginning and end of the line, so there is no need for
the ^ character to specify that the pattern must start at the
beginning of the line). Once a line is
selected, the <a href="http://cf-learn.info/ref/edit_field">edit_field</a>
attribute uses col() to perform the actual field-change operation,
The separator is specified as a colon, the field number and the new
value are passed directly from the arguments $(field) and
$(val), and the operation to perform is "set", which tells
CFEngine to replace the old value of the field with the new one.</p>
</div>
<div class="paragraph">
<p>To put this in context, note that set_user_field() is an <a href="http://cf-learn.info/ref/edit_line">edit_line</a> bundle, which means it has to be used as the argument to the <a href="http://cf-learn.info/ref/edit_line">edit_line</a> attribute of a <a href="http://cf-learn.info/ref/files">files:</a> promise. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-c"># Set the 7th field (shell) of user &quot;nobody&quot; to &quot;/bin/false&quot;</span>
      <span class="tok-s">&quot;/etc/passwd&quot;</span>
        <span class="tok-kr">edit_line</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">set_user_field</span><span class="tok-p">(</span><span class="tok-s">&quot;nobody&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;7&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/bin/false&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many other body attributes are allowed in CFEngine for different promise types. I have shown here some of the most common ones, but you can find the full listing and details in the <a href="http://cf-learn.info/ref/promise-types-and-attributes">CFEngine Reference documentation</a>.</p>
</div>
<div id="I_sidebar3_d1e6049" class="sidebarblock">
<div class="content">
<div class="title">Bundles and Bodies Summary</div>
<div class="paragraph">
<p>The distinction between bundles and bodies can be confusing at first. Remembering these points may help:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bodies are named groups of <em>attributes</em>, whereas bundles are collections of <em>promises</em>. Promises are the units that actually <em>do something</em> in CFEngine (for example, run a command or add a line to a file), whereas attributes specify characteristics of how things are done (for example, whether to run the command in a shell, or where in the file to add the line).</p>
</li>
<li>
<p>The value of an attribute can be a basic data type (string, integer, list, etc.), it can be the name of a body, or it can be the name of a bundle.</p>
</li>
<li>
<p>The type of an attribute’s value is fixed, and determined by the attribute itself (for example, the value of the <a href="http://cf-learn.info/ref/depth_search">depth_search</a> attribute in a <a href="http://cf-learn.info/ref/files">files:</a> promise is always a body, and the value of an <a href="http://cf-learn.info/ref/edit_line">edit_line</a> attribute is always a bundle).</p>
</li>
<li>
<p>For bodies and bundles, their type is always the name of the attribute to which they correspond. For example, bodies to be used with the <a href="http://cf-learn.info/ref/depth_search">depth_search</a> attribute are always declared as “body depth_search xyz”, where xyz is an arbitrary name of your choosing. The same goes for bundles: bundles to be used with the <a href="http://cf-learn.info/ref/edit_line">edit_line</a> attribute are always declared as “bundle edit_line xyz".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are only three types of “top level” bundles that are not used as arguments to attributes: <a href="http://cf-learn.info/ref/Bundles-for-agent">agent</a>, <a href="http://cf-learn.info/ref/Bundles-for-server">server</a> and <a href="http://cf-learn.info/ref/Bundles-for-monitor">monitor</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The promise types (sections) that can appear in a bundle are determined by the bundle type. For example, <a href="http://cf-learn.info/ref/commands">commands:</a> promises can only appear in bundles of type <a href="http://cf-learn.info/ref/agent">agent</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="namespaces">Namespaces</h5>
<div class="paragraph">
<p>By default, all bodies, bundles, and classes in CFEngine exist in a common namespace. This makes it easy to call bundles and bodies from anywhere in the policy. However, as a policy grows in size to handle a large or complex infrastructure, and particularly if multiple people are in charge of writing policies, the possibility for naming conflicts increases—for example, it becomes entirely possible that a bundle named restart_service will be defined in two different files that correspond to different services.</p>
</div>
<div class="paragraph">
<p>To avoid this problem, files can be assigned to <a href="http://cf-learn.info/ref/name-spaces"><em>namespaces</em></a>. Bundles, bodies, and global classes with the same name can coexist, as long as they are in separate namespaces. To declare a namespace for the current file, you use a <a href="http://cf-learn.info/ref/file-control">body file control</a> declaration, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">file</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">namespace</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;name1&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If no namespace declaration is found, the default namespace is used. Note that the namespace declaration is placement-sensitive: it affects everything on the file after its appearance, and it can appear multiple times in a single file. This means that you can in principle declare bundles and bodies belonging to different namespaces in the same file. In practice, I would advise against this practice to avoid confusion, and recommend limiting each file to a single namespace, if any, by placing the <a href="http://cf-learn.info/ref/file-control">body file control</a> declaration at the top.</p>
</div>
<div class="paragraph">
<p>When you call a bundle or a body, CFEngine will look for it <em>only in the current namespace</em> (whether it’s default or a declared one). To access things in a different namespace, you need to prepend their names with the namespace, separated by a colon. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">methods</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;any&quot;</span> <span class="tok-kr">usebundle</span> <span class="tok-o">=&gt;</span> <span class="tok-kd">namespace</span><span class="tok-p">:</span><span class="tok-nf">bundle</span><span class="tok-p">(</span><span class="tok-s">&quot;arg&quot;</span><span class="tok-p">);</span>

  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;/tmp/file&quot;</span>
        <span class="tok-kr">create</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">true</span><span class="tok-p">,</span>
        <span class="tok-kr">perms</span> <span class="tok-o">=&gt;</span> <span class="tok-kd">namespace</span><span class="tok-p">:</span><span class="tok-nf">myperms</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that namespacing also affects global classes: they will be global only within the namespace in which they are declared. Global classes from other namespaces can also be used by prefixing them with the namespace, separated by a colon.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Bundles and bodies in the CFEngine Standard Library are declared in the default namespace. To call them from a namespaced file, you need to explicitly prefix them with "default:".</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will not use namespaces in the examples in this book, to keep things simple. However, namespacing is a powerful mechanism that will help you grow your policies with a minimum of naming conflicts, so I encourage you to use them whenever appropriate.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="normal-ordering">Normal Ordering</h4>
<div class="paragraph">
<p>CFEngine does not have any flow control statements, at least not in the sense with which you may be familiar from imperative programming languages (the concept of implicit flow control may be familiar to you if you have done any declarative programming before, for example in Prolog). A lot of the behavior of CFEngine is hard-coded, and this includes the order in which things are evaluated. This is called <em>normal ordering</em>, and is determined based on what makes sense for different types of bundles and promises. For example, it makes no sense to first create a file and then delete it, while it makes sense to first delete it and then create it again. Normal ordering can, if needed, be overriden by defining classes after an operation completes, and then defining other operations based on that class (for details, see <a href="#controlling-promise-execution-order">[controlling-promise-execution-order]</a>).</p>
</div>
<div class="paragraph">
<p>Bundles of type <a href="http://cf-learn.info/ref/common">common</a> are a good place to define variables and classes that will be accessible to all other bundles in the policy. All classes in common bundles are global, and all variables in them are accessible from other bundles by prefixing them with the bundle name, as in $(bundle.variable).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>CFEngine has mechanisms to detect variable/class dependencies and a best-effort algorithm to make sure all necessary values are available before an expression or promise is evaluated. You can help it ensure consistency and convergence by including bundles of type <a href="http://cf-learn.info/ref/common">common</a> in the <a href="http://cf-learn.info/ref/bundlesequence">bundlesequence</a> declaration, even though this is not strictly needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For <a href="http://cf-learn.info/ref/agent">agent</a> bundles, CFEngine will execute them up to three times in an attempt to achieve a convergent state. In each iteration, the sections in the bundle will be executed in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://cf-learn.info/ref/vars"> vars </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/classes"> classes </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/interfaces"> interfaces </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/files"> files </a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In turn, within <a href="http://cf-learn.info/ref/edit_line">edit_line</a> bundles, the following order will be kept:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://cf-learn.info/ref/vars"> vars </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/classes"> classes </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/delete_lines"> delete_lines </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/field_edits"> field_edits </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/insert_lines"> insert_lines </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/replace_patterns"> replace_patterns </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/reports"> reports </a></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://cf-learn.info/ref/packages"> packages </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/guest_environments">guest_environments</a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/methods"> methods </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/processes"> processes </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/services"> services </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/commands"> commands </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/storage"> storage </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/databases">databases</a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/reports"> reports </a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Within each section, promises will be executed in the order in which they appear in the policy. Multiple executions of each bundle mean that you can, for example, define a variable, then define a class based on that variable, and then define other variables depending on that class. The three iterations may not be executed in all cases - if there are no promises repaired during an iteration, then CFEngine assumes the bundle has converged, and stops further iterations.</p>
</div>
<div class="paragraph">
<p>Within <a href="http://cf-learn.info/ref/bundles-for-server">server</a> bundles, the normal ordering is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://cf-learn.info/ref/vars"> vars </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/classes"> classes </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/access"> access </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/roles"> roles </a></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Although syntactically correct, <a href="http://cf-learn.info/ref/reports-in-common-promises">reports:</a> promises that appear inside a <a href="http://cf-learn.info/ref/bundles-for-server">server</a> bundle are not evaluated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Within <a href="http://cf-learn.info/ref/monitor">monitor</a> bundles, the normal ordering is as follows (sections marked with * are only available in CFEngine Enterprise):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://cf-learn.info/ref/vars"> vars </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/classes"> classes </a></p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/measurements">measurements</a> *</p>
</li>
<li>
<p><a href="http://cf-learn.info/ref/reports"> reports </a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Normal ordering provides a fairly rigid structure to the execution of CFEngine policies. It is common when you first start writing CFEngine policies, particularly if you are familiar with imperative programming, to try to “fight” the normal ordering to fit what you want to do. When you encounter a case in which you are positive that normal ordering needs to be changed, I encourage you to back up and rethink at a higher level the task you want to accomplish. Most of the time, you will find that structuring the task in some other way will make the need to reorder operations go away, and will in fact make more sense with the way CFEngine “thinks.”</p>
</div>
</div>
<div class="sect3">
<h4 id="looping-in-cfengine">Looping in CFEngine</h4>
<div class="paragraph">
<p>One of the most evident examples of “thinking in CFEngine” is the concept of implicit looping. It is one of the most basic behaviors, one of the most confusing to a CFEngine beginner, and one of the most powerful once you harness it.</p>
</div>
<div class="paragraph">
<p>First, let us define it: in CFEngine 3, if you refer to a list variable (normally called @(var)) as a scalar ($(var)), CFEngine interprets it to mean “iterate over all the values in the list.”</p>
</div>
<div class="paragraph">
<p>Let’s try it. Type in the following policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;test&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">colors</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;red&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;green&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;blue&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(colors)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --no-lock --inform -f ./looping1.cf
<span class="tok-go">2013-10-14T05:35:18+0000   notice: /test: R: red</span>
<span class="tok-go">2013-10-14T05:35:18+0000   notice: /test: R: green</span>
<span class="tok-go">2013-10-14T05:35:18+0000   notice: /test: R: blue</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The lines that start with "R: " indicate messages produced by the <a href="http://cf-learn.info/ref/reports">reports:</a> promises in the policy. You can see that the single promise in the <a href="http://cf-learn.info/ref/reports">reports:</a> section has been repeated for every value in the list, therefore printing all the values.</p>
</div>
<div class="paragraph">
<p>You can also try nested looping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">test</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">colors</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;red&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;green&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;blue&quot;</span> <span class="tok-p">};</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">tone</span><span class="tok-p">&quot;</span>   <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;dark&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;light&quot;</span> <span class="tok-p">};</span>
  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine_3</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(tone)</span><span class="tok-s"> </span><span class="tok-si">$(colors)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This returns the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent -K -f ./looping2.cf
<span class="tok-go">2013-10-14T05:35:49+0000   notice: /test: R: dark red</span>
<span class="tok-go">2013-10-14T05:35:49+0000   notice: /test: R: light red</span>
<span class="tok-go">2013-10-14T05:35:49+0000   notice: /test: R: dark green</span>
<span class="tok-go">2013-10-14T05:35:49+0000   notice: /test: R: light green</span>
<span class="tok-go">2013-10-14T05:35:49+0000   notice: /test: R: dark blue</span>
<span class="tok-go">2013-10-14T05:35:49+0000   notice: /test: R: light blue</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Simple enough, isn’t it? In this explicit example, the behavior is clear. The real power of implicit looping comes when you realize that it can be used in <em>any</em> type of promise, and that it means the <em>whole promise</em> will be executed as many times as there are items in the list. Also, the looping variable can be used anywhere—in defining variables or classes, in executing commands, or in making decisions with classes.</p>
</div>
<div class="paragraph">
<p>Let’s look at a real example in which implicit looping saved the day (this was, incidentally, the time when this really “clicked” in my head as I was starting with CFEngine 3). I needed to determine which network interface in a system was configured in a certain network segment, to apply some configuration commands.</p>
</div>
<div class="paragraph">
<p>CFEngine has a built-in array variable called sys.ipv4 that contains the IP addresses of all the network interfaces in the system, indexed by interface name. My first thought was that I needed a function that gave me all the values stored in this array, so I could compare them against my desired IP address range and find the one I needed.</p>
</div>
<div class="paragraph">
<p>To my surprise, I realized that CFEngine has a <a href="http://cf-learn.info/ref/getindices">getindices()</a> function, but no equivalent <a href="http://cf-learn.info/ref/getvalues">getvalues()</a> function (actually this function was added as of version 3.1.5, but wasn’t available when I came up with this solution, and in any case this is much more elegant). After turning the problem over a lot in my head, I came to the realization that the <a href="http://cf-learn.info/ref/getvalues">getvalues()</a> function is not needed in this case. Here is the code I came up with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">bundlesequence</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;find_netif&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span>

<span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">find_netif</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">nics</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">getindices</span><span class="tok-p">(</span><span class="tok-s">&quot;sys.ipv4&quot;</span><span class="tok-p">);</span> <b class="conum">(1)</b>
      <span class="tok-c"># Regex we want to match on the IP address</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">ipregex</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;192</span><span class="tok-se">\.</span><span class="tok-s">168</span><span class="tok-se">\.</span><span class="tok-s">1</span><span class="tok-se">\.</span><span class="tok-s">.*&quot;</span><span class="tok-p">;</span>

  <span class="tok-kd">classes</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;ismatch_</span><span class="tok-si">$(nics)</span><span class="tok-s">&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">regcmp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(ipregex)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
                                             <span class="tok-s">&quot;</span><span class="tok-si">$(sys.ipv4[$(nics)])</span><span class="tok-s">&quot;</span><span class="tok-p">);</span> <b class="conum">(2)</b>

  <span class="tok-kd">reports</span><span class="tok-p">:</span>
    <span class="tok-nc">cfengine</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;NICs found: </span><span class="tok-si">$(nics)</span><span class="tok-s"> (</span><span class="tok-si">$(sys.ipv4[$(nics)])</span><span class="tok-s">)&quot;</span><span class="tok-p">;</span>

      <span class="tok-s">&quot;Matched NIC: </span><span class="tok-si">$(nics)</span><span class="tok-s"> (</span><span class="tok-si">$(sys.ipv4[$(nics)])</span><span class="tok-s">)&quot;</span>
        <span class="tok-kr">ifvarclass</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;ismatch_</span><span class="tok-si">$(nics)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span> <b class="conum">(3)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us look at this in detail.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First, we get a list (using
<a href="http://cf-learn.info/ref/getindices">getindices()</a> of all the
network interfaces in the system, and store it in the nics
variable. We also assign into ipregex the regular expression for
the IP address range I want to match (in this case, 192.168.1.*).</p>
</li>
<li>
<p>Then we use this list, referenced as a scalar, in the
<a href="http://cf-learn.info/ref/classes">classes:</a> promise, to define a
number of classes named after each of the interfaces, by using
$(nics) in the class name itself. The definition of the class
depends on whether the IP address of that network interface
($(nics) is used again in the call to the
<a href="http://cf-learn.info/ref/regcmp">regcmp()</a> method) matches the
regular expression of the IP address I want to find. The result is
that, for each NIC on the system, the corresponding class is
defined if its IP address matches, and undefined if it does not.</p>
</li>
<li>
<p>Finally, we print all the interfaces by using $(nics) in a report
message, and we also print only the matching ones by conditioning
the second message using the ifvarclass =&gt; "ismatch_$(nics)"
attribute. The reference to $(nics) in
the <a href="http://cf-learn.info/ref/ifvarclass">ifvarclass</a> attribute is
also expanded to each value in turn, so the second message is
printed only for those NICs whose corresponding class is defined.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So you see, we do not need the getvalues() function after all. In
this example I used the defined classes to print messages, but in my
real example I used them to append the appropriate configuration
statements to a file—but only for those interfaces that matched the IP
range I wanted.</p>
</div>
<div class="paragraph">
<p>I encourage you to look at that example again, and make sure you
understand it. There are no looping constructs anywhere—in fact, they
do not exist in the CFEngine syntax at all. It may take a while
getting used to this. Whenever you are constructing a policy and you
think “I definitely need a while loop to do this,”
take a step back and see whether you can recast the problem using
implicit looping. The definition of classes based on a condition using
implicit looping is a powerful technique, and you will see it used in
many of the examples in this book.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to CFEngine 3.3.0, looping was allowed only for local lists (those declared in the current bundle). Starting with 3.3.0 this limitation was removed, and you can now loop over lists from any bundle, provided that you properly qualifiy its name with the bundle name where it is declared ($(bundle.var)).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="thinking-in-cfengine">Thinking in CFEngine</h4>
<div class="paragraph">
<p>As we have seen, CFEngine imposes a rigid structure on many aspects of its operation. Two prime examples are normal ordering and implicit looping, which help get rid of the need for explicit control flow statements. For the most part, you do not tell CFEngine how to do things. Rather, you tell it <em>what you want to achieve</em> and write out the low-level building blocks of how to achieve certain promises, and CFEngine will put them together for you to bring the system to the desired state.</p>
</div>
<div class="paragraph">
<p>If you are like me, you have been programming for some time before you encountered CFEngine, and your brain is wired to think about problems and tasks in a certain way. This will almost inevitably cause a clash when you have to “let go” of the control and lend it over to CFEngine.</p>
</div>
<div class="paragraph">
<p>I have personally found that what works for me is to “step back” from the details of the task at hand, and think at a higher level: “what am I trying to achieve?” Often this gives a different perspective on why you are doing certain things, and how you are trying to achieve them. My main advice is to keep practicing, and to use the community resources available to study examples and to get feedback on your promises from more experienced users.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clients-and-servers-2">Clients and Servers</h3>
<div class="paragraph">
<p>One of CFEngine’s key strengths is autonomy. A machine in which CFEngine is installed and configured does not need a network connection to operate, and as long as its policies are well defined, it will continue to obey those policies and maintain the system as configured. For instance, a laptop that is sometimes connected to the company network, but is also often away, will continue to benefit from CFEngine running on it.</p>
</div>
<div class="paragraph">
<p>However, the true power of CFEngine lies in its ability to manage thousands of machines with very little effort, and for this you need to distribute the corresponding policies to all those hosts. Fortunately, CFEngine makes it very easy to set up a client-server environment in which one or more hosts act as policy hubs, distributing policies and data to others. As we saw in <a href="#bootstrapping-cfengine">[bootstrapping-cfengine]</a>, all it requires is a single command to configure CFEngine and tell it which machine to use as its policy hub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --bootstrap x.y.z.w</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to CFEngine 3.5.0 the bootstrapping options were different. This is the command you have to run for older versions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">#</span> cf-agent --bootstrap --policy-server x.y.z.w</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This command works on both the policy hub itself and its clients. In the hub, <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> will recognize its own IP address and configure the host as a policy hub.</p>
</div>
<div class="paragraph">
<p>In its simplest form, and one perfectly suitable for all but the largest of organizations, you can have a single policy hub with multiple clients fetching policies and files from it, as shown in <a href="#cfengine-simple-distributed">The simplest form of CFEngine distributed deployment, with a single policy hub and multiple clients</a>.</p>
</div>
<div id="cfengine-simple-distributed" class="imageblock">
<div class="content">
<img src="../figs/web/lcfe_0302.png" alt="lcfe 0302">
</div>
<div class="title">Figure 2. The simplest form of CFEngine distributed deployment, with a single policy hub and multiple clients</div>
</div>
<div class="paragraph">
<p>In larger and more complex environments, you can have a more complex structure. A CFEngine policy hub can itself be a client for some other hub, thus creating a hierarchy of CFEngine policy distribution points, as shown in <a href="#cfengine-complex-distributed">More complex CFEngine distributed deployment, with multiple policy hubs in a hierarchy</a>.</p>
</div>
<div id="cfengine-complex-distributed" class="imageblock">
<div class="content">
<img src="../figs/web/lcfe_0303.png" alt="lcfe 0303">
</div>
<div class="title">Figure 3. More complex CFEngine distributed deployment, with multiple policy hubs in a hierarchy</div>
</div>
<div class="paragraph">
<p>The need for a hierarchical structure could be dictated by technical requirements (e.g., geographically disperse sites, low-bandwidth links between them, traffic blocking) or administrative needs (e.g., different teams in charge of different locations, needing to make their own customizations to the top-level inherited policies). CFEngine is flexible enough to accomodate any of them. Ideally, all the policy files should propagate from the top-level, where they are maintained in a master repository, but you could also have several disjoint trees in your organization.</p>
</div>
<div class="paragraph">
<p>CFEngine follows a strict pull-only philosophy: only the client can make requests to the server, asking for the information and files it needs. The server cannot push anything onto the clients. This convention makes it very simple to configure the network to allow communication between CFEngine clients and servers. Only one port—TCP/5308—is necessary for the client to connect to the server. All communication, including file transfers, takes place through this port.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> command can be used on the server to contact the clients. In this case port, TCP/5308 also needs to be open from the server to the clients, and <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> needs to be running on the clients to process those connections. Note, however, that <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> does not allow the server to execute arbitrary commands on the clients. All that it does is instruct <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> on the client to “wake up” and process its policies immediately, instead of waiting for the next scheduled run. We will see the details of this configuration in <a href="#remote-execution-cfrunagent">CFEngine Remote Execution Using cf-runagent</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The decision to only allow the clients to pull from the server (and not the server to push things onto the clients) is also rooted in promise theory. An entity cannot make promises about anyone other than itself. Because of this, the operation of a distributed system cannot depend on one entity forcing others to do something. Entities may request information from others, but they may make promises only about their own behavior. <em>Voluntary cooperation</em> is one of CFEngine’s core principles.</p>
</div>
<div class="paragraph">
<p>On the other hand, CFEngine is designed with resilience and graceful degradation in mind. If a client becomes disconnected from the network, CFEngine continues managing it using the latest locally-stored version of the policies until it restores connectivity. This allows clients to continue working during network outages, network congestion, security incidents, or other circumstances that may prevent connectivity to the master policy hub.</p>
</div>
<div class="sect3">
<h4 id="cfengine-server-configuration">CFEngine Server Configuration</h4>
<div class="paragraph">
<p>The CFEngine server functionality is provided by the <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> process. It is configured using a <a href="http://cf-learn.info/ref/control-server">server control</a> body block like in the following example, taken from the default configuration provided with CFEngine (this is part of the <em>/var/cfengine/inputs/controls/cf_serverd.cf</em> file generated when you bootstrap CFEngine):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">server</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
        <span class="tok-kr">denybadclocks</span>         <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">;</span>
        <span class="tok-kr">allowconnects</span>         <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;127.0.0.1&quot;</span> <span class="tok-p">,</span> <span class="tok-s">&quot;::1&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@(def.acl)</span> <span class="tok-p">};</span>
        <span class="tok-kr">allowallconnects</span>      <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;127.0.0.1&quot;</span> <span class="tok-p">,</span> <span class="tok-s">&quot;::1&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@(def.acl)</span> <span class="tok-p">};</span>
        <span class="tok-kr">trustkeysfrom</span>         <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;127.0.0.1&quot;</span> <span class="tok-p">,</span> <span class="tok-s">&quot;::1&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@(def.acl)</span> <span class="tok-p">};</span>
        <span class="tok-kr">skipverify</span>            <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.*</span><span class="tok-si">$(def.domain)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;127.0.0.1&quot;</span> <span class="tok-p">,</span> <span class="tok-s">&quot;::1&quot;</span><span class="tok-p">,</span>
                                   <span class="tok-nv">@(def.acl)</span> <span class="tok-p">};</span>
        <span class="tok-kr">allowusers</span>            <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;root&quot;</span> <span class="tok-p">};</span>
        <span class="tok-kr">maxconnections</span>        <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;100&quot;</span><span class="tok-p">;</span>

      <span class="tok-c"># Uncomment the line below to allow remote users to run</span>
      <span class="tok-c"># cf-agent through cf-runagent</span>

      <span class="tok-c"># cfruncommand          =&gt; &quot;$(sys.cf_agent)&quot;;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The default policy files produced by CFEngine when you bootstrap a client are an excellent starting point and provide a lot of basic functionality. I advise you to go over them and try to get at least a general understanding of what they do. Most of the parts you may need to customize are in <em>def.cf</em>, <em>promises.cf</em> and some of the files under <em>controls/</em>, as needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This body defines the set of machines from which connections will be allowed <a href="http://cf-learn.info/ref/allowconnects">allowconnects</a>), those that will be allowed to connect multiple times simultaneously <a href="http://cf-learn.info/ref/allowallconnects">allowallconnects</a>),<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup> those whose public keys will be trusted if they have not been seen before <a href="http://cf-learn.info/ref/trustkeysfrom">trustkeysfrom</a>) and those whose DNS record will not be checked for consistency <a href="http://cf-learn.info/ref/skipverify">skipverify</a>). Also specified are the maximum number of simultaneous connections <a href="http://cf-learn.info/ref/maxconnections">maxconnections</a>), the users that will be allowed to connect <a href="http://cf-learn.info/ref/allowusers">allowusers</a>), and whether machines with out-of-sync clocks will be blocked <a href="http://cf-learn.info/ref/denybadclocks">denybadclocks</a>).</p>
</div>
<div class="paragraph">
<p>Additionally, per-directory and per-file ACLs can be defined in the access_rules() bundle, whose default version contains the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">server</span> <span class="tok-nf">access_rules</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-kd">access</span><span class="tok-p">:</span>
    <span class="tok-nc">any</span><span class="tok-p">::</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(def.dir_masterfiles)</span><span class="tok-s">&quot;</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;server_access_rule_grant_access_policy&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Grant access to the policy updates&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">admit</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;.*</span><span class="tok-se">\.</span><span class="tok-si">$(def.domain)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@(def.acl)</span> <span class="tok-p">};</span>
  <span class="tok-kd">roles</span><span class="tok-p">:</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This bundle contains promises of type <a href="http://cf-learn.info/ref/access">access:</a>, which define the ACLs to apply. In this case, directory $(def.dir_masterfiles) (which expands by default to <em>/var/cfengine/masterfiles</em>) will be accessible by all machines in the $(def.domain) domain, plus those defined explicitely in the @(def.acl) list.</p>
</div>
<div class="paragraph">
<p>Note that most of these parameters include the @(def.acl) and $(def.domain) variables. These are references to the acl and domain variables defined in the def() bundle, which is defined in <em>/var/cfengine/inputs/def.cf</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">common</span> <span class="tok-nf">def</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">domain</span><span class="tok-p">&quot;</span>  <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;example.com&quot;</span><span class="tok-p">,</span>  <b class="conum">(1)</b>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Define a global domain for all hosts&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;common_def_vars_domain&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">acl</span><span class="tok-p">&quot;</span> <span class="tok-kt">slist</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span>
                       <span class="tok-s">&quot;</span><span class="tok-si">$(sys.policy_hub)</span><span class="tok-s">/16&quot;</span>  <b class="conum">(2)</b>
                     <span class="tok-p">},</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Define an acl for the machines to be granted accesses&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;common_def_vars_acl&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">dir_masterfiles</span><span class="tok-p">&quot;</span> <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">translatepath</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(sys.workdir)</span><span class="tok-s">/masterfiles&quot;</span><span class="tok-p">),</span>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Define masterfiles path&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;common_def_vars_dir_masterfiles&quot;</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You are expected to edit the def() bundle before putting CFEngine into production, in particular two values:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The $(domain) variable must contain the domain name of your
current environment. This is used in the code shown earlier to
limit access to machines from this domain. It is also used in
some other contexts in the default <em>promises.cf</em> file.</p>
</li>
<li>
<p>The @(acl) variable is a list containing all the IP addresses that
should have access to the server. This promise uses the value of
$(sys.policy_hub) (an <a data-type="indexterm" data-primary="$(sys.policy_hub) variable" data-primary-sortas="sys.policy_hub variable"> </a>
automatically-set variable that contains the IP address of the hub
from which the host was bootstrapped) and determines its local
class-B network (/16). The assumption is that the policy hub will
in most cases be in the same network as the client. Of course,
this range may well be too broad or too narrow according to your
needs, so you must edit it <a data-type="indexterm" data-primary="" data-startref="ch3-config3"> </a><a data-type="indexterm" data-primary="" data-startref="ch3-config"> </a><a data-type="indexterm" data-primary="" data-startref="ch3-config4"> </a>
accordingly.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_updating_client_files_from_the_server">Updating Client Files from the Server</h4>
<div class="paragraph">
<p>One of the main tasks of the policy hub is to distribute policy files, and any other necessary files, to its clients. This is a crucial operation, since it makes it possible to update files on the hub and have them propagate automatically to all the clients. To this effect, CFEngine provides ample capabilities for efficient and secure file transfer.</p>
</div>
<div class="paragraph">
<p>The default policy installed with CFEngine contains a bundle called cfe_internal_update() which is executed <em>on the clients</em> (remember that the CFEngine policy hub cannot instruct the clients to do anything). It takes care of all these tasks automatically, but you may want to modify it according to your needs. It is contained in the file <em>/var/cfengine/inputs/update.cf</em>, and in a nutshell these are the tasks it performs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check whether the host key files exist (under <em>/var/cfengine/ppkeys/</em>), and run cf-key to create them if they are not present.</p>
</li>
<li>
<p>Start the cf-serverd, cf-monitord and cf-execd processes if they are not running.</p>
</li>
<li>
<p>Copy updated files from <em>/var/cfengine/masterfiles/</em> on the policy hub to <em>/var/cfengine/inputs/</em> on all machines (both the clients and the policy hub) to put them in production.</p>
</li>
<li>
<p>Symlink CFEngine binaries from <em>/var/cfengine/bin/</em> to <em>/usr/local/sbin/</em> for easier access.</p>
</li>
<li>
<p>Ensure all critical directories and files have the correct permissions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For now we will look only at the file-copying operations, but I encourage you to read through the whole bundle to get an idea of what it does. These are the crucial parts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">agent</span> <span class="tok-nf">cfe_internal_update</span>
<span class="tok-p">{</span>
  <span class="tok-kd">vars</span><span class="tok-p">:</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">inputs_dir</span><span class="tok-p">&quot;</span>
        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">translatepath</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(sys.workdir)</span><span class="tok-s">/inputs&quot;</span><span class="tok-p">),</span>   <b class="conum">(1)</b>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Directory containing Cfengine policies&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;update_vars_inputs_dir&quot;</span><span class="tok-p">;</span>
      <span class="tok-p">&quot;</span><span class="tok-nv">master_location</span><span class="tok-p">&quot;</span>
        <span class="tok-kt">string</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;/var/cfengine/masterfiles&quot;</span><span class="tok-p">,</span>   <b class="conum">(2)</b>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;The master cfengine policy directory on the policy host&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;update_vars_master_location&quot;</span><span class="tok-p">;</span>
  <span class="tok-kd">files</span><span class="tok-p">:</span>
      <span class="tok-s">&quot;</span><span class="tok-si">$(inputs_dir)</span><span class="tok-s">&quot;</span>   <b class="conum">(3)</b>
        <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Copy policy updates from master source on policy server&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;update_files_inputs_dir&quot;</span><span class="tok-p">,</span>
        <span class="tok-kr">copy_from</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">u_rcp</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(master_location)</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;</span><span class="tok-si">$(sys.policy_hub)</span><span class="tok-s">&quot;</span><span class="tok-p">),</span>  <b class="conum">(4)</b>
        <span class="tok-kr">depth_search</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">u_recurse</span><span class="tok-p">(</span><span class="tok-s">&quot;inf&quot;</span><span class="tok-p">),</span>   <b class="conum">(5)</b>
        <span class="tok-kr">file_select</span>  <span class="tok-o">=&gt;</span> <span class="tok-nf">u_input_files</span><span class="tok-p">,</span>   <b class="conum">(6)</b>
        <span class="tok-kr">classes</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">u_if_repaired</span><span class="tok-p">(</span><span class="tok-s">&quot;update_report&quot;</span><span class="tok-p">);</span>   <b class="conum">(7)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The $(inputs_dir) variable contains the directory where the local
CFEngine installation expects to find its policy files. On Unix/Linux
hosts this is normally <em>/var/cfengine/inputs</em>, but the location can
vary in different platforms. For this reason, we are using the
$(sys.workdir) variable, which is automatically defined to be the base
directory of the local CFEngine installation. We are also using the
translatepath() function to translate the Unix-style path into the
local style (for example, using backslashes instead of forward slashes
on Windows).</p>
</li>
<li>
<p>The $(master_location) variable contains the directory on the policy
hub where the "master files" are located, and from where they will be
copied to the local host. The policy hub has to be a Unix-style host,
so in this case we don&#8217;t need to perform any path translation.</p>
</li>
<li>
<p>The <code>files:</code>
promise is the one that does the actual work. The promiser is the
destination directory $(inputs_dir), to which the files will be copied
according to the parameters specified by the promise attributes that
follow.</p>
</li>
<li>
<p>The <code>copy_from</code> attribute indicates the
  source of the files. The value of this attribute is a body, defined in
  the same <em>update.cf</em> file as follows: <pre data-type="programlisting" data-code-language="cf3">body copy_from u_rcp(from,server)
{
        source      => "$(from)";
        compare     => "digest";
        trustkey    => "true";
    !am_policy_hub&#58;&#58;
        servers => { "$(server)" };
}</pre>
  This body receives as arguments the directory and the host from where
  the files should be copied. $(master_location) is the variable defined
  before, and $(sys.policy_hub) is a special CFEngine variable that
  is set when the client is bootstrapped, as described in
  #bootstrapping-cfengine. Additionally, it indicates that the files
  should be compared using a cryptographic digest (compare &#8658; "digest"),
  and that the client should trust the cryptographic keys presented by
  the server (<a href="http://cf-learn.info/ref/trustkey"><code>trustkey &#8658; "true"</code></a>).
  The <code>servers</code> attribute is set only when the am_policy_hub class is
  not set, and am_policy_hub is a hard class set only on the policy hub,
  so the effect is that on the policy hub, the file copy operation will
  be done locally, from <em>/var/cfengine/masterfiles/</em> to
  <em>/var/cfengine/inputs/</em>.</p>
</li>
<li>
<p>The <code>depth_search</code> attribute is used to
  indicate a recursive file copy operation of infinite depth. Its value
  is another body: <pre data-type="programlisting" data-code-language="cf3">
body depth_search u_recurse(d)
{
        depth => "$(d)";
        exclude_dirs => { "\.svn" };
}</pre>
  The <code>depth</code>
  attribute is set to the passed argument (which can be a number, or the
  special value <code>"inf"</code> for infinite recursion). The <code>exclude_dirs</code>
  attribute is also used to skip version-control directories that may be
  present in the server (assuming that version control is done using
  Subversion).</p>
</li>
<li>
<p>The <code>file_select</code> attribute is used to
  control which types of files are copied. This is another body: <pre data-type="programlisting" data-code-language="cf3">body file_select u_input_files
{
        leaf_name => { ".*.cf",".*.dat",".*.txt" };
        file_result => "leaf_name";
}</pre>
  In this case
  we are asking CFEngine to copy only files whose names end with <code>.cf</code>,
  <code>.dat</code> and <code>.txt</code>. There are many criteria that can be specified in a
  <code>file_select</code> body, and for this reason we need the <code>file_result</code>
  attribute to tell CFEngine on which criteria we want to match (in this
  case it is the only one available).</p>
</li>
<li>
<p>The <code>classes</code> attribute indicates that if any files are copied (which
  flags the promise as “repaired”), then the update_report class should
  be set. This class can be used in other parts of the policy to execute
  any actions necessary (for example, produce a report) when the files
  are updated. This is yet another body that sets the appropriate class:
  <pre data-type="programlisting" data-code-language="cf3">body classes u_if_repaired(x)
{
        promise_repaired => { "$(x)" };
}</pre></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>File-copy promises are extremely flexible and powerful. Policy and binary updates are automatically handled by the built-in CFEngine policies, but I encourage you to read the <a href="http://cf-learn.info/ref/files-in-agent-promises">documentation for files: promises</a> to get a good idea of the wide range of tasks they can perform.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Why is this bundle in the <em>update.cf</em> file instead of the <em>promises.cf</em> file? The default CFEngine policy instructs cf-execd (this is defined in the body executor control in <em>/var/cfengine/inputs/controls/cf_execd.cf</em>) to always evaluate <em>update.cf</em> before running <em>promises.cf</em>, to ensure that all files are properly updated. Additionally, if there is any failure in policy evaluation, cf-agent automatically tries to load <em>failsafe.cf</em>, which performs many of the same update operations to try and bring CFEngine back into operation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="remote-execution-cfrunagent">CFEngine Remote Execution Using cf-runagent</h4>
<div class="paragraph">
<p>One of the basic premises of CFEngine is that clients operate autonomously. If there is a central coordination point, like the policy hub, it is up to the clients to connect to it and fetch policies or files. However, in practice, the server (or some other machine) sometimes needs to “ping” the clients and ask them to do something. This is where <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> comes in. It does not allow arbitrary actions to be executed, but simply asks the remote machine to run <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> and evaluate its policies. The remote host (in most cases it would be a CFEngine client) needs to have <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a> running and configured to listen for connections from <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a>.</p>
</div>
<div class="paragraph">
<p>Allow me to emphasize this point: <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> does not allow the execution of arbitrary commands or arbitrary actions on a remote host. It simply instructs the host to run <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> and start evaluating its policies. This is useful when you don’t want to wait until the next regular execution of <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> (for example, critical policy or operating system updates).</p>
</div>
<div class="paragraph">
<p>The behavior of the <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> command can be configured as part of the CFEngine policy in a <a href="http://cf-learn.info/ref/control-runagent">runagent control</a> body, which allows you to specify, among other things, a list of hosts that will be contacted by default when running the command. On the client side (the one to which the cf-runagent command will connect), the server control body specifies whether <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> connections will be allowed, and what they will be allowed to do. It can also specify a list of remote users that will be allowed to set custom classes when running <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a>. This allows more fine-grained control of the policy behavior.</p>
</div>
<div class="paragraph">
<p><a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> connections are handled by <a href="http://cf-learn.info/ref/cf-serverd">cf-serverd</a>, so if you need this functionality you will also need to open port TCP/5308 traffic from the server to the clients.</p>
</div>
<div class="paragraph">
<p>Because of its potential security implications, the cf-runagent functionality comes disabled in the CFEngine default policy. To enable it, you need to uncomment the cfruncommand attribute in the server control body, shown in <a href="#cfengine-server-configuration">CFEngine Server Configuration</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-kr">cfruncommand</span>          <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;</span><span class="tok-si">$(sys.cf_agent)</span><span class="tok-s">&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This instructs cf-serverd to listen for connections from cf-runagent, and to execute cf-agent in response to them (remember that this is all that cf-runagent allows you to do: wake up cf-agent). We still need to instruct cf-serverd to allow access to the cf-agent binary (its path is stored in the special variable <a href="http://cf-learn.info/ref/cf_agent">$(sys.cf_agent)</a>, normally <em>/var/cfengine/bin/cf-agent</em>) from the policy hub. We need to do this in the access_rules() bundle, stored in <em>/var/cfengine/inputs/controls/cf_serverd.cf</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">bundle</span> <span class="tok-k">server</span> <span class="tok-nf">access_rules</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
 <span class="tok-kd">access</span><span class="tok-p">:</span>
  <span class="tok-nc">any</span><span class="tok-p">::</span>
<span class="tok-err">...</span>
  <span class="tok-s">&quot;</span><span class="tok-si">$(sys.cf_agent)</span><span class="tok-s">&quot;</span>
    <span class="tok-kr">handle</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;grant_access_policy_agent&quot;</span><span class="tok-p">,</span>
    <span class="tok-kr">comment</span> <span class="tok-o">=&gt;</span> <span class="tok-s">&quot;Grant access to the agent (for cf-runagent)&quot;</span><span class="tok-p">,</span>
    <span class="tok-kr">admit</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;</span><span class="tok-si">$(sys.policy_hub)</span><span class="tok-s">&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, we are telling cf-serverd to allow access to the <a href="http://cf-learn.info/ref/cf-agent">cf-agent</a> binary only to the policy hub, as defined by the special variable <a href="http://cf-learn.info/ref/policy_hub">$(sys.policy_hub)</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we need to tell the policy hub which hosts to contact by default when <a href="http://cf-learn.info/ref/cf-runagent">cf-runagent</a> is executed. We need to do this explicitly in the <a href="http://cf-learn.info/ref/control-runagent">runagent control</a> body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">runagent</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
      <span class="tok-c"># A list of hosts to contact when using cf-runagent</span>

    <span class="tok-nc">any</span><span class="tok-p">::</span>

        <span class="tok-kr">hosts</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;127.0.0.1&quot;</span> <span class="tok-p">};</span>

      <span class="tok-c"># , &quot;myhost.example.com:5308&quot;, ...</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that defining this list is not strictly necessary, as the list of hosts can be specified in the command line when running cf-runagent, using the --hail option.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cfengine-information-resources">CFEngine Information Resources</h3>
<div class="paragraph">
<p>CFEngine has been around for a long time, and it has developed a solid body of documentation and information. In addition to community support, the company that was formed to provide commercial support for CFEngine, CFEngine AS, provides extensive documentation and information, most of it free of charge.</p>
</div>
<div class="paragraph">
<p>One word of caution: Some of the information you find online may still be geared towards CFEngine 2. While you can apply many of the basic ideas, be aware that the syntax of CFEngine 3 is completely different and incompatible with the previous version.</p>
</div>
<div class="paragraph">
<p>Let’s look at some of the information resources available for CFEngine 3.</p>
</div>
<div class="sect3">
<h4 id="manuals-and-official-guides">Manuals and Official Guides</h4>
<div class="paragraph">
<p>Most of the documentation made available by CFEngine AS can be found at the <a href="https://cfengine.com/docs">CFEngine Documentation web page</a>. The core documentation includes the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cfengine.com/docs/3.5/reference.html"><em>Reference guides</em></a>: the most complete and authoritative reference for CFEngine concepts, installation, syntax, and examples.</p>
</li>
<li>
<p><a href="https://cfengine.com/docs/3.5/manuals.html">Manuals</a>: documents that describe different aspects of CFEngine, including its design, architecture and components, basic language concepts and more.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Apart from the core documents, you will find here a growing collection of <a href="http://cfengine.com/cfengine-special-topic-guides">Special Topics Guides</a>, a series of shorter documents that focus on specific advanced aspects of working with CFEngine. You can find documentation about best practices for different topics, such as team collaboration, integrating CFEngine into change management practices or specific frameworks such as the ITIL standard, reporting capabilities, knowledge management, etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="cfengine_stdlib">CFEngine Standard Library</h4>
<div class="paragraph">
<p>The CFEngine Standard Library contains implementations of a large number of commonly-used promise bundles and bodies. It includes bundles for tasks such as editing files in common formats, interfacing with common package and service managers, editing text files, and copying files. The standard library allows you to focus on the task at hand without having to worry about the details, and also serves as a fantastic source of examples, based on which you can extend or define your own bundles and bodies for CFEngine configuration. This library is constantly evolving, and users are encouraged to submit changes and additions to it. The CFEngine standard library is hosted in the <a href="https://github.com/cfengine/masterfiles">cfengine/masterfiles</a> repository on GitHub, but is included with the CFEngine distribution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The CFEngine Standard Library used to be known as the Community Open Promise Body Library (COPBL). This name is no longer being used, but you may still see some references to it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Standard Library underwent some recent reorganization, so depending on which version of CFEngine you are using, you need to use different methods to load it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Up until CFEngine 3.4.x, the standard library was contained in the single file <em>cfengine_stdlib.cf</em>. To use it, you must include it in your policy, in the common control body:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
    <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;cfengine_stdlib.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In CFEngine 3.5.0, the <em>cfengine_stdlib.cf</em> file was moved to the <em>libraries/</em> directory, so you need to update its path in your <a href="http://cf-learn.info/ref/inputs">inputs</a> attribute:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
    <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;libraries/cfengine_stdlib.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In CFEngine 3.5.1 and later, the <em>cfengine_stdlib.cf</em> file was split into multiple files by promise type, to cope with the increasing size and complexity of the standard library. Starting in this version, the parts of the library are stored under <em>lib/MAJOR.MINOR/</em>. For example, in CFEngine 3.5.2, all bodies and bundles related to <a href="http://cf-learn.info/ref/files">files:</a> promises are stored in <em>lib/3.5/files.cf</em>. You need to load the parts that you are going to use in your policy, for example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span><span class="tok-k">body</span> <span class="tok-k">common</span> <span class="tok-k">control</span>
<span class="tok-p">{</span>
    <span class="tok-kr">inputs</span> <span class="tok-o">=&gt;</span> <span class="tok-p">{</span> <span class="tok-s">&quot;lib/3.5/common.cf&quot;</span><span class="tok-p">,</span>
                <span class="tok-s">&quot;lib/3.5/files.cf&quot;</span><span class="tok-p">,</span>
                <span class="tok-s">&quot;lib/3.5/commands.cf&quot;</span> <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <em>libraries/cfengine_stdlib.cf</em> is still included in newer CFEngine distributions, but that file only includes bodies and bundles that are compatible with CFEngine 3.5.0 or earlier. You need to use the files from the version-specific directories if you want to get bodies and bundles that use newer features of the language.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The default <em>promises.cf</em> file in all CFEngine distributions automatically loads the standard library using the correct method for the current version of CFEngine, so you only need to worry about how to load it (and which parts to load) for standalone policy files you write. In this book, for the examples that need it, we will sometimes see the <em>cfengine_stdlib.cf</em> file, and others the specific files from the split library.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As of this CFEngine 3.5.2, the files that comprise the Standard Library (installed under <em>/var/cfengine/inputs/lib/3.5/</em>) are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">bundles.cf</dt>
<dd>
<p>Contains standalone agent bundles that perform common tasks, such as fileinfo() (extract file information using the filestat() function) and logrotate() (rotate log files by size).</p>
</dd>
<dt class="hdlist1">commands.cf</dt>
<dd>
<p>Defines a number of <a href="http://cf-learn.info/ref/contain">contain</a> bodies for use with <a href="http://cf-learn.info/ref/commands">commands:</a> promises.</p>
</dd>
<dt class="hdlist1">common.cf</dt>
<dd>
<p>Defines bodies that can be used with all promise types, such as <a href="http://cf-learn.info/ref/action">action</a> and <a href="http://cf-learn.info/ref/classes">classes</a> bodies.</p>
</dd>
<dt class="hdlist1">databases.cf</dt>
<dd>
<p>Contains database_server bodies to use with <a href="http://cf-learn.info/ref/databases">databases:</a> promises.</p>
</dd>
<dt class="hdlist1">files.cf</dt>
<dd>
<p>Includes all bundles and bodies that can be used with <a href="http://cf-learn.info/ref/files">files:</a> promises, including <a href="http://cf-learn.info/ref/edit_line">edit_line</a> bundles, edit_field bodies, <a href="http://cf-learn.info/ref/copy_from">copy_from</a> bodies, etc.</p>
</dd>
<dt class="hdlist1">guest_environments.cf</dt>
<dd>
<p>Includes <a href="http://cf-learn.info/ref/environment_resources">environment_resources</a> bodies to use in defining virtual machines for <a href="http://cf-learn.info/ref/guest_environments">guest_environments:</a> promises.</p>
</dd>
<dt class="hdlist1">monitor.cf</dt>
<dd>
<p>Includes bodies that can be used with <a href="http://cf-learn.info/ref/measurements">measurements:</a> promises (only in CFEngine Enterprise), such as <a href="http://cf-learn.info/ref/match_value">match_value</a> bodies.</p>
</dd>
<dt class="hdlist1">packages.cf</dt>
<dd>
<p>Includes all <a href="http://cf-learn.info/ref/package_method">package_method</a> body definitions, to use with <a href="http://cf-learn.info/ref/packages">packages:</a> promises to interact with different package and software managers.</p>
</dd>
<dt class="hdlist1">paths.cf</dt>
<dd>
<p>Contains the paths common bundle, which defines the paths for many common system binaries in different operating systems. By using this bundle, you can make your policies system-independent by avoding hard-coded command paths. For example, instead of using this, which will break on systems where ping is installed on a different path:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">classes</span><span class="tok-p">:</span>
    <span class="tok-s">&quot;is_host_up&quot;</span>
      <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span> <span class="tok-nf">returnszero</span><span class="tok-p">(</span><span class="tok-s">&quot;/usr/bin/ping -c 1 myhost.com&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cf3"><span></span>  <span class="tok-kd">classes</span><span class="tok-p">:</span>
    <span class="tok-s">&quot;is_host_up&quot;</span> <span class="tok-kr">expression</span> <span class="tok-o">=&gt;</span>
      <span class="tok-nf">returnszero</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$(paths.path[ping])</span><span class="tok-s"> -c 1 myhost.com&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">processes.cf</dt>
<dd>
<p>Includes <a href="http://cf-learn.info/ref/process_select">process_select</a> and <a href="http://cf-learn.info/ref/process_count">process_count</a> bodies for use with <a href="http://cf-learn.info/ref/processes">processes:</a> promises.</p>
</dd>
<dt class="hdlist1">services.cf</dt>
<dd>
<p>Includes the standard_services() bundle, which provides the built-in support for most common services in different operating systems, and implements the default behavior of <a href="http://cf-learn.info/ref/services">services:</a> promises.</p>
</dd>
<dt class="hdlist1">storage.cf</dt>
<dd>
<p>Defines <a href="http://cf-learn.info/ref/volume">volume</a> and <a href="http://cf-learn.info/ref/mount">mount</a> bodies to use with <a href="http://cf-learn.info/ref/storage">storage:</a> promises.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The standard library provides you with basic building blocks for implementing different tasks using CFEngine, but it provides no ready-made solutions for complex problems. This is the role of the CFEngine Solutions Guide and the CFEngine Design Center.</p>
</div>
</div>
<div class="sect3">
<h4 id="cfengine-solutions-guide">CFEngine Solutions Guide</h4>
<div class="paragraph">
<p>The <a href="https://docs.cfengine.com/docs/archive.bak/cf-manuals/cf3-solutions.html">Solutions Guide</a> is a collection of modular bundles with examples that are more complex than the building blocks included in the standard library, often corresponding to full tasks such as user creation and maintenance, email server management, or web server configuration. Some of these examples can be used as-is, but they are more suitable as starting points on which you can base your own configurations, customized to your specific needs and situation.</p>
</div>
</div>
<div class="sect3">
<h4 id="community-forums">Community Forum and IRC channel</h4>
<div class="paragraph">
<p>The official CFEngine help forum can be found in Google Groups, at <a href="http://bit.ly/cf_forum_new" class="bare">http://bit.ly/cf_forum_new</a>, and is a fantastic resource of information and help. Both CFEngine developers and advanced users participate actively in the forum, providing a friendly and fertile ground for newcomers to ask questions and learn about CFEngine, and for experienced users to exchange information, discuss advanced aspects, and provide feedback to the developers.</p>
</div>
<div class="paragraph">
<p>The official IRC channel is called #cfengine and hosted on <a href="http://freenode.net/" class="bare">http://freenode.net/</a> (use your favorite IRC client to connect to it). It is a good place to ask questions and have informal discussions with CFEngine users, engineers and developers. I would advise you to post complex questions to the forum, and use IRC only for quick questions or conversations.</p>
</div>
</div>
<div class="sect3">
<h4 id="cfengine-bug-tracker">CFEngine Bug Tracker</h4>
<div class="paragraph">
<p>The official mechanism for reporting bugs or feature requests is the <a href="http://cfengine.com/dev/">CFEngine issue tracker</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="other-community-provided-resources">Other Community Resources</h4>
<div class="paragraph">
<p>CFEngine users have also developed and made available an incredible amount of useful resources. Here is the list of some of the most useful ones.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Neil H. Watson’s <a href="http://watson-wilson.ca/blog/2011/03/08/cfengine-tutorial/">CFEngine 3 Tutorial</a> was one of the first tutorials available specifically for CFEngine 3, and provides a very useful, hands-on guide to CFEngine installation and setting up an initial scheme for experimenting. Neil also blogs at <a href="http://watson-wilson.ca" class="bare">http://watson-wilson.ca</a> about CFEngine, frequently providing useful tips and information.</p>
</li>
<li>
<p>Jessica Greer’s <a href="https://github.com/jlgreer/yale_cfengine3/">Yale University’s CFEngine 3 library</a> shows many real-world examples of bodies and bundles used to maintain Yale’s computers with CFEngine. This library is also available in the CFEngine Design Center.</p>
</li>
<li>
<p>Aleksey Tsalolikhin’s <a href="http://verticalsysadmin.com/blog/guide-to-cfengine-3-body-of-knowledge/">Guide to CFEngine 3 Body of Knowledge</a> is a great collection of links to a lot of the information available about CFEngine 3, including many of the resources already mentioned. Aleksey is a prolific CFEngine expert and trainer.</p>
</li>
<li>
<p>The <a href="https://cfengine.com/learn/">CFEngine Learning Center</a> page contains pointers to many of these documents, and many other resources that will help you understand and make better use of CFEngine.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="recommended-reading-order">Recommended Reading Order</h4>
<div class="paragraph">
<p>As a companion to this book, I would recommend reading and exploring the <a href="https://docs.cfengine.com/docs/3.10/reference-language-concepts.html">CFEngine Language Concepts page</a> from CFEngine AS, and to always have the <a href="https://docs.cfengine.com/docs/3.10/reference-all-types.html">CFEngine Reference pages</a> handy for the full details about the CFEngine policy language. All the examples in this book make heavy use of the standard library, and some of the more complex ones are extensions of the problems shown in the CFEngine solutions guide. I strongly recommend following and participating in the CFEngine forum, and contributing as you can to resources such as the CFEngine Design Center or through any other venue in which you are a regular participant (forum, mailing lists, etc.).</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. This is by necessity an incomplete list—it reflects only the major features implemented by major promise types in CFEngine. There are many other operations implemented by functions or by CFEngine’s monitoring components that allow both querying and modifying the system. Plus CFEngine is constantly evolving, so by the time you read this, new features may have appeared.
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. Normally each host is allowed only one connection at a time
</div>
</div>

  </div>
</div>


</body>
</html>
